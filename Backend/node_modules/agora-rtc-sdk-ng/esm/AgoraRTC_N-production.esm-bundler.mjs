/**
 * AgoraWebSDK_N-v4.20.0-0-g334e514b-dirty Copyright AgoraInc.
 */

import"webrtc-adapter";import{AgoraRTCEventReport as e,logger as t,report as i,AgoraRTCEvent as n,AgoraRTCEventUploadType as s,apiInvoke as o,isEventCustomReportParams as r}from"@agora-js/report";import{IS_GLOBAL_VERSION as a,MUTABLE_PARAMS as c,MUTABLE_PARAMS_LOCAL_CACHE as d,AgoraRTCError as l,AgoraRTCErrorCode as h,isValidString as u,isEmpty as p,checkValidNumber as _,checkValidBoolean as E,checkValidEnum as m,checkValidString as f,checkValidArray as S,EventEmitter as T,getParameter as g,createDefer as C,isMacOS as R,isFirefox as I,PromiseMutex as v,NETWORK_STATE as y,networkIndicator as A,NETWORK_INDICATOR_EVENTS as w,getRetryWaitTime as b,wait as N,emitAsPromise as O,emitAsInvokerNoResponse as P,Rolling as D,ConnectionDisconnectedReason as L,WebSocketQuitReason as k,getRandomString as M,emitAsInvoker as U,SHA256 as x,setBigUint64 as V,getBigUint64 as F,uint8ArrayToBase64 as j,base64ToUint8Array as B,withTimeout as G,nextTick as W,VERSION as H,setParameter as K,getUTF8StringByteLength as q,getMultiUnilbsFormDataByteLength as Y,AgoraAPIName as J,AgoraAPITag as X,retryable as z,getBrowserInfo as Q,DEFAULT_RETRY_CONFIG as Z,jsonClone as $,BrowserName as ee,BrowserOS as te,P2PTransportType as ie,isRTCIceServerList as ne,isChromeKernel as se,emitAsPromiseNoResponse as oe,getUniqueList as re,noop as ae,generateSessionID as ce,VideoCodec as de,isSafari as le,isIOS as he,isChromeBelow90 as ue,isBelowIOS14_6 as pe,isSupportedMobile as _e,ClientEvents as Ee,isWkWebview as me,isBelowIOS as fe,isBelowSafari as Se,isClientConfig as Te,removeItemFromList as ge,SDKStore as Ce,BUILD as Re,isClientRoleOptions as Ie,concurrent as ve,isHttpsEnv as ye,supportIsSecureContext as Ae,encryptRSA as we,isClientRole as be,isTurnServerConfig as Ne,isEncryptionMode as Oe,runOnce as Pe,isP2PTransport as De,isWebKit as Le,isSupportedWkWebview as ke,isWechatBrowser as Me,isQQBrowser as Ue,generateProcessID as xe}from"@agora-js/shared";export{AudienceLatencyLevelType,BUILD,ConnectionDisconnectedReason,VERSION,getParameter}from"@agora-js/shared";import Ve from"axios";import"formdata-polyfill";import{MixingAudioTrack as Fe,LocalAudioTrack as je,LocalVideoTrack as Be,TrackHint as Ge,getCompatibility as We,LocalTrack as He,audioTimerLoop as Ke,MediaElementNumStatus as qe,visibilityWatcher as Ye,audioElementPlayCenter as Je,MicrophoneAudioTrack as Xe,RemoteAudioTrack as ze,RemoteVideoTrack as Qe,TrackInternalEvent as Ze,RemoteTrackEvents as $e,TrackEvents as et,StreamType as tt,DEFAULT_LOCAL_AUDIO_TRACK_STATS as it,DEFAULT_LOCAL_VIDEO_TRACK_STATS as nt,DEFAULT_REMOTE_AUDIO_TRACK_STATS as st,DEFAULT_REMOTE_VIDEO_TRACK_STATS as ot,DEFAULT_NETWORK_QUALITY_STATS as rt,frameData2CryptoBuffer as at,LocalDataChannel as ct,isLowStreamParameter as dt,RemoteDataChannel as lt,autoPlayGestureEventEmitter as ht,deviceManager as ut,DeviceManagerEvent as pt,audioContextState as _t,AUDIO_CONTEXT_EVENT as Et,__TRACK_LIST__ as mt}from"@agora-js/media";export{RemoteStreamFallbackType,RemoteStreamType,__TRACK_LIST__,audioElementPlayCenter,createBufferSourceAudioTrack,createCameraVideoTrack,createCustomAudioTrack,createCustomVideoTrack,createMicrophoneAndCameraTracks,createMicrophoneAudioTrack,createScreenVideoTrack,getElectronScreenSources}from"@agora-js/media";var ft="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function St(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Tt=function(e){try{return!!e()}catch(e){return!0}},gt=!Tt((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),Ct=gt,Rt=Function.prototype,It=Rt.call,vt=Ct&&Rt.bind.bind(It,It),yt=Ct?vt:function(e){return function(){return It.apply(e,arguments)}},At=yt({}.isPrototypeOf),wt=function(e){return e&&e.Math==Math&&e},bt=wt("object"==typeof globalThis&&globalThis)||wt("object"==typeof window&&window)||wt("object"==typeof self&&self)||wt("object"==typeof ft&&ft)||function(){return this}()||ft||Function("return this")(),Nt=gt,Ot=Function.prototype,Pt=Ot.apply,Dt=Ot.call,Lt="object"==typeof Reflect&&Reflect.apply||(Nt?Dt.bind(Pt):function(){return Dt.apply(Pt,arguments)}),kt=yt,Mt=kt({}.toString),Ut=kt("".slice),xt=function(e){return Ut(Mt(e),8,-1)},Vt=xt,Ft=yt,jt=function(e){if("Function"===Vt(e))return Ft(e)},Bt="object"==typeof document&&document.all,Gt={all:Bt,IS_HTMLDDA:void 0===Bt&&void 0!==Bt},Wt=Gt.all,Ht=Gt.IS_HTMLDDA?function(e){return"function"==typeof e||e===Wt}:function(e){return"function"==typeof e},Kt={},qt=!Tt((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),Yt=gt,Jt=Function.prototype.call,Xt=Yt?Jt.bind(Jt):function(){return Jt.apply(Jt,arguments)},zt={},Qt={}.propertyIsEnumerable,Zt=Object.getOwnPropertyDescriptor,$t=Zt&&!Qt.call({1:2},1);zt.f=$t?function(e){var t=Zt(this,e);return!!t&&t.enumerable}:Qt;var ei,ti,ii=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},ni=Tt,si=xt,oi=Object,ri=yt("".split),ai=ni((function(){return!oi("z").propertyIsEnumerable(0)}))?function(e){return"String"==si(e)?ri(e,""):oi(e)}:oi,ci=function(e){return null==e},di=ci,li=TypeError,hi=function(e){if(di(e))throw li("Can't call method on "+e);return e},ui=ai,pi=hi,_i=function(e){return ui(pi(e))},Ei=Ht,mi=Gt.all,fi=Gt.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:Ei(e)||e===mi}:function(e){return"object"==typeof e?null!==e:Ei(e)},Si={},Ti=Si,gi=bt,Ci=Ht,Ri=function(e){return Ci(e)?e:void 0},Ii=function(e,t){return arguments.length<2?Ri(Ti[e])||Ri(gi[e]):Ti[e]&&Ti[e][t]||gi[e]&&gi[e][t]},vi="undefined"!=typeof navigator&&String(navigator.userAgent)||"",yi=bt,Ai=vi,wi=yi.process,bi=yi.Deno,Ni=wi&&wi.versions||bi&&bi.version,Oi=Ni&&Ni.v8;Oi&&(ti=(ei=Oi.split("."))[0]>0&&ei[0]<4?1:+(ei[0]+ei[1])),!ti&&Ai&&(!(ei=Ai.match(/Edge\/(\d+)/))||ei[1]>=74)&&(ei=Ai.match(/Chrome\/(\d+)/))&&(ti=+ei[1]);var Pi=ti,Di=Pi,Li=Tt,ki=bt.String,Mi=!!Object.getOwnPropertySymbols&&!Li((function(){var e=Symbol();return!ki(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Di&&Di<41})),Ui=Mi&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,xi=Ii,Vi=Ht,Fi=At,ji=Object,Bi=Ui?function(e){return"symbol"==typeof e}:function(e){var t=xi("Symbol");return Vi(t)&&Fi(t.prototype,ji(e))},Gi=String,Wi=function(e){try{return Gi(e)}catch(e){return"Object"}},Hi=Ht,Ki=Wi,qi=TypeError,Yi=function(e){if(Hi(e))return e;throw qi(Ki(e)+" is not a function")},Ji=Yi,Xi=ci,zi=function(e,t){var i=e[t];return Xi(i)?void 0:Ji(i)},Qi=Xt,Zi=Ht,$i=fi,en=TypeError,tn={exports:{}},nn=bt,sn=Object.defineProperty,on=function(e,t){try{sn(nn,e,{value:t,configurable:!0,writable:!0})}catch(i){nn[e]=t}return t},rn="__core-js_shared__",an=bt[rn]||on(rn,{}),cn=an;(tn.exports=function(e,t){return cn[e]||(cn[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var dn=tn.exports,ln=hi,hn=Object,un=function(e){return hn(ln(e))},pn=un,_n=yt({}.hasOwnProperty),En=Object.hasOwn||function(e,t){return _n(pn(e),t)},mn=yt,fn=0,Sn=Math.random(),Tn=mn(1..toString),gn=function(e){return"Symbol("+(void 0===e?"":e)+")_"+Tn(++fn+Sn,36)},Cn=dn,Rn=En,In=gn,vn=Mi,yn=Ui,An=bt.Symbol,wn=Cn("wks"),bn=yn?An.for||An:An&&An.withoutSetter||In,Nn=function(e){return Rn(wn,e)||(wn[e]=vn&&Rn(An,e)?An[e]:bn("Symbol."+e)),wn[e]},On=Xt,Pn=fi,Dn=Bi,Ln=zi,kn=function(e,t){var i,n;if("string"===t&&Zi(i=e.toString)&&!$i(n=Qi(i,e)))return n;if(Zi(i=e.valueOf)&&!$i(n=Qi(i,e)))return n;if("string"!==t&&Zi(i=e.toString)&&!$i(n=Qi(i,e)))return n;throw en("Can't convert object to primitive value")},Mn=TypeError,Un=Nn("toPrimitive"),xn=function(e,t){if(!Pn(e)||Dn(e))return e;var i,n=Ln(e,Un);if(n){if(void 0===t&&(t="default"),i=On(n,e,t),!Pn(i)||Dn(i))return i;throw Mn("Can't convert object to primitive value")}return void 0===t&&(t="number"),kn(e,t)},Vn=Bi,Fn=function(e){var t=xn(e,"string");return Vn(t)?t:t+""},jn=fi,Bn=bt.document,Gn=jn(Bn)&&jn(Bn.createElement),Wn=function(e){return Gn?Bn.createElement(e):{}},Hn=Wn,Kn=!qt&&!Tt((function(){return 7!=Object.defineProperty(Hn("div"),"a",{get:function(){return 7}}).a})),qn=qt,Yn=Xt,Jn=zt,Xn=ii,zn=_i,Qn=Fn,Zn=En,$n=Kn,es=Object.getOwnPropertyDescriptor;Kt.f=qn?es:function(e,t){if(e=zn(e),t=Qn(t),$n)try{return es(e,t)}catch(e){}if(Zn(e,t))return Xn(!Yn(Jn.f,e,t),e[t])};var ts=Tt,is=Ht,ns=/#|\.prototype\./,ss=function(e,t){var i=rs[os(e)];return i==cs||i!=as&&(is(t)?ts(t):!!t)},os=ss.normalize=function(e){return String(e).replace(ns,".").toLowerCase()},rs=ss.data={},as=ss.NATIVE="N",cs=ss.POLYFILL="P",ds=ss,ls=Yi,hs=gt,us=jt(jt.bind),ps=function(e,t){return ls(e),void 0===t?e:hs?us(e,t):function(){return e.apply(t,arguments)}},_s={},Es=qt&&Tt((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ms=fi,fs=String,Ss=TypeError,Ts=function(e){if(ms(e))return e;throw Ss(fs(e)+" is not an object")},gs=qt,Cs=Kn,Rs=Es,Is=Ts,vs=Fn,ys=TypeError,As=Object.defineProperty,ws=Object.getOwnPropertyDescriptor,bs="enumerable",Ns="configurable",Os="writable";_s.f=gs?Rs?function(e,t,i){if(Is(e),t=vs(t),Is(i),"function"==typeof e&&"prototype"===t&&"value"in i&&Os in i&&!i[Os]){var n=ws(e,t);n&&n[Os]&&(e[t]=i.value,i={configurable:Ns in i?i[Ns]:n[Ns],enumerable:bs in i?i[bs]:n[bs],writable:!1})}return As(e,t,i)}:As:function(e,t,i){if(Is(e),t=vs(t),Is(i),Cs)try{return As(e,t,i)}catch(e){}if("get"in i||"set"in i)throw ys("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var Ps=_s,Ds=ii,Ls=qt?function(e,t,i){return Ps.f(e,t,Ds(1,i))}:function(e,t,i){return e[t]=i,e},ks=bt,Ms=Lt,Us=jt,xs=Ht,Vs=Kt.f,Fs=ds,js=Si,Bs=ps,Gs=Ls,Ws=En,Hs=function(e){var t=function(i,n,s){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,n)}return new e(i,n,s)}return Ms(e,this,arguments)};return t.prototype=e.prototype,t},Ks=function(e,t){var i,n,s,o,r,a,c,d,l,h=e.target,u=e.global,p=e.stat,_=e.proto,E=u?ks:p?ks[h]:(ks[h]||{}).prototype,m=u?js:js[h]||Gs(js,h,{})[h],f=m.prototype;for(o in t)n=!(i=Fs(u?o:h+(p?".":"#")+o,e.forced))&&E&&Ws(E,o),a=m[o],n&&(c=e.dontCallGetSet?(l=Vs(E,o))&&l.value:E[o]),r=n&&c?c:t[o],n&&typeof a==typeof r||(d=e.bind&&n?Bs(r,ks):e.wrap&&n?Hs(r):_&&xs(r)?Us(r):r,(e.sham||r&&r.sham||a&&a.sham)&&Gs(d,"sham",!0),Gs(m,o,d),_&&(Ws(js,s=h+"Prototype")||Gs(js,s,{}),Gs(js[s],o,r),e.real&&f&&(i||!f[o])&&Gs(f,o,r)))},qs=Math.ceil,Ys=Math.floor,Js=Math.trunc||function(e){var t=+e;return(t>0?Ys:qs)(t)},Xs=function(e){var t=+e;return t!=t||0===t?0:Js(t)},zs=Xs,Qs=Math.max,Zs=Math.min,$s=function(e,t){var i=zs(e);return i<0?Qs(i+t,0):Zs(i,t)},eo=Xs,to=Math.min,io=function(e){return e>0?to(eo(e),9007199254740991):0},no=function(e){return io(e.length)},so=_i,oo=$s,ro=no,ao=function(e){return function(t,i,n){var s,o=so(t),r=ro(o),a=oo(n,r);if(e&&i!=i){for(;r>a;)if((s=o[a++])!=s)return!0}else for(;r>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return!e&&-1}},co={includes:ao(!0),indexOf:ao(!1)},lo=co.includes;Ks({target:"Array",proto:!0,forced:Tt((function(){return!Array(1).includes()}))},{includes:function(e){return lo(this,e,arguments.length>1?arguments[1]:void 0)}});var ho=Si,uo=function(e){return ho[e+"Prototype"]},po=uo("Array").includes,_o=fi,Eo=xt,mo=Nn("match"),fo=function(e){var t;return _o(e)&&(void 0!==(t=e[mo])?!!t:"RegExp"==Eo(e))},So=TypeError,To={};To[Nn("toStringTag")]="z";var go="[object z]"===String(To),Co=go,Ro=Ht,Io=xt,vo=Nn("toStringTag"),yo=Object,Ao="Arguments"==Io(function(){return arguments}()),wo=Co?Io:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=yo(e),vo))?i:Ao?Io(t):"Object"==(n=Io(t))&&Ro(t.callee)?"Arguments":n},bo=wo,No=String,Oo=function(e){if("Symbol"===bo(e))throw TypeError("Cannot convert a Symbol value to a string");return No(e)},Po=Nn("match"),Do=Ks,Lo=function(e){if(fo(e))throw So("The method doesn't accept regular expressions");return e},ko=hi,Mo=Oo,Uo=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[Po]=!1,"/./"[e](t)}catch(e){}}return!1},xo=yt("".indexOf);Do({target:"String",proto:!0,forced:!Uo("includes")},{includes:function(e){return!!~xo(Mo(ko(this)),Mo(Lo(e)),arguments.length>1?arguments[1]:void 0)}});var Vo=uo("String").includes,Fo=At,jo=po,Bo=Vo,Go=Array.prototype,Wo=String.prototype,Ho=St((function(e){var t=e.includes;return e===Go||Fo(Go,e)&&t===Go.includes?jo:"string"==typeof e||e===Wo||Fo(Wo,e)&&t===Wo.includes?Bo:t}));const Ko=!0,qo=!1,Yo=!1,Jo=!1,Xo=["CHINA","GLOBAL"],zo=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const o=s.join(""),r={};return r[e]=n,r[t]=o,Object.assign(r,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=zo,a||(c.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],c.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],c.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],c.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],c.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],c.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],c.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",c.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",c.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",c.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",c.AREAS=["NORTH_AMERICA","OVERSEA"]);const Qo=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Zo=[];function $o(e,t){return!!t&&Zo.some((i=>i.uid===e&&i.channelName===t))}e.__CLIENT_LIST__=Zo;var er={exports:{}},tr=Ks,ir=qt,nr=_s.f;tr({target:"Object",stat:!0,forced:Object.defineProperty!==nr,sham:!ir},{defineProperty:nr});var sr=Si.Object,or=er.exports=function(e,t,i){return sr.defineProperty(e,t,i)};sr.defineProperty.sham&&(or.sham=!0);var rr=St(er.exports),ar=xt,cr=Array.isArray||function(e){return"Array"==ar(e)},dr=TypeError,lr=Fn,hr=_s,ur=ii,pr=function(e,t,i){var n=lr(t);n in e?hr.f(e,n,ur(0,i)):e[n]=i},_r=Ht,Er=an,mr=yt(Function.toString);_r(Er.inspectSource)||(Er.inspectSource=function(e){return mr(e)});var fr=Er.inspectSource,Sr=yt,Tr=Tt,gr=Ht,Cr=wo,Rr=fr,Ir=function(){},vr=[],yr=Ii("Reflect","construct"),Ar=/^\s*(?:class|function)\b/,wr=Sr(Ar.exec),br=!Ar.exec(Ir),Nr=function(e){if(!gr(e))return!1;try{return yr(Ir,vr,e),!0}catch(e){return!1}},Or=function(e){if(!gr(e))return!1;switch(Cr(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return br||!!wr(Ar,Rr(e))}catch(e){return!0}};Or.sham=!0;var Pr=!yr||Tr((function(){var e;return Nr(Nr.call)||!Nr(Object)||!Nr((function(){e=!0}))||e}))?Or:Nr,Dr=cr,Lr=Pr,kr=fi,Mr=Nn("species"),Ur=Array,xr=function(e){var t;return Dr(e)&&(t=e.constructor,(Lr(t)&&(t===Ur||Dr(t.prototype))||kr(t)&&null===(t=t[Mr]))&&(t=void 0)),void 0===t?Ur:t},Vr=function(e,t){return new(xr(e))(0===t?0:t)},Fr=Tt,jr=Pi,Br=Nn("species"),Gr=Ks,Wr=Tt,Hr=cr,Kr=fi,qr=un,Yr=no,Jr=function(e){if(e>9007199254740991)throw dr("Maximum allowed index exceeded");return e},Xr=pr,zr=Vr,Qr=function(e){return jr>=51||!Fr((function(){var t=[];return(t.constructor={})[Br]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Zr=Pi,$r=Nn("isConcatSpreadable"),ea=Zr>=51||!Wr((function(){var e=[];return e[$r]=!1,e.concat()[0]!==e})),ta=function(e){if(!Kr(e))return!1;var t=e[$r];return void 0!==t?!!t:Hr(e)};Gr({target:"Array",proto:!0,arity:1,forced:!ea||!Qr("concat")},{concat:function(e){var t,i,n,s,o,r=qr(this),a=zr(r,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(ta(o=-1===t?r:arguments[t]))for(s=Yr(o),Jr(c+s),i=0;i<s;i++,c++)i in o&&Xr(a,c,o[i]);else Jr(c+1),Xr(a,c++,o);return a.length=c,a}});var ia={},na={},sa=En,oa=_i,ra=co.indexOf,aa=na,ca=yt([].push),da=function(e,t){var i,n=oa(e),s=0,o=[];for(i in n)!sa(aa,i)&&sa(n,i)&&ca(o,i);for(;t.length>s;)sa(n,i=t[s++])&&(~ra(o,i)||ca(o,i));return o},la=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],ha=da,ua=la,pa=Object.keys||function(e){return ha(e,ua)},_a=qt,Ea=Es,ma=_s,fa=Ts,Sa=_i,Ta=pa;ia.f=_a&&!Ea?Object.defineProperties:function(e,t){fa(e);for(var i,n=Sa(t),s=Ta(t),o=s.length,r=0;o>r;)ma.f(e,i=s[r++],n[i]);return e};var ga,Ca=Ii("document","documentElement"),Ra=gn,Ia=dn("keys"),va=function(e){return Ia[e]||(Ia[e]=Ra(e))},ya=Ts,Aa=ia,wa=la,ba=na,Na=Ca,Oa=Wn,Pa="prototype",Da="script",La=va("IE_PROTO"),ka=function(){},Ma=function(e){return"<"+Da+">"+e+"</"+Da+">"},Ua=function(e){e.write(Ma("")),e.close();var t=e.parentWindow.Object;return e=null,t},xa=function(){try{ga=new ActiveXObject("htmlfile")}catch(e){}var e,t,i;xa="undefined"!=typeof document?document.domain&&ga?Ua(ga):(t=Oa("iframe"),i="java"+Da+":",t.style.display="none",Na.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(Ma("document.F=Object")),e.close(),e.F):Ua(ga);for(var n=wa.length;n--;)delete xa[Pa][wa[n]];return xa()};ba[La]=!0;var Va=Object.create||function(e,t){var i;return null!==e?(ka[Pa]=ya(e),i=new ka,ka[Pa]=null,i[La]=e):i=xa(),void 0===t?i:Aa.f(i,t)},Fa={},ja=da,Ba=la.concat("length","prototype");Fa.f=Object.getOwnPropertyNames||function(e){return ja(e,Ba)};var Ga={},Wa=$s,Ha=no,Ka=pr,qa=Array,Ya=Math.max,Ja=function(e,t,i){for(var n=Ha(e),s=Wa(t,n),o=Wa(void 0===i?n:i,n),r=qa(Ya(o-s,0)),a=0;s<o;s++,a++)Ka(r,a,e[s]);return r.length=a,r},Xa=xt,za=_i,Qa=Fa.f,Za=Ja,$a="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Ga.f=function(e){return $a&&"Window"==Xa(e)?function(e){try{return Qa(e)}catch(e){return Za($a)}}(e):Qa(za(e))};var ec={};ec.f=Object.getOwnPropertySymbols;var tc=Ls,ic=function(e,t,i,n){return n&&n.enumerable?e[t]=i:tc(e,t,i),e},nc=_s,sc=function(e,t,i){return nc.f(e,t,i)},oc={},rc=Nn;oc.f=rc;var ac,cc,dc,lc=Si,hc=En,uc=oc,pc=_s.f,_c=function(e){var t=lc.Symbol||(lc.Symbol={});hc(t,e)||pc(t,e,{value:uc.f(e)})},Ec=Xt,mc=Ii,fc=Nn,Sc=ic,Tc=function(){var e=mc("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,n=fc("toPrimitive");t&&!t[n]&&Sc(t,n,(function(e){return Ec(i,this)}),{arity:1})},gc=wo,Cc=go?{}.toString:function(){return"[object "+gc(this)+"]"},Rc=go,Ic=_s.f,vc=Ls,yc=En,Ac=Cc,wc=Nn("toStringTag"),bc=function(e,t,i,n){if(e){var s=i?e:e.prototype;yc(s,wc)||Ic(s,wc,{configurable:!0,value:t}),n&&!Rc&&vc(s,"toString",Ac)}},Nc=Ht,Oc=bt.WeakMap,Pc=Nc(Oc)&&/native code/.test(String(Oc)),Dc=bt,Lc=fi,kc=Ls,Mc=En,Uc=an,xc=va,Vc=na,Fc="Object already initialized",jc=Dc.TypeError,Bc=Dc.WeakMap;if(Pc||Uc.state){var Gc=Uc.state||(Uc.state=new Bc);Gc.get=Gc.get,Gc.has=Gc.has,Gc.set=Gc.set,ac=function(e,t){if(Gc.has(e))throw jc(Fc);return t.facade=e,Gc.set(e,t),t},cc=function(e){return Gc.get(e)||{}},dc=function(e){return Gc.has(e)}}else{var Wc=xc("state");Vc[Wc]=!0,ac=function(e,t){if(Mc(e,Wc))throw jc(Fc);return t.facade=e,kc(e,Wc,t),t},cc=function(e){return Mc(e,Wc)?e[Wc]:{}},dc=function(e){return Mc(e,Wc)}}var Hc={set:ac,get:cc,has:dc,enforce:function(e){return dc(e)?cc(e):ac(e,{})},getterFor:function(e){return function(t){var i;if(!Lc(t)||(i=cc(t)).type!==e)throw jc("Incompatible receiver, "+e+" required");return i}}},Kc=ps,qc=ai,Yc=un,Jc=no,Xc=Vr,zc=yt([].push),Qc=function(e){var t=1==e,i=2==e,n=3==e,s=4==e,o=6==e,r=7==e,a=5==e||o;return function(c,d,l,h){for(var u,p,_=Yc(c),E=qc(_),m=Kc(d,l),f=Jc(E),S=0,T=h||Xc,g=t?T(c,f):i||r?T(c,0):void 0;f>S;S++)if((a||S in E)&&(p=m(u=E[S],S,_),e))if(t)g[S]=p;else if(p)switch(e){case 3:return!0;case 5:return u;case 6:return S;case 2:zc(g,u)}else switch(e){case 4:return!1;case 7:zc(g,u)}return o?-1:n||s?s:g}},Zc={forEach:Qc(0),map:Qc(1),filter:Qc(2),some:Qc(3),every:Qc(4),find:Qc(5),findIndex:Qc(6),filterReject:Qc(7)},$c=Ks,ed=bt,td=Xt,id=yt,nd=qt,sd=Mi,od=Tt,rd=En,ad=At,cd=Ts,dd=_i,ld=Fn,hd=Oo,ud=ii,pd=Va,_d=pa,Ed=Fa,md=Ga,fd=ec,Sd=Kt,Td=_s,gd=ia,Cd=zt,Rd=ic,Id=sc,vd=dn,yd=na,Ad=gn,wd=Nn,bd=oc,Nd=_c,Od=Tc,Pd=bc,Dd=Hc,Ld=Zc.forEach,kd=va("hidden"),Md="Symbol",Ud="prototype",xd=Dd.set,Vd=Dd.getterFor(Md),Fd=Object[Ud],jd=ed.Symbol,Bd=jd&&jd[Ud],Gd=ed.TypeError,Wd=ed.QObject,Hd=Sd.f,Kd=Td.f,qd=md.f,Yd=Cd.f,Jd=id([].push),Xd=vd("symbols"),zd=vd("op-symbols"),Qd=vd("wks"),Zd=!Wd||!Wd[Ud]||!Wd[Ud].findChild,$d=nd&&od((function(){return 7!=pd(Kd({},"a",{get:function(){return Kd(this,"a",{value:7}).a}})).a}))?function(e,t,i){var n=Hd(Fd,t);n&&delete Fd[t],Kd(e,t,i),n&&e!==Fd&&Kd(Fd,t,n)}:Kd,el=function(e,t){var i=Xd[e]=pd(Bd);return xd(i,{type:Md,tag:e,description:t}),nd||(i.description=t),i},tl=function(e,t,i){e===Fd&&tl(zd,t,i),cd(e);var n=ld(t);return cd(i),rd(Xd,n)?(i.enumerable?(rd(e,kd)&&e[kd][n]&&(e[kd][n]=!1),i=pd(i,{enumerable:ud(0,!1)})):(rd(e,kd)||Kd(e,kd,ud(1,{})),e[kd][n]=!0),$d(e,n,i)):Kd(e,n,i)},il=function(e,t){cd(e);var i=dd(t),n=_d(i).concat(rl(i));return Ld(n,(function(t){nd&&!td(nl,i,t)||tl(e,t,i[t])})),e},nl=function(e){var t=ld(e),i=td(Yd,this,t);return!(this===Fd&&rd(Xd,t)&&!rd(zd,t))&&(!(i||!rd(this,t)||!rd(Xd,t)||rd(this,kd)&&this[kd][t])||i)},sl=function(e,t){var i=dd(e),n=ld(t);if(i!==Fd||!rd(Xd,n)||rd(zd,n)){var s=Hd(i,n);return!s||!rd(Xd,n)||rd(i,kd)&&i[kd][n]||(s.enumerable=!0),s}},ol=function(e){var t=qd(dd(e)),i=[];return Ld(t,(function(e){rd(Xd,e)||rd(yd,e)||Jd(i,e)})),i},rl=function(e){var t=e===Fd,i=qd(t?zd:dd(e)),n=[];return Ld(i,(function(e){!rd(Xd,e)||t&&!rd(Fd,e)||Jd(n,Xd[e])})),n};sd||(Rd(Bd=(jd=function(){if(ad(Bd,this))throw Gd("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?hd(arguments[0]):void 0,t=Ad(e),i=function(e){this===Fd&&td(i,zd,e),rd(this,kd)&&rd(this[kd],t)&&(this[kd][t]=!1),$d(this,t,ud(1,e))};return nd&&Zd&&$d(Fd,t,{configurable:!0,set:i}),el(t,e)})[Ud],"toString",(function(){return Vd(this).tag})),Rd(jd,"withoutSetter",(function(e){return el(Ad(e),e)})),Cd.f=nl,Td.f=tl,gd.f=il,Sd.f=sl,Ed.f=md.f=ol,fd.f=rl,bd.f=function(e){return el(wd(e),e)},nd&&Id(Bd,"description",{configurable:!0,get:function(){return Vd(this).description}})),$c({global:!0,constructor:!0,wrap:!0,forced:!sd,sham:!sd},{Symbol:jd}),Ld(_d(Qd),(function(e){Nd(e)})),$c({target:Md,stat:!0,forced:!sd},{useSetter:function(){Zd=!0},useSimple:function(){Zd=!1}}),$c({target:"Object",stat:!0,forced:!sd,sham:!nd},{create:function(e,t){return void 0===t?pd(e):il(pd(e),t)},defineProperty:tl,defineProperties:il,getOwnPropertyDescriptor:sl}),$c({target:"Object",stat:!0,forced:!sd},{getOwnPropertyNames:ol}),Od(),Pd(jd,Md),yd[kd]=!0;var al=Mi&&!!Symbol.for&&!!Symbol.keyFor,cl=Ks,dl=Ii,ll=En,hl=Oo,ul=dn,pl=al,_l=ul("string-to-symbol-registry"),El=ul("symbol-to-string-registry");cl({target:"Symbol",stat:!0,forced:!pl},{for:function(e){var t=hl(e);if(ll(_l,t))return _l[t];var i=dl("Symbol")(t);return _l[t]=i,El[i]=t,i}});var ml=Ks,fl=En,Sl=Bi,Tl=Wi,gl=al,Cl=dn("symbol-to-string-registry");ml({target:"Symbol",stat:!0,forced:!gl},{keyFor:function(e){if(!Sl(e))throw TypeError(Tl(e)+" is not a symbol");if(fl(Cl,e))return Cl[e]}});var Rl=yt([].slice),Il=cr,vl=Ht,yl=xt,Al=Oo,wl=yt([].push),bl=Ks,Nl=Ii,Ol=Lt,Pl=Xt,Dl=yt,Ll=Tt,kl=Ht,Ml=Bi,Ul=Rl,xl=function(e){if(vl(e))return e;if(Il(e)){for(var t=e.length,i=[],n=0;n<t;n++){var s=e[n];"string"==typeof s?wl(i,s):"number"!=typeof s&&"Number"!=yl(s)&&"String"!=yl(s)||wl(i,Al(s))}var o=i.length,r=!0;return function(e,t){if(r)return r=!1,t;if(Il(this))return t;for(var n=0;n<o;n++)if(i[n]===e)return t}}},Vl=Mi,Fl=String,jl=Nl("JSON","stringify"),Bl=Dl(/./.exec),Gl=Dl("".charAt),Wl=Dl("".charCodeAt),Hl=Dl("".replace),Kl=Dl(1..toString),ql=/[\uD800-\uDFFF]/g,Yl=/^[\uD800-\uDBFF]$/,Jl=/^[\uDC00-\uDFFF]$/,Xl=!Vl||Ll((function(){var e=Nl("Symbol")();return"[null]"!=jl([e])||"{}"!=jl({a:e})||"{}"!=jl(Object(e))})),zl=Ll((function(){return'"\\udf06\\ud834"'!==jl("\udf06\ud834")||'"\\udead"'!==jl("\udead")})),Ql=function(e,t){var i=Ul(arguments),n=xl(t);if(kl(n)||void 0!==e&&!Ml(e))return i[1]=function(e,t){if(kl(n)&&(t=Pl(n,this,Fl(e),t)),!Ml(t))return t},Ol(jl,null,i)},Zl=function(e,t,i){var n=Gl(i,t-1),s=Gl(i,t+1);return Bl(Yl,e)&&!Bl(Jl,s)||Bl(Jl,e)&&!Bl(Yl,n)?"\\u"+Kl(Wl(e,0),16):e};jl&&bl({target:"JSON",stat:!0,arity:3,forced:Xl||zl},{stringify:function(e,t,i){var n=Ul(arguments),s=Ol(Xl?Ql:jl,null,n);return zl&&"string"==typeof s?Hl(s,ql,Zl):s}});var $l=ec,eh=un;Ks({target:"Object",stat:!0,forced:!Mi||Tt((function(){$l.f(1)}))},{getOwnPropertySymbols:function(e){var t=$l.f;return t?t(eh(e)):[]}}),_c("asyncIterator"),_c("hasInstance"),_c("isConcatSpreadable"),_c("iterator"),_c("match"),_c("matchAll"),_c("replace"),_c("search"),_c("species"),_c("split");var th=Tc;_c("toPrimitive"),th();var ih=Ii,nh=bc;_c("toStringTag"),nh(ih("Symbol"),"Symbol"),_c("unscopables"),bc(bt.JSON,"JSON",!0);var sh,oh,rh,ah=Si.Symbol,ch={},dh=qt,lh=En,hh=Function.prototype,uh=dh&&Object.getOwnPropertyDescriptor,ph=lh(hh,"name"),_h={EXISTS:ph,PROPER:ph&&"something"===function(){}.name,CONFIGURABLE:ph&&(!dh||dh&&uh(hh,"name").configurable)},Eh=!Tt((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),mh=En,fh=Ht,Sh=un,Th=Eh,gh=va("IE_PROTO"),Ch=Object,Rh=Ch.prototype,Ih=Th?Ch.getPrototypeOf:function(e){var t=Sh(e);if(mh(t,gh))return t[gh];var i=t.constructor;return fh(i)&&t instanceof i?i.prototype:t instanceof Ch?Rh:null},vh=Tt,yh=Ht,Ah=fi,wh=Va,bh=Ih,Nh=ic,Oh=Nn("iterator"),Ph=!1;[].keys&&("next"in(rh=[].keys())?(oh=bh(bh(rh)))!==Object.prototype&&(sh=oh):Ph=!0);var Dh=!Ah(sh)||vh((function(){var e={};return sh[Oh].call(e)!==e}));yh((sh=Dh?{}:wh(sh))[Oh])||Nh(sh,Oh,(function(){return this}));var Lh={IteratorPrototype:sh,BUGGY_SAFARI_ITERATORS:Ph},kh=Lh.IteratorPrototype,Mh=Va,Uh=ii,xh=bc,Vh=ch,Fh=function(){return this},jh=yt,Bh=Yi,Gh=Ht,Wh=String,Hh=TypeError,Kh=function(e,t,i){try{return jh(Bh(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(e){}},qh=Ts,Yh=function(e){if("object"==typeof e||Gh(e))return e;throw Hh("Can't set "+Wh(e)+" as a prototype")},Jh=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Kh(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return qh(i),Yh(n),t?e(i,n):i.__proto__=n,i}}():void 0),Xh=Ks,zh=Xt,Qh=_h,Zh=function(e,t,i,n){var s=t+" Iterator";return e.prototype=Mh(kh,{next:Uh(+!n,i)}),xh(e,s,!1,!0),Vh[s]=Fh,e},$h=Ih,eu=bc,tu=ic,iu=ch,nu=Lh,su=Qh.PROPER,ou=nu.BUGGY_SAFARI_ITERATORS,ru=Nn("iterator"),au="keys",cu="values",du="entries",lu=function(){return this},hu=function(e,t,i,n,s,o,r){Zh(i,t,n);var a,c,d,l=function(e){if(e===s&&E)return E;if(!ou&&e in p)return p[e];switch(e){case au:case cu:case du:return function(){return new i(this,e)}}return function(){return new i(this)}},h=t+" Iterator",u=!1,p=e.prototype,_=p[ru]||p["@@iterator"]||s&&p[s],E=!ou&&_||l(s),m="Array"==t&&p.entries||_;if(m&&(a=$h(m.call(new e)))!==Object.prototype&&a.next&&(eu(a,h,!0,!0),iu[h]=lu),su&&s==cu&&_&&_.name!==cu&&(u=!0,E=function(){return zh(_,this)}),s)if(c={values:l(cu),keys:o?E:l(au),entries:l(du)},r)for(d in c)(ou||u||!(d in p))&&tu(p,d,c[d]);else Xh({target:t,proto:!0,forced:ou||u},c);return r&&p[ru]!==E&&tu(p,ru,E,{name:s}),iu[t]=E,c},uu=function(e,t){return{value:e,done:t}},pu=_i,_u=ch,Eu=Hc;_s.f;var mu=hu,fu=uu,Su="Array Iterator",Tu=Eu.set,gu=Eu.getterFor(Su);mu(Array,"Array",(function(e,t){Tu(this,{type:Su,target:pu(e),index:0,kind:t})}),(function(){var e=gu(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,fu(void 0,!0)):fu("keys"==i?n:"values"==i?t[n]:[n,t[n]],!1)}),"values"),_u.Arguments=_u.Array;var Cu={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Ru=bt,Iu=wo,vu=Ls,yu=ch,Au=Nn("toStringTag");for(var wu in Cu){var bu=Ru[wu],Nu=bu&&bu.prototype;Nu&&Iu(Nu)!==Au&&vu(Nu,Au,wu),yu[wu]=yu.Array}var Ou=ah,Pu=Nn,Du=_s.f,Lu=Pu("metadata"),ku=Function.prototype;void 0===ku[Lu]&&Du(ku,Lu,{value:null}),_c("dispose"),_c("metadata");var Mu=Ou;_c("asyncDispose");var Uu=yt,xu=Ii("Symbol"),Vu=xu.keyFor,Fu=Uu(xu.prototype.valueOf),ju=xu.isRegisteredSymbol||function(e){try{return void 0!==Vu(Fu(e))}catch(e){return!1}};Ks({target:"Symbol",stat:!0},{isRegisteredSymbol:ju});for(var Bu=dn,Gu=Ii,Wu=yt,Hu=Bi,Ku=Nn,qu=Gu("Symbol"),Yu=qu.isWellKnownSymbol,Ju=Gu("Object","getOwnPropertyNames"),Xu=Wu(qu.prototype.valueOf),zu=Bu("wks"),Qu=0,Zu=Ju(qu),$u=Zu.length;Qu<$u;Qu++)try{var ep=Zu[Qu];Hu(qu[ep])&&Ku(ep)}catch(e){}var tp=function(e){if(Yu&&Yu(e))return!0;try{for(var t=Xu(e),i=0,n=Ju(zu),s=n.length;i<s;i++)if(zu[n[i]]==t)return!0}catch(e){}return!1};Ks({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:tp}),_c("matcher"),_c("observable"),Ks({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:ju}),Ks({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:tp}),_c("metadataKey"),_c("patternMatch"),_c("replaceAll");var ip=St(Mu),np=yt,sp=Xs,op=Oo,rp=hi,ap=np("".charAt),cp=np("".charCodeAt),dp=np("".slice),lp=function(e){return function(t,i){var n,s,o=op(rp(t)),r=sp(i),a=o.length;return r<0||r>=a?e?"":void 0:(n=cp(o,r))<55296||n>56319||r+1===a||(s=cp(o,r+1))<56320||s>57343?e?ap(o,r):n:e?dp(o,r,r+2):s-56320+(n-55296<<10)+65536}},hp={codeAt:lp(!1),charAt:lp(!0)}.charAt,up=Oo,pp=Hc,_p=hu,Ep=uu,mp="String Iterator",fp=pp.set,Sp=pp.getterFor(mp);_p(String,"String",(function(e){fp(this,{type:mp,string:up(e),index:0})}),(function(){var e,t=Sp(this),i=t.string,n=t.index;return n>=i.length?Ep(void 0,!0):(e=hp(i,n),t.index+=e.length,Ep(e,!1))}));var Tp=St(oc.f("iterator"));function gp(e){return gp="function"==typeof ip&&"symbol"==typeof Tp?function(e){return typeof e}:function(e){return e&&"function"==typeof ip&&e.constructor===ip&&e!==ip.prototype?"symbol":typeof e},gp(e)}var Cp=St(oc.f("toPrimitive"));function Rp(e){var t=function(e,t){if("object"!==gp(e)||null===e)return e;var i=e[Cp];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==gp(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===gp(t)?t:String(t)}function Ip(e,t,i){return(t=Rp(t))in e?rr(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var vp=Ii,yp=Fa,Ap=ec,wp=Ts,bp=yt([].concat),Np=vp("Reflect","ownKeys")||function(e){var t=yp.f(wp(e)),i=Ap.f;return i?bp(t,i(e)):t},Op=En,Pp=Np,Dp=Kt,Lp=_s,kp=fi,Mp=Ls,Up=Error,xp=yt("".replace),Vp=String(Up("zxcasd").stack),Fp=/\n\s*at [^:]*:[^\n]*/,jp=Fp.test(Vp),Bp=ii,Gp=!Tt((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",Bp(1,7)),7!==e.stack)})),Wp=Ls,Hp=function(e,t){if(jp&&"string"==typeof e&&!Up.prepareStackTrace)for(;t--;)e=xp(e,Fp,"");return e},Kp=Gp,qp=Error.captureStackTrace,Yp=ch,Jp=Nn("iterator"),Xp=Array.prototype,zp=wo,Qp=zi,Zp=ci,$p=ch,e_=Nn("iterator"),t_=function(e){if(!Zp(e))return Qp(e,e_)||Qp(e,"@@iterator")||$p[zp(e)]},i_=Xt,n_=Yi,s_=Ts,o_=Wi,r_=t_,a_=TypeError,c_=Xt,d_=Ts,l_=zi,h_=ps,u_=Xt,p_=Ts,__=Wi,E_=function(e){return void 0!==e&&(Yp.Array===e||Xp[Jp]===e)},m_=no,f_=At,S_=function(e,t){var i=arguments.length<2?r_(e):t;if(n_(i))return s_(i_(i,e));throw a_(o_(e)+" is not iterable")},T_=t_,g_=function(e,t,i){var n,s;d_(e);try{if(!(n=l_(e,"return"))){if("throw"===t)throw i;return i}n=c_(n,e)}catch(e){s=!0,n=e}if("throw"===t)throw i;if(s)throw n;return d_(n),i},C_=TypeError,R_=function(e,t){this.stopped=e,this.result=t},I_=R_.prototype,v_=function(e,t,i){var n,s,o,r,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),_=!(!i||!i.INTERRUPTED),E=h_(t,l),m=function(e){return n&&g_(n,"normal",e),new R_(!0,e)},f=function(e){return h?(p_(e),_?E(e[0],e[1],m):E(e[0],e[1])):_?E(e,m):E(e)};if(u)n=e.iterator;else if(p)n=e;else{if(!(s=T_(e)))throw C_(__(e)+" is not iterable");if(E_(s)){for(o=0,r=m_(e);r>o;o++)if((a=f(e[o]))&&f_(I_,a))return a;return new R_(!1)}n=S_(e,s)}for(c=u?e.next:n.next;!(d=u_(c,n)).done;){try{a=f(d.value)}catch(e){g_(n,"throw",e)}if("object"==typeof a&&a&&f_(I_,a))return a}return new R_(!1)},y_=Oo,A_=Ks,w_=At,b_=Ih,N_=Jh,O_=function(e,t,i){for(var n=Pp(t),s=Lp.f,o=Dp.f,r=0;r<n.length;r++){var a=n[r];Op(e,a)||i&&Op(i,a)||s(e,a,o(t,a))}},P_=Va,D_=Ls,L_=ii,k_=function(e,t){kp(t)&&"cause"in t&&Mp(e,"cause",t.cause)},M_=function(e,t,i,n){Kp&&(qp?qp(e,t):Wp(e,"stack",Hp(i,n)))},U_=v_,x_=function(e,t){return void 0===e?arguments.length<2?"":t:y_(e)},V_=Nn("toStringTag"),F_=Error,j_=[].push,B_=function(e,t){var i,n=w_(G_,this);N_?i=N_(F_(),n?b_(this):G_):(i=n?this:P_(G_),D_(i,V_,"Error")),void 0!==t&&D_(i,"message",x_(t)),M_(i,B_,i.stack,1),arguments.length>2&&k_(i,arguments[2]);var s=[];return U_(e,j_,{that:s}),D_(i,"errors",s),i};N_?N_(B_,F_):O_(B_,F_,{name:!0});var G_=B_.prototype=P_(F_.prototype,{constructor:L_(1,B_),message:L_(1,""),name:L_(1,"AggregateError")});A_({global:!0,constructor:!0,arity:2},{AggregateError:B_});var W_,H_,K_,q_,Y_="undefined"!=typeof process&&"process"==xt(process),J_=Ii,X_=sc,z_=qt,Q_=Nn("species"),Z_=At,$_=TypeError,eE=Pr,tE=Wi,iE=TypeError,nE=Ts,sE=function(e){if(eE(e))return e;throw iE(tE(e)+" is not a constructor")},oE=ci,rE=Nn("species"),aE=function(e,t){var i,n=nE(e).constructor;return void 0===n||oE(i=nE(n)[rE])?t:sE(i)},cE=TypeError,dE=/(?:ipad|iphone|ipod).*applewebkit/i.test(vi),lE=bt,hE=Lt,uE=ps,pE=Ht,_E=En,EE=Tt,mE=Ca,fE=Rl,SE=Wn,TE=function(e,t){if(e<t)throw cE("Not enough arguments");return e},gE=dE,CE=Y_,RE=lE.setImmediate,IE=lE.clearImmediate,vE=lE.process,yE=lE.Dispatch,AE=lE.Function,wE=lE.MessageChannel,bE=lE.String,NE=0,OE={},PE="onreadystatechange";EE((function(){W_=lE.location}));var DE=function(e){if(_E(OE,e)){var t=OE[e];delete OE[e],t()}},LE=function(e){return function(){DE(e)}},kE=function(e){DE(e.data)},ME=function(e){lE.postMessage(bE(e),W_.protocol+"//"+W_.host)};RE&&IE||(RE=function(e){TE(arguments.length,1);var t=pE(e)?e:AE(e),i=fE(arguments,1);return OE[++NE]=function(){hE(t,void 0,i)},H_(NE),NE},IE=function(e){delete OE[e]},CE?H_=function(e){vE.nextTick(LE(e))}:yE&&yE.now?H_=function(e){yE.now(LE(e))}:wE&&!gE?(q_=(K_=new wE).port2,K_.port1.onmessage=kE,H_=uE(q_.postMessage,q_)):lE.addEventListener&&pE(lE.postMessage)&&!lE.importScripts&&W_&&"file:"!==W_.protocol&&!EE(ME)?(H_=ME,lE.addEventListener("message",kE,!1)):H_=PE in SE("script")?function(e){mE.appendChild(SE("script"))[PE]=function(){mE.removeChild(this),DE(e)}}:function(e){setTimeout(LE(e),0)});var UE={set:RE,clear:IE},xE=function(){this.head=null,this.tail=null};xE.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var VE,FE,jE,BE,GE,WE=xE,HE=/ipad|iphone|ipod/i.test(vi)&&"undefined"!=typeof Pebble,KE=/web0s(?!.*chrome)/i.test(vi),qE=bt,YE=ps,JE=Kt.f,XE=UE.set,zE=WE,QE=dE,ZE=HE,$E=KE,em=Y_,tm=qE.MutationObserver||qE.WebKitMutationObserver,im=qE.document,nm=qE.process,sm=qE.Promise,om=JE(qE,"queueMicrotask"),rm=om&&om.value;if(!rm){var am=new zE,cm=function(){var e,t;for(em&&(e=nm.domain)&&e.exit();t=am.get();)try{t()}catch(e){throw am.head&&VE(),e}e&&e.enter()};QE||em||$E||!tm||!im?!ZE&&sm&&sm.resolve?((BE=sm.resolve(void 0)).constructor=sm,GE=YE(BE.then,BE),VE=function(){GE(cm)}):em?VE=function(){nm.nextTick(cm)}:(XE=YE(XE,qE),VE=function(){XE(cm)}):(FE=!0,jE=im.createTextNode(""),new tm(cm).observe(jE,{characterData:!0}),VE=function(){jE.data=FE=!FE}),rm=function(e){am.head||VE(),am.add(e)}}var dm=rm,lm=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},hm=bt.Promise,um="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,pm=!um&&!Y_&&"object"==typeof window&&"object"==typeof document,_m=bt,Em=hm,mm=Ht,fm=ds,Sm=fr,Tm=Nn,gm=pm,Cm=um,Rm=Pi,Im=Em&&Em.prototype,vm=Tm("species"),ym=!1,Am=mm(_m.PromiseRejectionEvent),wm=fm("Promise",(function(){var e=Sm(Em),t=e!==String(Em);if(!t&&66===Rm)return!0;if(!Im.catch||!Im.finally)return!0;if(!Rm||Rm<51||!/native code/.test(e)){var i=new Em((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};if((i.constructor={})[vm]=n,!(ym=i.then((function(){}))instanceof n))return!0}return!t&&(gm||Cm)&&!Am})),bm={CONSTRUCTOR:wm,REJECTION_EVENT:Am,SUBCLASSING:ym},Nm={},Om=Yi,Pm=TypeError,Dm=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw Pm("Bad Promise constructor");t=e,i=n})),this.resolve=Om(t),this.reject=Om(i)};Nm.f=function(e){return new Dm(e)};var Lm,km,Mm=Ks,Um=Y_,xm=bt,Vm=Xt,Fm=ic,jm=bc,Bm=function(e){var t=J_(e);z_&&t&&!t[Q_]&&X_(t,Q_,{configurable:!0,get:function(){return this}})},Gm=Yi,Wm=Ht,Hm=fi,Km=function(e,t){if(Z_(t,e))return e;throw $_("Incorrect invocation")},qm=aE,Ym=UE.set,Jm=dm,Xm=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},zm=lm,Qm=WE,Zm=Hc,$m=hm,ef=bm,tf=Nm,nf="Promise",sf=ef.CONSTRUCTOR,of=ef.REJECTION_EVENT,rf=Zm.getterFor(nf),af=Zm.set,cf=$m&&$m.prototype,df=$m,lf=cf,hf=xm.TypeError,uf=xm.document,pf=xm.process,_f=tf.f,Ef=_f,mf=!!(uf&&uf.createEvent&&xm.dispatchEvent),ff="unhandledrejection",Sf=function(e){var t;return!(!Hm(e)||!Wm(t=e.then))&&t},Tf=function(e,t){var i,n,s,o=t.value,r=1==t.state,a=r?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(r||(2===t.rejection&&vf(t),t.rejection=1),!0===a?i=o:(l&&l.enter(),i=a(o),l&&(l.exit(),s=!0)),i===e.promise?d(hf("Promise-chain cycle")):(n=Sf(i))?Vm(n,i,c,d):c(i)):d(o)}catch(e){l&&!s&&l.exit(),d(e)}},gf=function(e,t){e.notified||(e.notified=!0,Jm((function(){for(var i,n=e.reactions;i=n.get();)Tf(i,e);e.notified=!1,t&&!e.rejection&&Rf(e)})))},Cf=function(e,t,i){var n,s;mf?((n=uf.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),xm.dispatchEvent(n)):n={promise:t,reason:i},!of&&(s=xm["on"+e])?s(n):e===ff&&Xm("Unhandled promise rejection",i)},Rf=function(e){Vm(Ym,xm,(function(){var t,i=e.facade,n=e.value;if(If(e)&&(t=zm((function(){Um?pf.emit("unhandledRejection",n,i):Cf(ff,i,n)})),e.rejection=Um||If(e)?2:1,t.error))throw t.value}))},If=function(e){return 1!==e.rejection&&!e.parent},vf=function(e){Vm(Ym,xm,(function(){var t=e.facade;Um?pf.emit("rejectionHandled",t):Cf("rejectionhandled",t,e.value)}))},yf=function(e,t,i){return function(n){e(t,n,i)}},Af=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,gf(e,!0))},wf=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw hf("Promise can't be resolved itself");var n=Sf(t);n?Jm((function(){var i={done:!1};try{Vm(n,t,yf(wf,i,e),yf(Af,i,e))}catch(t){Af(i,t,e)}})):(e.value=t,e.state=1,gf(e,!1))}catch(t){Af({done:!1},t,e)}}};sf&&(lf=(df=function(e){Km(this,lf),Gm(e),Vm(Lm,this);var t=rf(this);try{e(yf(wf,t),yf(Af,t))}catch(e){Af(t,e)}}).prototype,(Lm=function(e){af(this,{type:nf,done:!1,notified:!1,parent:!1,reactions:new Qm,rejection:!1,state:0,value:void 0})}).prototype=Fm(lf,"then",(function(e,t){var i=rf(this),n=_f(qm(this,df));return i.parent=!0,n.ok=!Wm(e)||e,n.fail=Wm(t)&&t,n.domain=Um?pf.domain:void 0,0==i.state?i.reactions.add(n):Jm((function(){Tf(n,i)})),n.promise})),km=function(){var e=new Lm,t=rf(e);this.promise=e,this.resolve=yf(wf,t),this.reject=yf(Af,t)},tf.f=_f=function(e){return e===df||undefined===e?new km(e):Ef(e)}),Mm({global:!0,constructor:!0,wrap:!0,forced:sf},{Promise:df}),jm(df,nf,!1,!0),Bm(nf);var bf=Nn("iterator"),Nf=!1;try{var Of=0,Pf={next:function(){return{done:!!Of++}},return:function(){Nf=!0}};Pf[bf]=function(){return this},Array.from(Pf,(function(){throw 2}))}catch(e){}var Df=hm,Lf=function(e,t){if(!t&&!Nf)return!1;var i=!1;try{var n={};n[bf]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},kf=bm.CONSTRUCTOR||!Lf((function(e){Df.all(e).then(void 0,(function(){}))})),Mf=Xt,Uf=Yi,xf=Nm,Vf=lm,Ff=v_;Ks({target:"Promise",stat:!0,forced:kf},{all:function(e){var t=this,i=xf.f(t),n=i.resolve,s=i.reject,o=Vf((function(){var i=Uf(t.resolve),o=[],r=0,a=1;Ff(e,(function(e){var c=r++,d=!1;a++,Mf(i,t,e).then((function(e){d||(d=!0,o[c]=e,--a||n(o))}),s)})),--a||n(o)}));return o.error&&s(o.value),i.promise}});var jf=Ks,Bf=bm.CONSTRUCTOR;hm&&hm.prototype,jf({target:"Promise",proto:!0,forced:Bf,real:!0},{catch:function(e){return this.then(void 0,e)}});var Gf=Xt,Wf=Yi,Hf=Nm,Kf=lm,qf=v_;Ks({target:"Promise",stat:!0,forced:kf},{race:function(e){var t=this,i=Hf.f(t),n=i.reject,s=Kf((function(){var s=Wf(t.resolve);qf(e,(function(e){Gf(s,t,e).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var Yf=Xt,Jf=Nm;Ks({target:"Promise",stat:!0,forced:bm.CONSTRUCTOR},{reject:function(e){var t=Jf.f(this);return Yf(t.reject,void 0,e),t.promise}});var Xf=Ts,zf=fi,Qf=Nm,Zf=function(e,t){if(Xf(e),zf(t)&&t.constructor===e)return t;var i=Qf.f(e);return(0,i.resolve)(t),i.promise},$f=Ks,eS=hm,tS=bm.CONSTRUCTOR,iS=Zf,nS=Ii("Promise"),sS=!tS;$f({target:"Promise",stat:!0,forced:true},{resolve:function(e){return iS(sS&&this===nS?eS:this,e)}});var oS=Xt,rS=Yi,aS=Nm,cS=lm,dS=v_;Ks({target:"Promise",stat:!0,forced:kf},{allSettled:function(e){var t=this,i=aS.f(t),n=i.resolve,s=i.reject,o=cS((function(){var i=rS(t.resolve),s=[],o=0,r=1;dS(e,(function(e){var a=o++,c=!1;r++,oS(i,t,e).then((function(e){c||(c=!0,s[a]={status:"fulfilled",value:e},--r||n(s))}),(function(e){c||(c=!0,s[a]={status:"rejected",reason:e},--r||n(s))}))})),--r||n(s)}));return o.error&&s(o.value),i.promise}});var lS=Xt,hS=Yi,uS=Ii,pS=Nm,_S=lm,ES=v_,mS="No one promise resolved";Ks({target:"Promise",stat:!0,forced:kf},{any:function(e){var t=this,i=uS("AggregateError"),n=pS.f(t),s=n.resolve,o=n.reject,r=_S((function(){var n=hS(t.resolve),r=[],a=0,c=1,d=!1;ES(e,(function(e){var l=a++,h=!1;c++,lS(n,t,e).then((function(e){h||d||(d=!0,s(e))}),(function(e){h||d||(h=!0,r[l]=e,--c||o(new i(r,mS)))}))})),--c||o(new i(r,mS))}));return r.error&&o(r.value),n.promise}});var fS=Ks,SS=hm,TS=Tt,gS=Ii,CS=Ht,RS=aE,IS=Zf,vS=SS&&SS.prototype;fS({target:"Promise",proto:!0,real:!0,forced:!!SS&&TS((function(){vS.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=RS(this,gS("Promise")),i=CS(e);return this.then(i?function(i){return IS(t,e()).then((function(){return i}))}:e,i?function(i){return IS(t,e()).then((function(){throw i}))}:e)}});var yS=Si.Promise,AS=St(yS),wS=Yi,bS=un,NS=ai,OS=no,PS=TypeError,DS=function(e){return function(t,i,n,s){wS(i);var o=bS(t),r=NS(o),a=OS(o),c=e?a-1:0,d=e?-1:1;if(n<2)for(;;){if(c in r){s=r[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw PS("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=d)c in r&&(s=i(s,r[c],c,o));return s}},LS={left:DS(!1),right:DS(!0)},kS=Tt,MS=function(e,t){var i=[][e];return!!i&&kS((function(){i.call(null,t||function(){return 1},1)}))},US=LS.left;Ks({target:"Array",proto:!0,forced:!Y_&&Pi>79&&Pi<83||!MS("reduce")},{reduce:function(e){var t=arguments.length;return US(this,e,t,t>1?arguments[1]:void 0)}});var xS,VS,FS,jS,BS,GS,WS,HS,KS,qS,YS,JS,XS,zS,QS,ZS,$S,eT=uo("Array").reduce,tT=At,iT=eT,nT=Array.prototype,sT=St((function(e){var t=e.reduce;return e===nT||tT(nT,e)&&t===nT.reduce?iT:t})),oT=uo("Array").values,rT=wo,aT=En,cT=At,dT=oT,lT=Array.prototype,hT={DOMTokenList:!0,NodeList:!0},uT=St((function(e){var t=e.values;return e===lT||cT(lT,e)&&t===lT.values||aT(hT,rT(e))?dT:t}));function pT(e,t,i,n){var s,o=arguments.length,r=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(o<3?s(r):o>3?s(t,i,r):s(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r}function _T(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e){e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY"}(xS||(xS={})),function(e){e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver"}(VS||(VS={})),function(e){e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(FS||(FS={})),function(e){e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(jS||(jS={})),function(e){e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(BS||(BS={})),function(e){e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(GS||(GS={})),function(e){e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(WS||(WS={})),function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed"}(HS||(HS={})),function(e){e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(KS||(KS={})),function(e){e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag"}(qS||(qS={})),function(e){e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats"}(YS||(YS={})),function(e){e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list"}(JS||(JS={})),function(e){e.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",e.NEED_ANSWER="NEED_ANSWER",e.NEED_RENEGOTIATE="NEED_RENEGOTIATE",e.P2P_LOST="P2P_LOST",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NEED_UNPUB="NEED_UNPUB",e.NEED_UNSUB="NEED_UNSUB",e.NEED_UPLOAD="NEED_UPLOAD",e.NEED_CONTROL="NEED_CONTROL",e.START_RECONNECT="START_RECONNECT",e.END_RECONNECT="END_RECONNECT",e.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(XS||(XS={})),function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(zS||(zS={})),function(e){e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(QS||(QS={}));class ET extends l{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,t)}throw(){super.throw(t)}}function mT(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw t.error("Invalid Channel Name ".concat(e)),new ET(h.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function fT(e){if(!(i=e,"number"==typeof i&&Math.floor(i)===i&&0<=i&&i<=4294967295||u(e,1,255)))throw new ET(h.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var i;"string"==typeof e&&t.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}!function(e){e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming"}(ZS||(ZS={})),function(e){e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}($S||($S={}));const ST={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},TT={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function gT(e,t){f(e.url,"".concat(t,".url"),1,1e3,!1),p(e.x)||_(e.x,"".concat(t,".x"),0,1e4),p(e.y)||_(e.y,"".concat(t,".y"),0,1e4),p(e.width)||_(e.width,"".concat(t,".width"),0,1e4),p(e.height)||_(e.height,"".concat(t,".height"),0,1e4),p(e.zOrder)||_(e.zOrder,"".concat(t,".zOrder"),0,255),p(e.alpha)||_(e.alpha,"".concat(t,".alpha"),0,1,!1)}const CT={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},RT={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var IT,vT,yT,AT,wT,bT,NT,OT,PT,DT,LT,kT,MT,UT;function xT(e){if(!e.channelName)throw new ET(h.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new ET(h.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&f(e.token,"info.token",1,2047),fT(e.uid),mT(e.channelName),!0}!function(e){e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(IT||(IT={})),function(e){e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(vT||(vT={})),function(e){e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(yT||(yT={})),function(e){e.CONNECT_FAILED="connect failed",e.CONNECT_TIMEOUT="connect timeout",e.WS_DISCONNECTED="websocket disconnected",e.REQUEST_TIMEOUT="request timeout",e.REQUEST_FAILED="request failed",e.WAIT_STATUS_TIMEOUT="wait status timeout",e.WAIT_STATUS_ERROR="wait status error",e.BAD_STATE="bad state",e.WS_ABORT="ws abort",e.AP_REQUEST_TIMEOUT="AP request timeout",e.AP_JSON_PARSE_ERROR="AP json parse error",e.AP_REQUEST_ERROR="AP request error",e.AP_REQUEST_ABORT="AP request abort"}(AT||(AT={})),function(e){e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile"}(wT||(wT={})),function(e){e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(bT||(bT={})),function(e){e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(NT||(NT={})),function(e){e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(OT||(OT={})),function(e){e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low"}(PT||(PT={})),function(e){e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal"}(DT||(DT={})),function(e){e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON"}(LT||(LT={})),function(e){e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7"}(kT||(kT={})),function(e){e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel"}(MT||(MT={})),function(e){e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS"}(UT||(UT={}));const VT=[UT.AFRICA,UT.ASIA,UT.CHINA,UT.EUROPE,UT.GLOBAL,UT.INDIA,UT.JAPAN,UT.NORTH_AMERICA,UT.OCEANIA,UT.OVERSEA,UT.SOUTH_AMERICA];var FT;!function(e){e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL"}(FT||(FT={}));const jT={CHINA:{},ASIA:{CODE:FT.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:FT.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:FT.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:FT.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:FT.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:FT.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:FT.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:FT.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:FT.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:FT.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:FT.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:FT.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:FT.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var BT,GT,WT,HT,KT,qT,YT,JT,XT,zT,QT,ZT,$T,eg,tg,ig,ng,sg,og,rg,ag,cg,dg,lg;a&&(jT.CHINA={CODE:FT.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(e){e.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(BT||(BT={}));class hg extends T{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0}}class ug extends hg{constructor(e,t){super(e,t)}}!function(e){e.SEND="sendonly",e.RECV="recvonly",e.SENDRECV="sendrecv",e.INACTIVE="inactive"}(GT||(GT={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(WT||(WT={})),function(e){e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY"}(HT||(HT={})),function(e){e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(KT||(KT={})),function(e){e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack"}(qT||(qT={})),function(e){e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected"}(YT||(YT={})),function(e){e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE"}(JT||(JT={})),function(e){e.MUTE_LOCAL_VIDEO="mute_local_video",e.MUTE_LOCAL_AUDIO="mute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.MUTE_REMOTE_VIDEO="mute_remote_video",e.MUTE_REMOTE_AUDIO="mute_remote_audio",e.UNMUTE_REMOTE_VIDEO="unmute_remote_video",e.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(XT||(XT={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(zT||(zT={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(QT||(QT={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ZT||(ZT={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}($T||($T={})),function(e){e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback"}(eg||(eg={})),function(e){e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation"}(tg||(tg={})),function(e){e[e.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",e[e.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",e[e.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",e[e.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",e[e.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",e[e.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",e[e.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",e[e.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",e[e.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",e[e.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",e[e.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",e[e.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",e[e.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",e[e.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",e[e.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",e[e.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",e[e.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",e[e.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",e[e.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",e[e.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(ig||(ig={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(ng||(ng={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(sg||(sg={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(og||(og={})),function(e){e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check"}(rg||(rg={})),function(e){e.ABORT="abort"}(ag||(ag={})),function(e){e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(cg||(cg={})),function(e){e[e.SUCCESS=1]="SUCCESS",e[e.FAILED=0]="FAILED"}(dg||(dg={})),function(e){e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed"}(lg||(lg={}));const pg={[FS.ACCESS_POINT]:{[GS.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[GS.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[GS.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[GS.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[GS.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[GS.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[GS.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[FS.UNILBS]:{[BS.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[BS.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[BS.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[BS.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[BS.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[BS.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[BS.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[BS.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[BS.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[BS.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[BS.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[BS.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[FS.STRING_UID_ALLOCATOR]:{[jS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[jS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[jS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function _g(e){const t=pg[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===FS.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const Eg={[WS.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[WS.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[WS.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[WS.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[WS.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[WS.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[WS.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[WS.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[WS.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[WS.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[WS.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[WS.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[WS.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[WS.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[WS.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[WS.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[WS.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[WS.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[WS.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[WS.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[WS.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[WS.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[WS.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[WS.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[WS.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[WS.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[WS.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[WS.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[WS.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[WS.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[WS.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[WS.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[WS.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[WS.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[WS.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[WS.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[WS.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[WS.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[WS.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[WS.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[WS.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[WS.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[WS.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[WS.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[WS.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[WS.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[WS.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[WS.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[WS.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[WS.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[WS.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[WS.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[WS.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[WS.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[WS.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[WS.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[WS.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[WS.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[WS.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[WS.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[WS.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[WS.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[WS.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function mg(e){const t=Eg[e];return t||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function fg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Sg(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fg(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Tg(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function gg(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=g("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const Cg=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,Rg=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Ig=/wss:\/\/(.+):([0-9]+)\/?/,vg=/wss:\/\/(.[^\/]+)\/?/;let yg=0;class Ag{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++yg,this.try443PortDuration=g("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const i=Date.now()-this.startTime;for(var n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];t.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...s)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=g("GATEWAY_DOMAINS"),s=Date.now(),o=[],r=n.find((t=>{var i;return Ho(i=e.host).call(i,t)}));r||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)n.forEach((i=>{a.push(gg(Sg(Sg({},e),{},{host:e.host.replace(r,i)}),t))}));else{const i=Sg({},e);if(t&&r){const e=n.find((e=>e!==r));e&&(i.host=i.host.replace(r,e))}a.push(gg(i,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new ET(h.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=C();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=Tg(o):this.isNormalPortFailed=Tg(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:LT.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);return i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();R()&&I()&&i(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,i,n,s){return this.useDoubleDomain=!!i,"string"==typeof e&&(e=function(e){let i,n,s;return[,i,n,s]=e.match(Cg)||[],i||([,n,s]=e.match(Rg)||[]),n&&s||([,n,s]=e.match(Ig)||[]),n&&s||([,n]=e.match(vg)||[]),n||t.warning("un-destructible url: ",e),{proxy:i,host:n,port:s||"443"}}(e)),this.recordIndex=s,this.useProxy=!!e.proxy,n&&this.useProxy&&(t.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}function wg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class bg extends T{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Ho(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(QS.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(QS.CONNECTED):"closed"===this._state?this.emit(QS.CLOSED):"failed"===this._state&&this.emit(QS.FAILED))}resetReconnectCount(e){t.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new v("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?wg(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):wg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:r,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*r/5)),d=Math.max(1.2,Math.floor(8*a)/10);y.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),A.on(w.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=C(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(QS.CLOSED,(()=>{e.reject(new l(h.WS_DISCONNECT))})),this.once(QS.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void t.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new l(h.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new l(h.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const n=C();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=e=>{var i;null===(i=this.store)||void 0===i||i.signalChannelOpen(),t.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=async e=>{var i;if(t.debug("[".concat(this.name,"] websocket close ").concat(null===(i=this.websocket)||void 0===i?void 0:i.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new l(h.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=P(this,QS.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,s=await this.reconnectWithAction(i);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n.reject(new l(h.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},r=e=>{this.emit(QS.ON_MESSAGE,e)},a=e=>{t.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),g("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=g("GATEWAY_WSS_ADDRESS")),t.debug("[".concat(this.name,"] start connect, url:"),e);const c=null===(i=this.store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,s&&s(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=r,this.websocket.onerror=a,null===(d=this.store)||void 0===d||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(e){const i="closed"===this.state,s=e instanceof l,r=s&&e.code===h.WS_ABORT,a=s&&e.code===h.WS_ERR,d=s?e.message:e&&(e.reason||e.toString());t.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(d)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:r?"aborted":"error",errors:[e]},c),i||a?(n.reject(i?new l(h.WS_DISCONNECT,"websocket is closed: ".concat(d)):new l(h.WS_ERR,"init websocket failed: ".concat(d))),a&&t.error("[".concat(this.name,"] init websocket failed: ").concat(d))):o&&o(e)}return n.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;t.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||A.isOnline||!A.onlineWaiter||(this.onlineReconnectListener=A.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const i=b(this.reconnectCount,this.retryConfig);t.debug("[".concat(this.name,"] wait ").concat(i,"ms to reconnect websocket, mode: ").concat(e)),await AS.race([N(i),this.onlineReconnectListener||new AS((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(QS.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(QS.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);t.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(QS.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e)}else"recover"===e&&(t.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(QS.RECONNECT_WAITTING_FINISH,e),this.urls=await O(this,QS.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],e))}catch(n){var o;t.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const s=null==n||null===(o=n.data)||void 0===o?void 0:o.desc;return Array.isArray(s)&&Ho(s).call(s,"dynamic key expired")?(this.emit(QS.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class Ng extends bg{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const n=C(),s=function(e,t){return new Ag(e,t)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new l(h.WS_ABORT,"choose best websocket aborted"))};const o=g("GATEWAY_DOMAINS");return t.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class Og extends bg{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){return new AS(((n,s)=>{let o=!1;const r=[];this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),r.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),s(new l(h.WS_ABORT,"choose best websocket aborted"))};const a=g("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),u=a.find((t=>-1!==d?Ho(e).call(e,t,d):Ho(e).call(e,t)));t.debug("[choose-best-ws] currentDomain: ",u,", domains: ",a);let p=!this.tryDoubleDomain||!u;if(!p&&u){var _;const l=Date.now();try{a.forEach((i=>{const n=-1===d?e.replace(u,i):e.substr(0,d)+e.substr(d).replace(u,i),s=new WebSocket(n);s.binaryType="arraybuffer",r.push(s),t.debug("[choose-best-ws] ws is connecting:",s.url)}))}catch(e){for(t.debug("[choose-best-ws] ws create failed, fallback to single url"),r.forEach((e=>e.close()));r.length;)r.pop();p=!0}null===(_=this.store)||void 0===_||_.recordJoinChannelService({urls:r.map((e=>e.url)),service:"gateway"},i),r.forEach((e=>{e.onopen=()=>{if(o)return;const i=Date.now()-l;t.debug("[choose-best-ws] ws open cost ".concat(i,"ms")),r.filter((t=>t!==e)).forEach((e=>{t.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),o=!0,n(e)},e.onclose=e=>{if(c=e,o)return;r.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(t.debug("[choose-best-ws] all websocket is closed"),o=!0,s(c))},e.onmessage=i=>{t.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(i.data))}})),N(this.forceCloseTimeout).then((()=>{r.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(p){var E;let o;t.debug("[choose-best-ws] use single url: ",e),null===(E=this.store)||void 0===E||E.recordJoinChannelService({urls:[e],service:"gateway"},i);try{o=new WebSocket(e),r.push(o),o.binaryType="arraybuffer"}catch(e){const i=new l(h.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return t.error("[".concat(this.name,"]").concat(i)),void s(i)}o.onopen=()=>{n(o)},o.onclose=e=>{s(e)},o.onmessage=e=>{t.debug("[choose-best-ws]".concat(o.url," onmessage: ").concat(e.data))},N(this.forceCloseTimeout).then((()=>{o&&o.readyState!==WebSocket.OPEN&&o.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class Pg extends T{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===HS.CONNECTED?this.emit(KS.WS_CONNECTED):e===HS.RECONNECTING?this.emit(KS.WS_RECONNECTING,this._websocketReconnectReason):e===HS.CLOSED&&this.emit(KS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=HS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new D(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(KS.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===JS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===JS.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(t._type===JS.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case WS.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case WS.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case WS.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case WS.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case WS.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case WS.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new Ng("gateway-".concat(this.clientId),this.spec.retryConfig,!0,g("JOIN_GATEWAY_USE_DUAL_DOMAIN"),g("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===HS.CONNECTED&&this.reconnect("retry",k.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new AS(((t,i)=>{if(this.connectionState===HS.CONNECTED)return t();const n=()=>{this.off(KS.WS_CLOSED,s),t()},s=()=>{this.off(KS.WS_CONNECTED,n),i(new ET(h.WS_ABORT))};this.once(KS.WS_CONNECTED,n),this.once(KS.WS_CLOSED,s),e!==qS.PUBLISH&&e!==qS.SUBSCRIBE&&e!==qS.UNSUBSCRIBE&&e!==qS.UNPUBLISH&&e!==qS.CONTROL&&e!==qS.RESTART_ICE||this.once(KS.DISCONNECT_P2P,(()=>{i(new ET(h.DISCONNECT_P2P))})),e!==qS.PUBLISH&&e!==qS.RESTART_ICE||this.once(KS.ABORT_P2P_EXECUTION,(()=>{i(new ET(h.DISCONNECT_P2P))}))}));if(this.connectionState!==HS.CONNECTING&&this.connectionState!==HS.RECONNECTING||e===qS.JOIN||e===qS.REJOIN||await c(),this.websocket.sendMessage(r,!0),s)return;const d=new AS(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.emit(KS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new ET(h.WS_ABORT,"type: ".concat(e))),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(KS.WS_CLOSED,d),this.once(KS.WS_RECONNECTING,d),N(g("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(KS.REQUEST_TIMEOUT,e,i))}))}));let l=null;try{l=await d}catch(t){if(this.connectionState===HS.CLOSED||e===qS.LEAVE)throw new ET(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===qS.JOIN||e===qS.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=mg(u),_=new ET(h.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===WS.ERR_TOO_MANY_BROADCASTERS?e===qS.JOIN||e===qS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===WS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(p.action,k.SERVER_ERROR),e===qS.JOIN||e===qS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new AS((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(YS.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=g("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==HS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),g("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new AS(((t,i)=>{this.once(KS.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(KS.WS_CLOSED,(()=>i(this.initError||new ET(h.WS_ABORT)))),this.connectionState=HS.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=HS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ng("gateway-".concat(this.clientId),this.spec.retryConfig,!0,g("JOIN_GATEWAY_USE_DUAL_DOMAIN"),g("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(KS.ABORT_P2P_EXECUTION);const e=await O(this,KS.REQUEST_JOIN_INFO),t=await this.request(qS.JOIN,e);if(!t)return this.emit(KS.REPORT_JOIN_GATEWAY,LT.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(KS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=HS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new ET(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,KS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(qS.REJOIN,e);return!!t&&(this.connectionState=HS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(JS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(JS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(JS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(JS.MUTE_AUDIO,{uid:e.uid}):this.emit(JS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(JS.MUTE_VIDEO,{uid:e.uid}):this.emit(JS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(JS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(JS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(JS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(JS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(JS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mg(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=g("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>g("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(qS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),g("REPORT_STATS")&&this.send(qS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(YS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(QS.RECONNECT_WAITTING_FINISH,(e=>{this.emit(KS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(QS.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(KS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(QS.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(QS.CLOSED,(()=>{this.connectionState=HS.CLOSED})),this.websocket.on(QS.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=HS.CLOSED})),this.websocket.on(QS.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===HS.CONNECTED?this.connectionState=HS.RECONNECTING:this.connectionState=HS.CONNECTING})),this.websocket.on(QS.WILL_RECONNECT,((e,i,n)=>{const s=U(this,KS.IS_P2P_DISCONNECTED),o=s||"retry"!==e;s&&"retry"===e&&(t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=LT.P2P_DISCONNECTED),o&&(t.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(KS.REPORT_JOIN_GATEWAY,i||LT.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(KS.NEED_RENEW_SESSION),this.emit(KS.DISCONNECT_P2P)),n(e)})),this.websocket.on(QS.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",k.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(KS.REPORT_JOIN_GATEWAY,e.message||e.code||LT.UNKNOWN_REASON,this.url||""),e instanceof ET&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===WS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(QS.REQUEST_NEW_URLS,((e,t)=>{O(this,KS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(QS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var Dg="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",Lg=hi,kg=Oo,Mg=Dg,Ug=yt("".replace),xg=RegExp("^["+Mg+"]+"),Vg=RegExp("(^|[^"+Mg+"])["+Mg+"]+$"),Fg=function(e){return function(t){var i=kg(Lg(t));return 1&e&&(i=Ug(i,xg,"")),2&e&&(i=Ug(i,Vg,"$1")),i}},jg={start:Fg(1),end:Fg(2),trim:Fg(3)},Bg=_h.PROPER,Gg=Tt,Wg=Dg,Hg=jg.trim;Ks({target:"String",proto:!0,forced:function(e){return Gg((function(){return!!Wg[e]()||"âÂá "!=="âÂá "[e]()||Bg&&Wg[e].name!==e}))}("trim")},{trim:function(){return Hg(this)}});var Kg,qg,Yg=uo("String").trim,Jg=At,Xg=Yg,zg=String.prototype,Qg=St((function(e){var t=e.trim;return"string"==typeof e||e===zg||Jg(zg,e)&&t===zg.trim?Xg:t}));function Zg(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function $g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Zg(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Zg(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function eC(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(g("TURN_DOMAIN")):(t.info("Unidentified as ip: ".concat(e,", use as host")),e)}function tC(e,i){e.addresses||(e.addresses=[]);const n=function(e,i){if(g("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:i}=e;return{address:"".concat(t,":").concat(i)}}));const n=g("GATEWAY_DOMAINS");let s=n[1]&&Ho(i).call(i,n[1])?1:0;return e.map((e=>{let{domain_prefix:i,port:o,ip:r}=e;if(i)return{address:"".concat(i,".").concat(n[s++%n.length],":").concat(o)};const a=/^[\.\:\d]+$/.test(r),c=a?"".concat(r.replace(/[^\d]/g,"-"),".").concat(n[s++%n.length],":").concat(o):"".concat(r,":").concat(o);return a||t.info("Unidentified as ip: ".concat(r,", use as host")),{ip:r,port:o,address:c}}))}(e.addresses,i),s=Array.isArray(e.detail)&&e.detail[18];if(s&&"string"==typeof s){const e=s.split(";");for(let t=0;t<e.length;t++){var o;const i=Qg(o=e[t]).call(o);n[t]&&i&&(n[t].ip6=i)}}return{gatewayAddrs:n,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function iC(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function nC(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(iC(t.width),"x").concat(iC(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function sC(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function oC(e,t){let i,n,s;switch(t){case Kg.CHOOSE_SERVER:n=4096,s="choose server";break;case Kg.CLOUD_PROXY:n=1048576,s="proxy";break;case Kg.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case Kg.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new ET(h.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>$g($g({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:$g($g({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new ET(h.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function rC(e,t){return await AS.all(e.addresses.map((async e=>({address:eC(e.ip),tcpport:e.port,udpport:e.port,username:t&&g("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():zo.username,password:t&&g("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await x(t.toString()):zo.password}))))}function aC(e,i){const n=i._videoHeight||i.getMediaStreamTrack(!0).getSettings().height;return n?Math.max(n/iC(e.height),1):(t.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function cC(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:o,protocol:r}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:r}:{candidateType:t,relayProtocol:i,address:s,port:o,protocol:r}}function dC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}!function(e){e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(Kg||(Kg={}));class lC extends T{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Ho(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(eg.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(eg.CONNECTED):"closed"===this._state?this.emit(eg.CLOSED):"failed"===this._state&&this.emit(eg.FAILED))}constructor(e,t,i,n){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._name=void 0,this._state="closed",this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=n,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?dC(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):dC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this._useCompress=i}resetReconnectCount(e){t.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,i){if(!this._transmitter)return void t.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;(void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex)&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const s=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),s&&s.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}!function(e){e[e.Default=0]="Default",e[e.Ack=1]="Ack"}(qg||(qg={}));class hC{constructor(e,t,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=M(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:g("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:g("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:g("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:g("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:g("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:qg.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case qg.Default:{let t;if("string"==typeof e.payload){t=(new TextEncoder).encode(e.payload)}else t=e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),V(n,7,BigInt(e.sendTs));return new Uint8Array(n.buffer).set(t,15),i}case qg.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),V(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const i=new DataView(e),n=i.getUint16(0),s=i.getUint8(2);switch(s){case qg.Default:{const t=i.getUint32(3),o=F(i,7),r=e.slice(15),a=(new TextDecoder).decode(r);return{version:n,type:s,packetNumber:t,sendTs:Number(o),payload:a}}case qg.Ack:{const e=i.getUint32(3),t=i.getUint8(7),o=F(i,8);return{version:n,type:s,maxAckPacketNumber:e,shift:t,ackSendTs:Number(o)}}default:throw t.error("[".concat(this.ID,"] Unrecognized packet type ").concat(s)),new Error("Unrecognized packet type ".concat(s))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===qg.Default?this.ack(t):t.type===qg.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:qg.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:qg.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:qg.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===qg.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class uC extends lC{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new v("datachannel");const{timeout:i,timeoutFactor:n}=t,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);y.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),A.on(w.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||g("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(eg.CLOSED,(()=>i(new ET(h.WS_DISCONNECT)))),this.once(eg.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new AS(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new ET(h.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new ET(h.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new AS(((i,n)=>{var s;const o=()=>{t.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},r=async e=>{var s;if(null===(s=this._closeEstablishingTransmitter)||void 0===s||s.call(this),t.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const s=P(this,eg.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,o=await this.reconnectWithAction(s);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!o)return n(new ET(h.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);i()}else n(new ET(h.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},a=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),t.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=null===(s=this._store)||void 0===s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();O(this,eg.TO_CONNECT_DATACHANNEL,e).then((e=>{var i,n;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:s,close:l}=e;this._transmitter=s,null===(i=this._store)||void 0===i||i.signalChannelOpen();const h=Date.now()-d;t.debug("[choose dc] dc open cost ".concat(h,"ms"));this._reliableTransmission=new hC((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(eg.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,l()},o&&o(),s.onclose=r,s.onmessage=a,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((e=>{var i;if(null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:e instanceof ET&&e.code===h.WS_ABORT?"aborted":"error",errors:[e]},c),"closed"!==this.state){if(e instanceof ET&&e.code===h.WS_ERR){const i=new ET(h.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return t.error("[".concat(this._name,"]").concat(i)),void n(i)}r&&r(e)}else n(new ET(h.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||A.networkState!==y.OFFLINE||(this._onlineReconnectListener=A.onlineWaiter&&A.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},i){const i=b(this._reconnectCount,this._retryConfig);t.debug("[".concat(this._name,"] wait ").concat(i,"ms to reconnect datachannel, mode: ").concat(e)),await AS.race([N(i),this._onlineReconnectListener||new AS((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const s=async(e,t)=>{this.emit(eg.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(eg.RECONNECT_WAITTING_FINISH,e),await s(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||g("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return t.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);t.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const i=this._addresses[this.currentURLIndex];this.emit(eg.RECONNECT_WAITTING_FINISH,e),await s(i,e)}else"recover"===e&&(t.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(eg.RECONNECT_WAITTING_FINISH,e),this.emit(eg.FAILBACK));return!0}catch(n){var o,r;return t.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(o=n.data)&&void 0!==o&&o.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&Ho(r=n.data.desc).call(r,"dynamic key expired")?(this.emit(eg.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}}class pC extends T{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===HS.CONNECTED?this.emit(KS.WS_CONNECTED):e===HS.RECONNECTING?this.emit(KS.WS_RECONNECTING,this._websocketReconnectReason):e===HS.CLOSED&&this.emit(KS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=HS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new D(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e instanceof ArrayBuffer)return void this.emit(KS.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===JS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===JS.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new uC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===HS.CONNECTED&&this.reconnect("retry",$T.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new AS(((t,i)=>{if(this.connectionState===HS.CONNECTED)return t();const n=()=>{this.off(KS.WS_CLOSED,s),t()},s=()=>{this.off(KS.WS_CONNECTED,n),i(new ET(h.WS_ABORT))};this.once(KS.WS_CONNECTED,n),this.once(KS.WS_CLOSED,s),e!==qS.PUBLISH&&e!==qS.SUBSCRIBE&&e!==qS.UNSUBSCRIBE&&e!==qS.UNPUBLISH&&e!==qS.CONTROL&&e!==qS.RESTART_ICE||this.once(KS.DISCONNECT_P2P,(()=>{i(new ET(h.DISCONNECT_P2P))})),e!==qS.PUBLISH&&e!==qS.RESTART_ICE||this.once(KS.ABORT_P2P_EXECUTION,(()=>{i(new ET(h.DISCONNECT_P2P))}))}));if(this.connectionState!==HS.CONNECTING&&this.connectionState!==HS.RECONNECTING||e===qS.JOIN||e===qS.REJOIN||await c(),e===qS.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),this.websocket.sendMessage(r,!0,!1),s)return;const d=new AS(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.emit(KS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new ET(h.WS_ABORT,"type: ".concat(e))),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(KS.WS_CLOSED,d),this.once(KS.WS_RECONNECTING,d),N(g("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("dc request timeout, type: ".concat(e)),this.emit(KS.REQUEST_TIMEOUT,e,i))}))}));let l=null;try{l=await d}catch(t){if(this.connectionState===HS.CLOSED||e===qS.LEAVE)throw new ET(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===qS.JOIN||e===qS.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=mg(u),_=new ET(h.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(t.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===WS.ERR_TOO_MANY_BROADCASTERS?e===qS.JOIN||e===qS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===WS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",$T.MULTI_IP)):this.reconnect(p.action,$T.SERVER_ERROR),e===qS.JOIN||e===qS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new AS((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(YS.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=g("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==HS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),g("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new AS(((n,s)=>{this.once(KS.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(KS.WS_CLOSED,(()=>s(this.initError||new ET(h.WS_ABORT)))),this.connectionState=HS.CONNECTING,this.websocket.init(e).catch(s),this.websocket.once(eg.FAILBACK,(()=>{void 0===this.openConnectionTime&&s(new ET(h.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{i&&void 0===this.openConnectionTime&&(t.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),s(new ET(h.INIT_DATACHANNEL_TIMEOUT)))}),g("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=HS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new uC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(KS.ABORT_P2P_EXECUTION);const e=await O(this,KS.DATACHANNEL_CONNECTING),t=await this.request(qS.JOIN,e);if(!t)return this.emit(KS.REPORT_JOIN_GATEWAY,h.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(KS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=HS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new ET(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,KS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(qS.REJOIN,e);return!!t&&(this.connectionState=HS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(JS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(JS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(JS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(JS.MUTE_AUDIO,{uid:e.uid}):this.emit(JS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(JS.MUTE_VIDEO,{uid:e.uid}):this.emit(JS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(JS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(JS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(JS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(JS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(JS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mg(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,$T.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=g("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>g("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",$T.TIMEOUT):this.request(qS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),g("REPORT_STATS")&&this.send(qS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(YS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(eg.RECONNECT_WAITTING_FINISH,(e=>{this.emit(KS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(eg.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(KS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(eg.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(eg.CLOSED,(()=>{this.connectionState=HS.CLOSED})),this.websocket.on(eg.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=HS.CLOSED})),this.websocket.on(eg.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===HS.CONNECTED?this.connectionState=HS.RECONNECTING:this.connectionState=HS.CONNECTING})),this.websocket.on(eg.WILL_RECONNECT,((e,i)=>{if(U(this,KS.IS_P2P_DISCONNECTED)&&"retry"===e)return t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(KS.NEED_RENEW_SESSION),this.emit(KS.DISCONNECT_P2P),i("tryNext");"retry"!==e&&(t.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(KS.NEED_RENEW_SESSION),this.emit(KS.DISCONNECT_P2P)),i(e)})),this.websocket.on(eg.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",$T.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(KS.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof ET&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===WS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",$T.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",$T.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(eg.REQUEST_NEW_URLS,((e,t)=>{O(this,KS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(eg.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(eg.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>O(this,KS.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(eg.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(KS.DATACHANNEL_FAILBACK)}))}}var _C=Wi,EC=TypeError,mC=Ja,fC=Math.floor,SC=function(e,t){var i=e.length,n=fC(i/2);return i<8?TC(e,t):gC(e,SC(mC(e,0,n),t),SC(mC(e,n),t),t)},TC=function(e,t){for(var i,n,s=e.length,o=1;o<s;){for(n=o,i=e[o];n&&t(e[n-1],i)>0;)e[n]=e[--n];n!==o++&&(e[n]=i)}return e},gC=function(e,t,i,n){for(var s=t.length,o=i.length,r=0,a=0;r<s||a<o;)e[r+a]=r<s&&a<o?n(t[r],i[a])<=0?t[r++]:i[a++]:r<s?t[r++]:i[a++];return e},CC=SC,RC=vi.match(/firefox\/(\d+)/i),IC=!!RC&&+RC[1],vC=/MSIE|Trident/.test(vi),yC=vi.match(/AppleWebKit\/(\d+)\./),AC=!!yC&&+yC[1],wC=Ks,bC=yt,NC=Yi,OC=un,PC=no,DC=function(e,t){if(!delete e[t])throw EC("Cannot delete property "+_C(t)+" of "+_C(e))},LC=Oo,kC=Tt,MC=CC,UC=MS,xC=IC,VC=vC,FC=Pi,jC=AC,BC=[],GC=bC(BC.sort),WC=bC(BC.push),HC=kC((function(){BC.sort(void 0)})),KC=kC((function(){BC.sort(null)})),qC=UC("sort"),YC=!kC((function(){if(FC)return FC<70;if(!(xC&&xC>3)){if(VC)return!0;if(jC)return jC<603;var e,t,i,n,s="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)BC.push({k:t+n,v:i})}for(BC.sort((function(e,t){return t.v-e.v})),n=0;n<BC.length;n++)t=BC[n].k.charAt(0),s.charAt(s.length-1)!==t&&(s+=t);return"DGBEFHACIJK"!==s}}));wC({target:"Array",proto:!0,forced:HC||!KC||!qC||!YC},{sort:function(e){void 0!==e&&NC(e);var t=OC(this);if(YC)return void 0===e?GC(t):GC(t,e);var i,n,s=[],o=PC(t);for(n=0;n<o;n++)n in t&&WC(s,t[n]);for(MC(s,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:LC(t)>LC(i)?1:-1}}(e)),i=PC(s),n=0;n<i;)t[n]=s[n++];for(;n<o;)DC(t,n++);return t}});var JC=uo("Array").sort,XC=At,zC=JC,QC=Array.prototype,ZC=St((function(e){var t=e.sort;return e===QC||XC(QC,e)&&t===QC.sort?zC:t}));class $C extends T{constructor(e,t){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=e,this.token=t;const i=()=>{this.signal.connectionState===HS.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*g("P2P_TOKEN_INTERVAL"))};i()}async send(e,i,n,s,o){var r,a,c;if(0===this.userMap.size)return;const d=Array.from(uT(r=this.userMap).call(r))[0].token;"string"!=typeof i&&(i=JSON.stringify(i)),s=null!==(a=s)&&void 0!==a?a:M(6,""),o=null!==(c=o)&&void 0!==c?c:this._sequence++;const u={_id:s,_type:e,_seq:o,_message:i,token:"".concat(this.token,"_").concat(d)};g("SHOW_P2P_LOG")&&t.debug("send message",u,"noNeedResponse : ".concat(n));this.splitMessage(JSON.stringify(u)).forEach((e=>{this.signal.request(qS.DATA_STREAM,{payload:j(this.encoder.encode(e))})}));const p=new AS(((i,o)=>{const r=window.setTimeout((()=>{this.off("res-@".concat(s,"_ack"),a),this.off("res-@".concat(s),d),this.off(ag.ABORT,c),t.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(s)),0===this.userMap.size?o(new l(h.INVALID_REMOTE_USER)):o(new l(h.TIMEOUT))}),g("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),a=()=>{r&&window.clearTimeout(r),this.off(ag.ABORT,c),n&&i()},c=()=>{r&&window.clearTimeout(r),this.off("res-@".concat(s,"_ack"),a),this.off("res-@".concat(s),d),o(new l(h.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(s)))};this.once(ag.ABORT,c),this.once("res-@".concat(s,"_ack"),a);const d=(t,n)=>{p=!0,r&&window.clearTimeout(r),this.off("res-@".concat(s,"_ack"),a),this.off(ag.ABORT,c),"success"===t?i(n):o(new l(h.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(s)))};let p=!1;n||(this.once("res-@".concat(s),d),N(g("SIGNAL_REQUEST_TIMEOUT")).then((()=>{p||t.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(s,", ").concat(u))})))}));try{return await p}catch(t){if(t.code===h.TIMEOUT)return await this.send(e,i,n,s,o);throw t}}onMessage(e){var i;const{_uid:n}=e;let s,o=this.userMap.get(n);if(o)s=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==rg.CHECK)return;const{token:t}=e;s=new Map,o={uid:n,isStart:!0,token:t,splitMessageMap:s,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,o),this.signal.emit(JS.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in e&&"total"in e){var r;const{id:t,total:i}=e,o=null!==(r=s.get(t))&&void 0!==r?r:[];if(o.push(e),s.has(t)||s.set(t,o),o.length!==i)return;{const i=ZC(o).call(o,((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");s.delete(t),(e=JSON.parse(i))._uid=n}}const{_type:a,token:c}=e;if(Ho(i=[rg.ACK,rg.CHECK]).call(i,a))return a===rg.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):t.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){const e={_id:M(6,""),token:this.token,_type:rg.CHECK};g("SHOW_P2P_LOG")&&t.debug("send message",e),this.signal.request(qS.DATA_STREAM,{payload:j(this.encoder.encode(JSON.stringify(e)))})}ack(e){const i={_id:e,_type:rg.ACK,token:this.token};g("SHOW_P2P_LOG")&&t.debug("send message",i),this.signal.request(qS.DATA_STREAM,{payload:j(this.encoder.encode(JSON.stringify(i)))})}response(e,t,i){this.send(rg.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const i=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const n=t.get(i);t.delete(i),this.receiveMessage(n),e.nextExpectedSequenceNumber++}}))};if(!e)return void i();const{_uid:n,_seq:s}=e,o=this.userMap.get(n),{receivedMessagesMap:r,isStart:a,nextExpectedSequenceNumber:c}=o;if(s<c)return this.ack(e._id),void t.debug("[external-signal] receive old message, seq: ".concat(s,", ").concat(e._message));r.set(s,e),a&&s===c&&(this.receiveMessage(e),r.delete(c),o.nextExpectedSequenceNumber++,i())}receiveMessage(e){const{_id:i,_type:n,_message:s,_uid:o}=e;if(g("SHOW_P2P_LOG")&&t.debug("receive message",e),i){let t;switch(e._type!==rg.ACK&&(s&&(t=JSON.parse(s)),this.ack(e._id)),e._type){case rg.CANDIDATE:case rg.CONTROL:this.signal.emit(n,t,o);break;case rg.PUBLISH:case rg.UNPUBLISH:case rg.RESTART_ICE:case rg.CALL:t.uid=o,O(this.signal,n,t).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case rg.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case rg.RESPONSE:{const{success:e,message:n}=t;this.emit("res-@".concat(i),e?"success":"failed",n);break}}}}splitMessage(e){if(e.length<$C.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:i}=JSON.parse(e),n=M(6,"");let s=0,o=800;const r=Math.ceil(e.length/o);for(;e.length>0;){s++;const a={id:n,index:s,total:r,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(a).length>$C.MAX_MESSAGE_SIZE?o-=50:(t.push(a),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,i){return e.token!==i?(t.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{t.debug("token timeout, ".concat(i)),this.reset(e.uid)}),g("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await O(this.signal,rg.CALL,void 0),t=await this.send(rg.CALL,e);this.signal.emit(KS.P2P_CONNECTION,t,!0)}async reset(e,i){const n=this.userMap.get(e);n&&(this.emit(ag.ABORT),this.signal.emit(JS.ON_USER_OFFLINE,{uid:n.uid,reason:lg.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(t.debug("change local token from ".concat(i," to ").concat(i)),this.token=M(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(ag.ABORT)}}$C.MAX_SIZE=1,$C.MAX_MESSAGE_SIZE=1024;class eR extends T{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===HS.CONNECTED?this.emit(KS.WS_CONNECTED):e===HS.RECONNECTING?this.emit(KS.WS_RECONNECTING,this._websocketReconnectReason):e===HS.CLOSED&&this.emit(KS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=HS.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new D(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(KS.ON_BINARY_DATA,e.data);const i=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const e="res-@".concat(i._id);this.emit(e,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case JS.ON_DATA_STREAM:return void this.handleDataStream(i._message);case JS.MUTE_AUDIO:case JS.MUTE_VIDEO:case JS.ON_P2P_LOST:case JS.ON_USER_ONLINE:return;case JS.ON_USER_OFFLINE:const{uid:e}=i._message;return t.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(i._type,i._message),i._type===JS.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===JS.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(i._type===JS.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case WS.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case WS.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case WS.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case WS.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case WS.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case WS.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new Ng("gateway-".concat(this.clientId),this.spec.retryConfig,!0,g("JOIN_GATEWAY_USE_DUAL_DOMAIN"),g("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===HS.CONNECTED&&this.reconnect("retry",k.OFFLINE)})),this.p2pToken=M(6,""),this._external_signal=new $C(this,this.p2pToken)}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new AS(((e,t)=>{if(this.connectionState===HS.CONNECTED)return e();const i=()=>{this.off(KS.WS_CLOSED,n),e()},n=()=>{this.off(KS.WS_CONNECTED,i),t(new l(h.WS_ABORT))};this.once(KS.WS_CONNECTED,i),this.once(KS.WS_CLOSED,n)}));if(this.connectionState!==HS.CONNECTING&&this.connectionState!==HS.RECONNECTING||e===qS.JOIN||e===qS.REJOIN||await c(),this.websocket.sendMessage(r,!0),s)return;const d=new AS(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.emit(KS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new l(h.WS_ABORT,"type: ".concat(e))),this.off(KS.WS_CLOSED,d),this.off(KS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(KS.WS_CLOSED,d),this.once(KS.WS_RECONNECTING,d),N(g("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(KS.REQUEST_TIMEOUT,e,i))}))}));let u=null;try{u=await d}catch(t){if(this.connectionState===HS.CLOSED||e===qS.LEAVE)throw new l(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===qS.JOIN||e===qS.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const p=Number(u.message.error_code||u.message.code),_=mg(p),E=new l(h.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(u.message.error_str),{code:p,data:u.message});return"success"===_.action?u.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(_.desc,", action: ").concat(_.action)),p===WS.ERR_TOO_MANY_BROADCASTERS?e===qS.JOIN||e===qS.REJOIN?(this.initError=E,this.close(),E.throw()):E.throw():"failed"===_.action?E.throw():"quit"===_.action?(this.initError=E,this.close(),E.throw()):(p===WS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(_.action,k.SERVER_ERROR),e===qS.JOIN||e===qS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new AS((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(YS.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=g("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==HS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),g("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new AS(((t,i)=>{this.once(KS.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(KS.WS_CLOSED,(()=>i(this.initError||new l(h.WS_ABORT)))),this.connectionState=HS.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||L.LEAVE,this.connectionState=HS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Ng("gateway-".concat(this.clientId),this.spec.retryConfig,!0,g("JOIN_GATEWAY_USE_DUAL_DOMAIN"),g("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=M(6,""),this._external_signal.clear(),this._external_signal=new $C(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(KS.ABORT_P2P_EXECUTION);const e=await O(this,KS.REQUEST_JOIN_INFO),t=await this.request(qS.JOIN,e);if(!t)return this.emit(KS.REPORT_JOIN_GATEWAY,h.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(KS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=HS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{var t;const i=B(e.payload),n=(new TextDecoder).decode(i),s=JSON.parse(n);"total"in s&&"id"in s||Ho(t=Object.values(rg)).call(t,s._type)?(s._uid=e.uid,this._external_signal.onMessage(s)):this.emit(JS.ON_DATA_STREAM,e)}catch(t){this.emit(JS.ON_DATA_STREAM,e)}}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mg(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=g("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>g("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(qS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),g("REPORT_STATS")&&this.send(qS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(QS.RECONNECT_WAITTING_FINISH,(e=>{this.emit(KS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(QS.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(KS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(QS.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(QS.CLOSED,(()=>{this.connectionState=HS.CLOSED})),this.websocket.on(QS.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=HS.CLOSED})),this.websocket.on(QS.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===HS.CONNECTED?this.connectionState=HS.RECONNECTING:this.connectionState=HS.CONNECTING})),this.websocket.on(QS.WILL_RECONNECT,((e,i,n)=>{"retry"!==e?(t.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(KS.NEED_RENEW_SESSION)):t.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)})),this.websocket.on(QS.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(KS.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof l&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===WS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(QS.REQUEST_NEW_URLS,((e,t)=>{O(this,KS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(QS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}function tR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function iR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?tR(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):tR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const nR=new Map;class sR extends T{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(DT.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(DT.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){t.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useP2P?new eR(iR(iR({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new pC(iR(iR({},t),{},{retryConfig:t.websocketRetryConfig}),e):new Pg(iR(iR({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,n,s){if(this.signal instanceof pC){let i=!1;"disabled"!==e.cloudProxyServer?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),i=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),i=!0):e.apResponse.addresses.some((e=>e.fingerprint))||g("FINGERPRINT")||(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),i=!0),i&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const o=Date.now();let r=nR.get(e.cname);if(r||(r=new Map,nR.set(e.cname,r)),this._isProactiveJoin=!0,r.has(e.uid)){const t=new ET(h.UID_CONFLICT);throw i.joinGateway(e.sid,{lts:o,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof pC?"1":"0"}),this._isProactiveJoin=!1,t}r.set(e.uid,!0),this.joinInfo=e,this.key=n;let a=0;this.joinGatewayStartTime=o;const c=e.proxyServer;try{let i;if(t.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof pC?"datachannel":"websocket"," join uid ").concat(a)),this.signal instanceof pC)i=await this.signal.init(e.apResponse.addresses,s);else{const t=e.gatewayAddrs.map((t=>{let{address:i}=t;const[n,s]=i.split(":"),o={host:n,port:s};return e.proxyServer&&(o.proxy=e.proxyServer),o}));i=await this.signal.init(t,s)}a=i.uid,t.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof pC?"datachannel":"websocket"," join uid ").concat(a," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(n){if(n&&n.code===h.INIT_WEBSOCKET_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join failed"),n.toString()),n;if(n&&n.code===h.INIT_DATACHANNEL_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join datachannel failed"),n.toString()),this.resetSignal(),n;throw t.error("[".concat(this.store.clientId,"] User join failed"),n.toString()),i.joinGateway(e.sid,{lts:o,succ:!1,ec:n.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!c,signalChannel:this.signal instanceof pC?"1":"0"}),this._isProactiveJoin=!1,r.delete(e.uid),this.signal.close(),n}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),t.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{t.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(DT.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(DT.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(DT.NETWORK_QUALITY,{uplinkNetworkQuality:sC(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:sC(this._statsCollector.trafficStats.B_dnq)}):this.emit(DT.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),a}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){i!==L.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==HS.CONNECTED||await G(this.signal.request(qS.LEAVE,void 0,!0),3e3)}catch(e){t.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(i),i!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:g("PUB_EXTEND"),twcc:!!g("PUBLISH_TWCC"),rtx:!!g("USE_PUB_RTX")};try{return(await this.signal.request(qS.PUBLISH,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===WS.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw s}}async publishDataChannel(e,i,n){var s;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:null!==(s=i.maxRetransmits)&&void 0!==s?s:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(qS.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===WS.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw s}}async unpublish(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(qS.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await AS.all(e.map((e=>this.signal.request(qS.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){t.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!g("SUBSCRIBE_TWCC"),rtx:!!g("USE_SUB_RTX")||void 0,extend:g("SUB_EXTEND"),svc:Array.isArray(g("SVC"))&&0!==g("SVC").length?g("SVC"):void 0};try{return await this.signal.request(qS.PRE_SUBSCRIBE,s,!0)}catch(s){if(n&&s.data&&s.data.code===WS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(e,i,!1);throw s}}async subscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!g("SUBSCRIBE_TWCC"),rtx:!!g("USE_SUB_RTX"),extend:g("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(g("SVC"))&&0!==g("SVC").length?g("SVC"):void 0};try{return(await this.signal.request(qS.SUBSCRIBE,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===WS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw s}}async subscribeDataChannel(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(qS.SUBSCRIBE_DATASTREAM,s,!0)}catch(s){if(n&&s.data&&s.data.code===WS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw s}}async subscribeAll(e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!g("USE_SUB_RTX")};try{return await this.signal.request(qS.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(i&&n.data&&n.data.code===WS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const i=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(i)return this.signal.request(qS.SET_VIDEO_PROFILE,i);t.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(qS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new ET(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await AS.all(e.map((e=>this.signal.request(qS.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:i},!0))))}catch(e){t.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(qS.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){t.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(qS.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(qS.GATEWAY_INFO)}async renewToken(e){await this.signal.request(qS.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(qS.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(qS.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(qS.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(qS.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(qS.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(qS.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.signal instanceof eR)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),iR({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(qS.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=nR.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:zo.username,password:zo.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(iR(iR({},zo),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(qS.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&W((()=>{this.emit(DT.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new ET(h.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=g("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=iR({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:H,browser:navigator.userAgent,process_id:g("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:g("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:g("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:g("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof g("SUBSCRIBE_AUDIO_FILTER_TOPN")?g("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof g("ENABLE_PUBLISH_AUDIO_FILTER")?g("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof g("ENABLE_USER_LICENSE_CHECK")?g("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===g("USE_PUB_RTX")||!0===g("USE_SUB_RTX")||void 0,disableFEC:g("DISABLE_FEC"),enableNTPReport:!!g("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!g("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof g("ENABLE_DATASTREAM_2")?g("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!g("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof g("USE_XR")?g("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,g("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new ET(h.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(KS.WS_RECONNECT_WAITTING_FINISH,(e=>{var t;Ho(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&i.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(KS.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(KS.WS_RECONNECTING,(e=>{this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||k.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",i.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(KS.WS_CLOSED,(e=>{let n;switch(e){case L.LEAVE:n=k.LEAVE;break;case L.UID_BANNED:case L.IP_BANNED:case L.CHANNEL_BANNED:case L.SERVER_ERROR:n=k.SERVER_ERROR;break;case L.FALLBACK:n=k.FALLBACK;break;case L.LICENSE_MISSING:case L.LICENSE_EXPIRED:case L.LICENSE_MINUTES_EXCEEDED:case L.LICENSE_PERIOD_INVALID:case L.LICENSE_MULTIPLE_SDK_SERVICE:case L.LICENSE_ILLEGAL:case L.TOKEN_EXPIRE:n=e;break;default:n=k.NETWORK_ERROR}t.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+k.NETWORK_ERROR)),this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===L.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(KS.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(t.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof pC?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void t.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));K("EVENT_REPORT_DOMAIN",e[1]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]),K("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(JS.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(KS.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new ET(h.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,O(this,DT.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(KS.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await O(this,DT.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(KS.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(KS.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof pC?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(KS.IS_P2P_DISCONNECTED,(e=>{e(U(this,DT.IS_P2P_DISCONNECTED))})),this.signal.on(KS.DISCONNECT_P2P,(()=>{this.emit(DT.DISCONNECT_P2P)})),this.signal.on(KS.NEED_RENEW_SESSION,(()=>{this.emit(DT.NEED_RENEW_SESSION)})),this.signal.on(KS.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(KS.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(KS.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(DT.JOIN_RESPONSE,e,t)})),this.signal.on(KS.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return O(this,DT.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on(KS.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await O(this,DT.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(KS.DATACHANNEL_FAILBACK,(()=>{t.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(DT.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,i){try{await this.signal.request(qS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(qS.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(e){throw t.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(qS.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(qS.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(e){throw t.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const i={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(qS.UNSUBSCRIBE_STREAMS,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,i){const n={action:e.find((e=>e.stream_type===PT.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(qS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,i){const n={action:e.find((e=>e.stream_type===PT.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(qS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,i){const n={action:e===WT.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(qS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,i){const n={action:e===WT.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(qS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(qS.RESTART_ICE,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,k.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!g("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(qS.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(L.FALLBACK)),this.store.useDataChannel=!1,this.signal=new Pg(iR(iR({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(DT.RESET_SIGNAL,MT.websocket)}}let oR=0,rR=0;function aR(e,t,i,n){return new AS(((s,o)=>{t.timeout=t.timeout||g("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),oR+=q(t.data)):i&&(t.data.size?oR+=t.data.size:t.data instanceof FormData?oR+=Y(t.data):oR+=q(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,Ve.request(t).then((e=>{"string"==typeof e.data?rR+=q(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?rR+=e.data.byteLength:rR+=q(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{Ve.isCancel(e)?o(new ET(h.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new ET(h.NETWORK_TIMEOUT,e.message)):e.response?o(new ET(h.NETWORK_RESPONSE_ERROR,e.response.status)):o(new ET(h.NETWORK_ERROR,e.message))}))}))}const cR=()=>{const e=g("AREAS");0===e.length&&e.push(UT.GLOBAL);return sT(e).call(e,((e,t,i)=>{const n=dR(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},dR=e=>e===UT.OVERSEA?"".concat(FT.ASIA,",").concat(FT.EUROPE,",").concat(FT.AFRICA,",").concat(FT.NORTH_AMERICA,",").concat(FT.SOUTH_AMERICA,",").concat(FT.OCEANIA):FT[e],lR=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=jT[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},hR={GLOBAL:{ASIA:[UT.CHINA,UT.JAPAN,UT.INDIA,UT.KOREA,UT.HKMC],EUROPE:[],NORTH_AMERICA:[UT.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},uR=Object.keys(hR[UT.GLOBAL]),pR=[UT.CHINA,UT.NORTH_AMERICA,UT.EUROPE,UT.ASIA,UT.JAPAN,UT.INDIA,UT.OCEANIA,UT.SOUTH_AMERICA,UT.AFRICA,UT.KOREA,UT.HKMC,UT.US],_R=function(e,t){let i=[];if(Ho(e).call(e,UT.GLOBAL)){const o=[UT.GLOBAL,UT.OVERSEA],r=Object.keys(jT);if(t===UT.GLOBAL)throw new ET(h.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===UT.CHINA)i=[UT.OVERSEA];else if(s=t,Ho(uR).call(uR,s)){const e=(n=t,hR[UT.GLOBAL][n]||[]),s=[...o,t,...e];i=r.filter((e=>!Ho(s).call(s,e)))}else if(function(e){let t=!1;return uR.forEach((i=>{var n;Ho(n=hR[UT.GLOBAL][i]).call(n,e)&&(t=!0)})),t}(t)){const e=function(e){let t;return uR.forEach((i=>{var n;Ho(n=hR[UT.GLOBAL][i]).call(n,e)&&(t=i)})),t}(t),n=[...o,e,t];i=r.filter((e=>!Ho(n).call(n,e)))}else i=e;i=function(e){const t=[];return pR.forEach((i=>{Ho(e).call(e,i)&&t.push(i)})),t.concat(e.filter((e=>!Ho(pR).call(pR,e))))}(i)}else i=e;var n,s;return i};function ER(e){var i,n;if(!e&&Ho(i=g("AREAS")).call(i,UT.EXTENSIONS))return t.debug("update area from ap : reset"),void mR(Xo,!0);if(!Ho(n=g("AREAS")).call(n,UT.GLOBAL)||!e)return;let s=jT.EXTENSIONS;s&&(s={CODE:dR(UT.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},t.debug("update area from ap success: ".concat(e,",config is "),s),K("AREAS",[UT.EXTENSIONS],!0),Object.keys(s).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=s[e];K(e,t[0])}else K(e,s[e])})))}function mR(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s=i.reportApiInvoke(null,{name:J.SET_AREA,options:e,tag:X.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!Ho(VT).call(VT,e))throw new ET(h.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new ET(h.INVALID_PARAMS,"area code is needed");let s=t;"string"==typeof t&&(s=[t]),i=n?_R(s,n):s}if(!n){if(d.AREAS){const e=new ET(h.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return s.onError(e),void t.warning("setArea is prohibited because of config-distribute")}if(Ho(i).call(i,UT.GLOBAL)&&g("AREAS")===UT.EXTENSIONS){const e=new ET(h.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return s.onError(e),void t.warning("setArea is prohibited because of ap extensions")}}K("AREAS",i,n);const o=lR(i);Object.keys(o).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=o[e];K(e,t[0])}else K(e,o[e])})),t.debug("set area success:",i.join(","))}catch(e){throw s.onError(e),e}s.onSuccess()}function fR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function SR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fR(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let TR=1;function gR(e,n,s,o,r){TR+=1;const a={sid:s.sid,command:"convergeAllocateEdge",uid:"666",appId:s.appId,ts:Math.floor(Date.now()/1e3),seq:TR,requestId:TR,version:H,cname:s.cname},c={service_name:n,json_body:JSON.stringify(a)};let d,l,u=e[0];return z((async()=>{d=Date.now();const e=await aR(u,{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-d,0!==e.code){const i=new ET(h.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:l});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new ET(h.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:l});throw t.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new ET(h.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:l});throw t.error(e.toString()),e}const s=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(g("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,n);return g("LIVE_STREAMING_ADDRESS")&&(s.addressList=g("LIVE_STREAMING_ADDRESS")instanceof Array?g("LIVE_STREAMING_ADDRESS"):[g("LIVE_STREAMING_ADDRESS")]),SR(SR({},s),{},{responseTime:l})}),((t,o)=>(i.apworkerEvent(s.sid,{success:!0,sc:200,serviceName:n,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===o,responseTime:l,serverIp:e[o%e.length]}),!1)),((t,o)=>(i.apworkerEvent(s.sid,{success:!1,sc:t.data&&t.data.code||200,serviceName:n,responseTime:l,serverIp:e[o%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(u=e[(o+1)%e.length],!0))),r)}let CR=1;function RR(e,n,s,o){let{url:r,areaCode:a}=e;const c=Date.now();let d;const[l,u]=wR(n,a,[Kg.CHOOSE_SERVER]);let p=A.networkState;return z((async()=>{p&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await AS.race([A.onlineWaiter,N(o&&o.maxRetryTimeout||Z.maxRetryTimeout)]),p=A.networkState;const{data:e,headers:t}=await aR(r,{data:l,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d="1"===t.http3?1:-1,i.reportResourceTiming(r,n.sid),vR(e,r,n,c,[Kg.CHOOSE_SERVER],d);const a=oC(e,Kg.CHOOSE_SERVER);return yR(a),tC(a,r)}),(e=>(e&&i.joinChooseServer(n.sid,{lts:c,succ:!0,csAddr:r,opid:u,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[Kg.CHOOSE_SERVER].toString(),isHttp3:d}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinChooseServer(n.sid,{lts:c,succ:!1,csAddr:r,serverList:null,opid:u,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[Kg.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d}),t.warning("[".concat(n.clientId,"] Choose server network error, retry"),e),!0))),o)}function IR(e,n,s,o){let r,{url:a,areaCode:c,serviceIds:d}=e;const l=Date.now(),[u,p]=wR(n,c,d);let _;return z((async()=>{_&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await AS.race([A.onlineWaiter,N(o&&o.maxRetryTimeout||Z.maxRetryTimeout)]),_=A.networkState;const{data:e,headers:t}=await aR(a,{data:u,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r="1"===t.http3?1:-1,i.reportResourceTiming(a,n.sid),vR(e,a,n,l,d,r);const c=oC(e,Kg.CHOOSE_SERVER),h=oC(e,"proxy5"===n.cloudProxyServer?Kg.CLOUD_PROXY_5:"proxy3"===n.cloudProxyServer||"proxy4"===n.cloudProxyServer?Kg.CLOUD_PROXY:Kg.CLOUD_PROXY_FALLBACK);return yR(c),{gatewayInfo:tC(c,a),proxyInfo:h,url:a}}),(e=>(e.gatewayInfo&&i.joinChooseServer(n.sid,{lts:l,succ:!0,csAddr:a,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:p,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:d.toString(),isHttp3:r}),e.proxyInfo&&i.joinWebProxyAP(n.sid,{lts:l,sucess:1,apServerAddr:a,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:n.cloudProxyServer,unilbsServerIds:d.toString()}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinWebProxyAP(n.sid,{lts:l,sucess:0,apServerAddr:a,turnServerAddrList:null,errorCode:e.code,eventType:n.cloudProxyServer,unilbsServerIds:d.toString(),extend:JSON.stringify({networkState:_})}),t.warning("[".concat(n.clientId,"] multi unilbs network error, retry"),e),!0))),o)}const vR=(e,n,s,o,r,a)=>{const c=[],d=t=>{4096===t.flag?i.joinChooseServer(s.sid,{lts:o,succ:!1,csAddr:n,opid:e.opid,serverList:null,ec:t.error.message,csIp:t.error.data&&t.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:a}):1048576!==t.flag&&4194304!==t.flag&&4194310!==t.flag||i.joinWebProxyAP(s.sid,{lts:o,sucess:0,apServerAddr:n,turnServerAddrList:null,errorCode:t.error.code,eventType:s.cloudProxyServer,unilbsServerIds:r.toString()})};if(e.response_body.forEach((i=>{const n=i.buffer.code;if(23===i.uri&&0===n&&!i.buffer.edges_services)if(4194310===i.buffer.flag)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),i.buffer.edges_services=[];else{const t={error:new ET(h.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:i.buffer.flag};c.push(t),d(t)}if(0!==n){const s=_g(n),o={error:new ET(h.CAN_NOT_GET_GATEWAY_SERVER,s.desc,{desc:s.desc,retry:s.retry,csIp:e.detail[502]}),flag:i.buffer.flag};4194310===i.buffer.flag?t.warning(o.error.toString()):c.push(o),d(o)}})),c.length)throw t.warning("[".concat(s.clientId,"] multi unilbs ").concat(n," failed, ").concat(c.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new ET(h.CAN_NOT_GET_GATEWAY_SERVER,c.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!c.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(c.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},yR=e=>{var i,n,s,o;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new ET(h.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});g("AP_AREA")&&(null!==(s=e.detail)&&void 0!==s&&s[23]&&"string"==typeof(null===(o=e.detail)||void 0===o?void 0:o[23])?ER(e.detail[23].toLowerCase()):ER());if(null!==(i=e.detail)&&void 0!==i&&i[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let t=0;t<i.length;t++){var r;const n=Qg(r=i[t]).call(r);e.addresses[t]&&i&&(e.addresses[t].fingerprint=n)}}if(g("GATEWAY_ADDRESS")&&g("GATEWAY_ADDRESS").length>0){t.debug("assign gateway address to",g("GATEWAY_ADDRESS"));const i=g("GATEWAY_ADDRESS").map((t=>{var i,n;const s=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:s}}));e.addresses=i}},AR=(e,i)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=_g(t.buffer.code);throw new ET(h.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw t.debug("update ticket request received ap response without response body:",i),new ET(h.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},wR=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:SR({6:e.stringUid,11:t,12:g("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},bR=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let NR=0;function OR(e){return AS.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const PR=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=e,r=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=r*a,t=e+a;return i.slice(e,t).map(n)})();o&&o.push(...e);try{c=await OR(e)}catch(e){if(d+=a,r++,!(d>=i.length))return void await l();s(e)}e.forEach((e=>e.cancel()))};return await l(),c};async function DR(e,i,n,s){const o=async function(e,i,n,s){let o=null;const r=[],a=async()=>{const o=g("WEBCS_DOMAIN").slice(0,g("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:cR()}))),a=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await PR({fragementLength:g("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),s.url),RR(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c},c=async()=>{if(await N(1e3),null!==o)return o;const a=g("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:cR()}))),c=s.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:a.map((e=>e.url))}),d=await PR({fragementLength:g("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),s.url),RR(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};try{return o=await OR([a(),c()]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),o}catch(e){throw e[0]}}(e,i,n,s);return{gatewayInfo:await o}}async function LR(e,i,n,s,o){const r=e.cloudProxyServer;if("disabled"===r){if(!s)return;if(e.useLocalAccessPoint)return await DR(e,i,n,o);if(g("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:t,proxyInfo:s}=await UR(e,i,n,o);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:t};const r=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||zo.tcpport,udpport:e.udpport||zo.udpport,username:e.username||zo.username,password:e.password||zo.password,forceturn:!1,security:!0})));if(o.useP2P){var a;const i=null!==(a=e.uid)&&void 0!==a?a:t.uid,n="glb:".concat(i.toString()),o=await x(n),c=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||zo.tcpport,udpport:e.udpport||zo.udpport,username:n,password:o,forceturn:!1,security:!0})));r.push(...c)}return e.turnServer={mode:"manual",servers:r},{gatewayInfo:t}}return await DR(e,i,n,o)}const{proxyInfo:c,gatewayInfo:d}=await UR(e,i,n,o),l={gatewayInfo:d},h=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport?e.tcpport:zo.tcpport,udpport:"proxy4"===r?void 0:e.udpport?e.udpport:zo.udpport,username:e.username||zo.username,password:e.password||zo.password,forceturn:"proxy4"!==r,security:"proxy5"===r})));if(o.useP2P){var u;const t=null!==(u=e.uid)&&void 0!==u?u:d.uid,i="glb:".concat(t.toString()),n=await x(i),s=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport||zo.tcpport,udpport:"proxy4"===r?void 0:e.udpport||zo.udpport,username:i,password:n,forceturn:"proxy4"!==r,security:"proxy5"===r})));h.push(...s)}return e.turnServer={mode:"manual",servers:h},t.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(r)),l}async function kR(e,n,s,o,r){const a=g("ACCOUNT_REGISTER").slice(0,g("AJAX_REQUEST_CONCURRENT"));let c=[];c=n.proxyServer?a.map((e=>"https://".concat(n.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):a.map((e=>"https://".concat(e,"/api/v1")));const d=null==r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:c});try{const a=await async function(e,n,s,o,r){const a=Date.now(),c={sid:s.sid,opid:10,appid:s.appId,string_uid:n};let d=e[0];const l=await z((()=>aR(d+"".concat(-1===d.indexOf("?")?"?":"&","action=stringuid"),{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((s,o)=>{if(0===s.code){if(s.uid<=0||s.uid>=Math.pow(2,32))throw t.error("Invalid Uint Uid ".concat(n," => ").concat(s.uid),s),i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:h.INVALID_UINT_UID_FROM_STRING_UID,extend:c}),new ET(h.INVALID_UINT_UID_FROM_STRING_UID);return i.reqUserAccount(c.sid,{lts:a,success:!0,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:null,extend:c}),!1}const r=_g(s.code);return r.retry&&(d=e[(o+1)%e.length]),i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:r.desc,extend:c}),r.retry}),((t,n)=>t.code!==h.OPERATION_ABORTED&&(i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:null,errorCode:t.code,extend:c}),d=e[(n+1)%e.length],!0)),r);if(0!==l.code){const e=_g(l.code);throw new ET(h.UNEXPECTED_RESPONSE,e.desc)}return l}(c,e,n,s,o);return null==r||r.recordJoinChannelService({status:"success",endTs:Date.now()},d),a.uid}catch(e){throw null==r||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},d),e}}async function MR(e,t,n){const s=g("CDS_AP").slice(0,g("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((i=>function(e,t,i,n){const s=Q(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:H,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return z((()=>aR(e,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==h.OPERATION_ABORTED),n)}(i,e,t,n)));let o=null,r=null,a={};try{o=await OR(s)}catch(e){if(e.code===h.OPERATION_ABORTED)throw e;r=e}s.forEach((e=>e.cancel()));if(i.reportApiInvoke(e.sid,{name:J.REQUEST_CONFIG_DISTRIBUTE,options:{error:r,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{var i;const s=Qg(i=e.slice(4)).call(i),o=JSON.parse(t[e])[1];n[s]=o})),n}(o)}catch(e){}return a}async function UR(e,n,s,o){const r=g("PROXY_SERVER_TYPE3"),a=(e,t,i)=>{let n=i||r;return Array.isArray(n)&&(n=t%2==0?r[1]:r[0]),"https://".concat(n,"/ap/?url=").concat(e)};let c=null;const d=[],l=async()=>{const i=g("WEBCS_DOMAIN").slice(0,g("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:cR(),serviceIds:[Kg.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?Kg.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?Kg.CLOUD_PROXY:Kg.CLOUD_PROXY_FALLBACK]}})),r=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),c=await PR({fragementLength:g("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),IR(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},u=async()=>{if(await N(1e3),null!==c)return c;const i=g("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:cR(),serviceIds:[Kg.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?Kg.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?Kg.CLOUD_PROXY:Kg.CLOUD_PROXY_FALLBACK]}})),r=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),l=await PR({fragementLength:g("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),IR(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},r),l};let p,_,E;try{({gatewayInfo:p,proxyInfo:_,url:E}=await OR([l(),u()]))}catch(e){throw e[0]}if(d.length&&d.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!p||!_)throw new ET(h.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=E,"disabled"!==e.cloudProxyServer&&Array.isArray(r)&&E){const n=/^https?:\/\/(.+?)(\/.*)?$/.exec(E)[1];Ho(r).call(r,n)&&(e.proxyServer=n,t.setProxyServer(n),i.setProxyServer(n))}return c={gatewayInfo:p,proxyInfo:await rC(_,p.uid)},c}async function xR(e,t,i,n){const s=g("UAP_AP").slice(0,g("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await gR(s,e,t,i,n)}async function VR(e,i,n){const s=g("UAP_AP").slice(0,g("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((s=>function(e,i,n,s){const o={command:"convergeAllocateEdge",sid:i.sid,appId:i.appId,token:i.token,ts:Date.now(),version:H,cname:i.cname,uid:i.uid.toString(),requestId:CR,seq:CR};CR+=1;const r={service_name:"tele_channel",json_body:JSON.stringify(o)};return z((async()=>{const i=await aR(e,{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==i.code){const e=new ET(h.UNEXPECTED_RESPONSE,"cross channel ap error, code"+i.code,{retry:!0});throw t.error(e.toString()),e}const s=JSON.parse(i.json_body);if(200!==s.code){const e=new ET(h.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(s.code,", reason: ").concat(s.reason));throw t.error(e.toString()),e}if(!s.servers||0===s.servers.length){const e=new ET(h.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw t.error(e.toString()),e}return{vid:s.vid,workerToken:s.workerToken,addressList:(g("CHANNEL_MEDIA_RELAY_SERVERS")||s.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(g("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==h.OPERATION_ABORTED&&e.code!==h.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),s)}(s,e,i,n)));try{const e=await OR(s);return s.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function FR(e,i,n){let s=null;const o=[],r=async r=>{const a=g(r?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return r&&(await N(1e3),null!==s)?s:await PR({fragementLength:g("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(r?"backup":""," choose_server:"),s),function(e,i,n,s){const[o]=bR(i,[Kg.CHOOSE_SERVER]);let r=A.networkState;return z((async()=>{r&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await AS.race([A.onlineWaiter,N(s&&s.maxRetryTimeout||Z.maxRetryTimeout)]),r=A.networkState;const t=await aR(e,{data:o,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return AR(t,e)}),(()=>!1),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.UPDATE_TICKET_FAILED?e.data.retry:(t.warning("[".concat(i.clientId,"] update ticket network error, retry"),e),!0))),s)}(s,e,i,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:o})};try{return s=await OR([r(!1),r(!0)]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}function jR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function BR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jR(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class GR extends T{get isSuccess(){return!!this.configs}constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new v("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),g("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),g("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){if(!this.mutex.isLocked)return;(await this.mutex.lock())()}async updateConfigDistribute(){if(!this.mutableParamsRead){this.mutableParamsRead=!0;i.reportApiInvoke(null,{options:void 0,name:J.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:X.TRACER}).onSuccess(JSON.stringify(d))}if(!this.joinInfo||!this.cancelToken||!this.retryConfig)return void t.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await MR(this.joinInfo,this.cancelToken,this.retryConfig),t.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const i=new ET(h.NETWORK_RESPONSE_ERROR,e);t.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(BT.UPDATE_BITRATE_LIMIT,e):this.emit(BT.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&BR({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var i;const n=ZC(i=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(i);for(let t=0;t<n.length;t++)for(let i=n.length-1;i>t;i--){const t=n[i];if("number"==typeof e[t].__priority){const s=e[t].__priority,o=n[i-1];if("number"==typeof e[o].__priority){if(!(s>e[o].__priority))continue;{const e=t;n[i]=n[i-1],n[i-1]=e}}else{const e=t;n[i]=n[i-1],n[i-1]=e}}}const s={};n.forEach((t=>{const i=e[t],n=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(s,e)||(s[e]=BR({value:i[e]},n&&{expires:n}))}))}));try{!function(e){try{const i=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(c,n)){const{value:s,expires:o}=e[n];if(o&&o<=i)return;d[n]=s,c[n]=s,t.debug("Update global parameters from config distribute",n,s)}}}))}catch(i){t.error("Error update config immediately: ".concat(e),i.message)}}(s);const e=JSON.stringify(s),i=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",i),t.debug("Caching global parameters ".concat(e))}catch(e){t.error("Error caching global parameters:",e.message)}}}class WR extends T{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(g("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){var s;const i=Ho(s=n.result).call(s,!0);n.isPrevNormal&&!i&&this.emit("exception",HR[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",HR[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof Fe&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=iC(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof Fe&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const HR={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};const KR=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function qR(e,t){this.v=e,this.k=t}function YR(e){return new qR(e,0)}var JR=yS,XR=Nm;Ks({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=XR.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var zR=Nm,QR=lm;Ks({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=zR.f(this),i=QR(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var ZR=St(JR),$R=oc.f("asyncIterator"),eI=St($R);function tI(e){var t,i;function n(t,i){try{var o=e[t](i),r=o.value,a=r instanceof qR;ZR.resolve(a?r.v:r).then((function(i){if(a){var c="return"===t?"return":"next";if(!r.k||i.done)return n(c,i);i=e[c](i).value}s(o.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new ZR((function(o,r){var a={key:e,arg:s,resolve:o,reject:r,next:null};i?i=i.next=a:(t=i=a,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}function iI(e){return function(){return new tI(e.apply(this,arguments))}}tI.prototype["function"==typeof ip&&eI||"@@asyncIterator"]=function(){return this},tI.prototype.next=function(e){return this._invoke("next",e)},tI.prototype.throw=function(e){return this._invoke("throw",e)},tI.prototype.return=function(e){return this._invoke("return",e)};var nI=uo("Array").keys,sI=wo,oI=En,rI=At,aI=nI,cI=Array.prototype,dI={DOMTokenList:!0,NodeList:!0},lI=St((function(e){var t=e.keys;return e===cI||rI(cI,e)&&t===cI.keys||oI(dI,sI(e))?aI:t})),hI=St(Si.Object.getOwnPropertySymbols),uI=Ks,pI=co.indexOf,_I=MS,EI=jt([].indexOf),mI=!!EI&&1/EI([1],1,-0)<0;uI({target:"Array",proto:!0,forced:mI||!_I("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return mI?EI(this,e,t)||0:pI(this,e,t)}});var fI=uo("Array").indexOf,SI=At,TI=fI,gI=Array.prototype,CI=St((function(e){var t=e.indexOf;return e===gI||SI(gI,e)&&t===gI.indexOf?TI:t})),RI=un,II=pa;Ks({target:"Object",stat:!0,forced:Tt((function(){II(1)}))},{keys:function(e){return II(RI(e))}});var vI=St(Si.Object.keys);function yI(e,t){if(null==e)return{};var i,n,s=function(e,t){if(null==e)return{};var i,n,s={},o=vI(e);for(n=0;n<o.length;n++)i=o[n],CI(t).call(t,i)>=0||(s[i]=e[i]);return s}(e,t);if(hI){var o=hI(e);for(n=0;n<o.length;n++)i=o[n],CI(t).call(t,i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}var AI={exports:{}};AI.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>R,Printer:()=>w,parse:()=>P,print:()=>D});const n="\n",s="".concat("\r").concat(n),o=" ";let r;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="Â"&&e<="Ã¿"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function _(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"Ã¿"}function E(e){return u(e)||a(e)||"+"===e||"/"===e}function m(e){return a(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function f(e){return u(e)||a(e)||"+"===e||"/"===e}function S(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function T(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?S(Object(i),!0).forEach((function(t){g(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):S(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function g(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(r||(r={}));class C{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&a(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;a(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&a(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);a(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,a),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class R extends C{constructor(){super(),g(this,"records",[]),g(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),r=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),_=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:r,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:_}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new v;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,_)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new y(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,_)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===r.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===r.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,a);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==r.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==r.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===r.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==r.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===r.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===r.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===r.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),r=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:o,attributes:r})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t,...i){const n=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,n);return e.cur=n,s}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class I extends C{constructor(...e){super(...e),g(this,"attributes",void 0),g(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[o,r]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof r&&s.length>r)throw new Error("error in length, should be less or equal than ".concat(r," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t,...i){if(!e.attValue)throw new Error("Nothing to extract from attValue.");const n=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,n);return e._cur=n,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,E,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,E,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,E));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o),s=T(T({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class v extends I{constructor(...e){super(...e),g(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,f),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==o&&_(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,o);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class y extends I{constructor(e){super(),g(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,E,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:r,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function A(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class w{constructor(){A(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new N(this.eol).print(e)}printMediaAttributes(e){return new O(this.eol).print(e)}}class b{constructor(e){A(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class N extends b{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class O extends b{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(o),n=t;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function P(e){return(new R).parse(e)}function D(e,t){return(new w).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();var wI=AI.exports;function bI(e){if(Array.isArray(e))return e.map((e=>e));if(!NI(e))return e;const t={};for(const i in e){const n=e[i];NI(n)||Array.isArray(n)?t[i]=bI(n):t[i]=n}return t}function NI(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class OI{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const PI={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},DI={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:PI,remoteCandidate:PI}},LI={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},kI={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},MI={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},UI={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function xI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function VI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?xI(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):xI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class FI{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=bI(DI),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new AS((e=>{e({local:VI({},PI),remote:VI({},PI)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,r=0;for(const a of i)e[a].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[t-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[t-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,o+=d):(s+=c,r+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),e.recvPacketLossRate=s<=0||r<=0?0:r/(s+r)}}function jI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function BI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jI(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class GI extends FI{constructor(){super(...arguments),this._stats=DI,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=bI(DI);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{var t;const i=Ho(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const t=bI(kI);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=bI(LI),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:BI({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=bI(UI);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=bI(MI);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new AS(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}function WI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function HI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?WI(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):WI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class KI extends FI{constructor(){super(...arguments),this._stats=DI,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=bI(DI),this.report.forEach((e=>{switch(e.type){case VS.OUTBOUND:case VS.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===VS.OUTBOUND?"audio"===t||n?this.processAudioOutboundStats(e):("video"===t||i)&&this.processVideoOutboundStats(e):e.type===VS.INBOUND&&("audio"===t||n?this.processAudioInboundStats(e):("video"===t||i)&&this.processVideoInboundStats(e));break}case VS.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case VS.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:HI({},PI),remote:HI({},PI)};return e.forEach((i=>{let n;if(i.type===VS.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===VS.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===VS.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===VS.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===VS.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(HI({},t),HI({},this.stats.selectedCandidatePair.localCandidate)),e.type===VS.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(HI({},t),HI({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=bI(UI),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=bI(LI),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,o=s-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=o,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:HI({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=bI(kI),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new OI(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new OI(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new OI(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,VS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=bI(MI),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,VS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){var i;const n=Array.from(uT(i=this.report).call(i)).find((i=>i.type===t&&i.ssrc===e));return n?n.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,o,r;const a=t?this.report.get(t):void 0,c=null!==(n=null==a?void 0:a.framesSent)&&void 0!==n?n:e.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==a?void 0:a.frameWidth)&&void 0!==s?s:e.frameWidth,l=null!==(o=null==a?void 0:a.frameHeight)&&void 0!==o?o:e.frameHeight,h=null!==(r=null==a?void 0:a.framesPerSecond)&&void 0!==r?r:e.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==h){const e=Date.now(),t=this.lastVideoFramesSent.get(i.ssrc);t&&e-t.lts>=800?(h=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:h})):t?h=t.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(e,t,i){var n,s,o,r,a;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(r=null==c?void 0:c.jitterBufferDelay)&&void 0!==r?r:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){const e=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=p-e.jitterBufferEmittedCount;n>0&&(t=1e3*(u-e.jitterBufferDelay)/n),i.jitterBufferMs=t,i.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var n,s,o,r;const a=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(r=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==r?r:e.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,o,r,a,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,_=null!==(r=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==r?r:e.jitterBufferEmittedCount,E=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,m=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,f=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&_){const e=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=_-e.jitterBufferEmittedCount;n>0&&(t=1e3*(p-e.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:_,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=E;let S=1920;m&&u&&(S=u/m/50,i.receivedFrames=Math.round(u/S)),f&&(i.droppedFrames=Math.round(f/S))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class qI extends FI{updateStats(){return AS.resolve()}}function YI(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new GI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new KI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof AS}(e)?new KI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new qI(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function JI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function XI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?JI(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):JI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function zI(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:o,filterAudioFec:r,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=i;let l=[],h=[],u=[],p=[],_=!1,E=!1;if(wI.parse(e).mediaDescriptions.forEach((e=>{n&&n!==e.attributes.direction||("video"!==e.media.mediaType||_||(h=e.attributes.payloads,p=e.attributes.extmaps,_=!0),"audio"!==e.media.mediaType||E||(l=e.attributes.payloads,u=e.attributes.extmaps,E=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((e=>{var t;return Ho(a).call(a,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0&&(h=h.filter((e=>{var t;return Ho(c).call(c,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")})));const m=g("UNSUPPORTED_VIDEO_CODEC");return m&&m.length>0&&(h=h.filter((e=>!(e.rtpMap&&Ho(m).call(m,e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function QI(e){const t=wI.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function ZI(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const o=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function $I(e,i){const{cname:n}=e;let s;i&&i.ip&&"number"==typeof i.port?(s=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(s.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):s=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const o={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},r={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let a;switch(e.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}return{dtlsParameters:o,iceParameters:r,candidates:s,rtpCapabilities:lv(e.rtpCapabilities),setup:a,cname:n}}function ev(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:o,rtx:r}=e;const a=M(8,"track-"),c={ssrcId:o,attributes:XI({label:a,mslabel:i=i||M(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(n.push(c),void 0!==r){const e={ssrcId:r,attributes:XI({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[o,r]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function tv(e,t){t instanceof je&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!I()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function iv(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function nv(e,t){var i;if(!(t instanceof Be&&t._encoderConfig&&-1===t._hints.indexOf(Ge.SCREEN_TRACK)))return;const n=t._encoderConfig;We().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach((e=>{var t,i;Ho(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))})),We().supportMinBitrate&&!Ho(i=t._hints).call(i,Ge.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach((e=>{var t,i;Ho(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(g("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))}))}function sv(e){if("video"!==e.media.mediaType)return;const t=Q();if(t.name!==ee.SAFARI&&t.os!==te.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function ov(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function rv(e,t,i){if(I())return;if("video"!==e.media.mediaType)return;if(!(t instanceof Be))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!g("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),r={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:$(s.attributes)}),r.ssrcIds.push(s.ssrcId+t),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+t,attributes:$(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,o.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(r)}async function av(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const s=(await n.createOffer()).sdp,{send:o,recv:r,sendrecv:a}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const s=zI(n,e,i,"sendonly"),o=zI(n,e,i,"recvonly"),r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dv(s,o,"videoExtensions",r,a,c),dv(s,o,"videoCodecs",r,a,c),dv(s,o,"audioExtensions",r,a,c),dv(s,o,"audioCodecs",r,a,c),g("RAISE_H264_BASELINE_PRIORITY")){const e=c.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const i=c.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(i<e){t.debug("raising H264 baseline profile priority");const n=c.videoCodecs[e];c.videoCodecs.splice(e,1),c.videoCodecs.splice(i,0,n)}-1!==i&&(a.videoCodecs=a.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==i&&g("FILTER_SEND_H264_BASELINE")&&(r.videoCodecs=r.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}return{send:r,recv:a,sendrecv:c}}(e,i,s);try{n.close()}catch(e){}return{send:o,recv:r,sendrecv:a}}function cv(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=zI(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dv(e,i,"videoExtensions",n,s,o),dv(e,i,"videoCodecs",n,s,o),dv(e,i,"audioExtensions",n,s,o),dv(e,i,"audioCodecs",n,s,o),g("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&(s.videoCodecs=s.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}function dv(e,t,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}}function lv(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,o;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function hv(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function uv(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function pv(e,i,n,s){let o=[];if(e===WT.VIDEO){if(g("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(o=i.videoCodecs.filter((e=>{var t;return Ho(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,s)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===g("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(o)||0===o.length){let e=[];const r=[],a=[];n.videoCodecs.forEach((t=>{var i,n,o;Ho(i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(i,s)&&e.push(t),Ho(n=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(n,"vp8")&&r.push(t),Ho(o=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").call(o,"h264")&&a.push(t)})),0===e.length&&(0!==r.length?(e=r,t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: vp8"))):0!==a.length&&(e=a,t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: h264")))),0!==e.length&&(o=i.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(g("USE_PUB_RTX")){const e=o.map((e=>e.payloadType.toString())),t=i.videoCodecs.filter((t=>t.rtpMap&&"rtx"===t.rtpMap.encodingName&&Ho(e).call(e,t.fmtp&&t.fmtp.parameters.apt||"")));o=[...o,...t]}0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(i.videoCodecs[0].rtpMap&&i.videoCodecs[0].rtpMap.encodingName)),o=i.videoCodecs)}else o=i.audioCodecs.filter((e=>{var t;return Ho(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,s)})),0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),o=i.audioCodecs.filter((e=>{var t;return Ho(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,"opus")})));return o}let _v=class{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,localCapabilities:o,direction:r,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=r===zS.RECEIVE_ONLY?wI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):wI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o;const h=r===zS.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,u=r===zS.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=r===zS.RECEIVE_ONLY?s.send.videoCodecs:pv(WT.VIDEO,h,u,c),_=r===zS.RECEIVE_ONLY?s.send.audioCodecs:pv(WT.AUDIO,h,u,d);for(const e of l.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=p.map((e=>e.payloadType.toString(10))),e.attributes.payloads=p,e.attributes.extmaps=h.videoExtensions,g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:4e4,rtx:g("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=_.map((e=>e.payloadType.toString(10))),e.attributes.payloads=_,e.attributes.extmaps=h.audioExtensions,hv(e),g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return wI.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,i,n,s){i=i.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:r}=ev(t,this.cname,g("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(I()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),s&&(s.twcc||s.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,s),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,n);let i;return-1===t?(i=this.createOrRecycleSendMedia(e,o,r,"sendonly",n,s),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=o,i.attributes.ssrcGroups=r,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,s)),I()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,i.attributes.mid),{needExchangeSDP:!0,mid:i.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,i){const n=[];return e.forEach((e=>{const s=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let r,a=!1;-1===o?(a=!0,r=this.createOrRecycleRecvMedia(e,[],"recvonly",t,i),this.updateBundleMids()):(r=$(this.sessionDesc.mediaDescriptions[o]),r.attributes.direction="recvonly"),n.push({mid:r.attributes.mid,needCreateTransceiver:a})})),n}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:n,port:s,type:o,relatedAddress:r,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=i?i:"",priority:c?c+"":"",connectionAddress:null!=n?n:"",port:s?s+"":"",type:o?o+"":"",relAddr:null!=r?r:"",relPort:a?a+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,n,s){const o=e._mediaStreamTrack.kind,r=this.rtpCapabilities.recv,a=pv(o,r,this.localCapabilities.send,o===WT.AUDIO?s:n),c=o===WT.VIDEO?r.videoExtensions:r.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const h=this.findFirstClosedMedia(o);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const s=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(I()){if(s){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return s&&n.attributes.mid===i}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const i=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&i}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,i,n,s,o){const r=this.rtpCapabilities.send,a=e===WT.VIDEO?r.videoCodecs:r.audioCodecs,c=e===WT.VIDEO?r.videoExtensions:r.audioExtensions;I()&&(s="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:s}};d=this.mungSendMediaDesc(d,o);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,i){const n=$(e);return iv(n),tv(n,t),nv(n,t),sv(n),ov(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return ov(i,t,this.localCapabilities.recv),hv(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const Ev=["sdp"];function mv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function fv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?mv(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):mv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let Sv=class e extends hg{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,n){super(t,i),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.localCandidateAddress=null,this.useXR=g("USE_XR"),this.filter={filterRTX:!g("USE_PUB_RTX")&&!g("USE_SUB_RTX"),filterVideoFec:g("FILTER_VIDEO_FEC"),filterAudioFec:g("FILTER_AUDIO_FEC")},this.extension={useXR:this.useXR},this._isInRestartIce=!1,this.mutex=new v("P2PConnection-mutex"),this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=n?n:zS.SEND_ONLY,this.name=this.direction===zS.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=YI(this.peerConnection,g("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const i=await av(this.filter,this.extension);if(this.localCapabilities=lv(i),e){const{sdp:i}=e,n=yI(e,Ev),s=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=zI(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dv(i,e,"videoExtensions",n,s,o),dv(i,e,"videoCodecs",n,s,o),dv(i,e,"audioExtensions",n,s,o),dv(i,e,"audioCodecs",n,s,o),g("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&g("FILTER_SEND_H264_BASELINE")&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}(this.filter,this.extension,i);this.remoteSDP=new _v({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const r=QI(o.sdp);await this.peerConnection.setLocalDescription(o);const a=await cv(this.filter,this.extension,o.sdp);this.localCapabilities=lv(a);const c=this.peerConnection.getTransceivers()[0];return null!=c&&c.receiver&&c.receiver.transport&&this.tryBindTransportEvents(c.receiver.transport),fv(fv({},r),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=QI(e.sdp);return this.initialOffer=e,fv(fv({},t),{},{sdp:e.sdp})}}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:i,dtlsParameters:n}=e,s=await cv(this.filter,this.extension,t);this.remoteSDP=new _v({remoteIceParameters:i,remoteDtlsParameters:n,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new l(h.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],r=n.remoteSDP.receive(e,t,i);e.forEach(((e,t)=>{if(r[t].needCreateTransceiver){const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)}else{const i=n.peerConnection.getTransceivers().find((e=>e.mid===r[t].mid));if(!i)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(r[t].mid));o.push(i),e._updateRtpTransceiver(i)}})),I()&&!0===g("SIMULCAST")&&(yield YR(n.applySimulcastForFirefox(o,e)));const a=r.map((e=>e.mid)),c=yield YR(n.peerConnection.createOffer()),d=n.mungSendOfferSDP(c.sdp,e,a),l=wI.parse(d),h=a.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return ZI(t,g("USE_PUB_RTX"))})),u=o.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}));yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:d}));try{yield u}catch(e){const t=n.remoteSDP.toString();throw yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield YR(n.peerConnection.setRemoteDescription({type:"answer",sdp:t})),yield YR(n.stopSending(a,!0)),e}yield YR(n.applySimulcastEncodings(o,e)),yield YR(n.applySendEncodings(o,e));const p=n.remoteSDP.toString(),_=n.logSDPExchange(d,"offer","local","send");return null==_||_(p),yield YR(n.setRemoteDescription({type:"answer",sdp:p})),o.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}))}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a||null===a.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===ie.Auto&&(this.store.p2pTransport=ie.SdRtn,We().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,We().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=QI(e.sdp);return this.store.descriptionStart(),this.direction===zS.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===zS.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=QI(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:fv(fv({},PI),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:fv(fv({},PI),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,t;Ho(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;if(e.candidate.candidate)this.localCandidateAddress=e.candidate.address,null===(i=this.onLocalCandidate)||void 0===i||i.call(this,e.candidate.toJSON());this.localCandidateCount+=1}else this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(i,n){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const o={iceServers:[]};var r;i.iceServers?o.iceServers=i.iceServers:i.turnServer&&"off"!==i.turnServer.mode&&(ne(i.turnServer.servers)?o.iceServers=i.turnServer.servers:(o.iceServers&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.servers,n,s)),g("USE_TURN_SERVER_OF_GATEWAY")&&o.iceServers&&i.turnServer.serversFromGateway&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.serversFromGateway,n,s)),Ho(r=[ie.Relay,ie.SdRtn]).call(r,n)&&(o.iceTransportPolicy="relay"),g("FORCE_TURN_TCP")?o.iceTransportPolicy="relay":i.turnServer.servers.concat(i.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(o.iceTransportPolicy="relay")}))));return g("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(o.encodedInsertableStreams=!0),t.debug("P2PConnection p2pTransport is ".concat(n)),o}static turnServerConfigToIceServers(e,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s=[],o=e.filter((e=>e.tcpport));t.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(n));const r=o.length>n?o[n]:o[0];switch(i){case ie.SdRtn:const t=e.filter((e=>{var t;return Ho(t=e.username).call(t,"glb:")&&e.turnServerURL==e.turnServerURL})),i=t.length>n?t[n]:t[0];i&&(s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(eC(i.turnServerURL),":").concat(i.tcpport,"?transport=udp")}),s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(eC(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}));break;case ie.Relay:r&&(s.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=udp")}),s.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(eC(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}));break;default:r&&(s.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=udp")}),s.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(eC(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}),s.push({username:r.username,credential:r.password,credentialType:"password",urls:"stun:".concat(r.turnServerURL,":").concat(r.tcpport)}))}return s}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:e,remote:n}=i.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!We().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){var r;const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),Ho(r=e._hints).call(r,Ge.LOW_STREAM)&&(i&&(o.maxFramerate=iC(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(g("DSCP_TYPE")&&se()){var a;const e=g("DSCP_TYPE");Ho(a=["very-low","low","medium","high"]).call(a,e)&&(o.networkPriority=e)}const c=i.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];I()&&!d&&(s.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(e,i){try{if(!We().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof Be&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=wI.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(tv(o,e),rv(o,e,this.store.codec))})),wI.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof Be&&!Ho(i=d._hints).call(i,Ge.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Be&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof Be&&g("SIMULCAST")&&"vp8"===this.store.codec&&!Ho(t=e._hints).call(t,Ge.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(g("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=wI.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}async setRemoteDescription(e){var t;await this.peerConnection.setRemoteDescription(e),Ho(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){const n=wI.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===WT.AUDIO&&"audio"===s.media.mediaType&&hv(s),this.useXR&&uv(n)),wI.print(n)}};function Tv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function gv(e,i){let n=document.createElement("video"),s=document.createElement("canvas");n.setAttribute("style","display:none"),s.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),s.width=iC(i.width),s.height=iC(i.height);const o=iC(i.framerate||15);document.body.append(n),document.body.append(s);let r=e._mediaStreamTrack;n.srcObject=new MediaStream([r]),n.play();const a=s.getContext("2d");if(!a)throw new ET(h.UNEXPECTED_ERROR,"can not get canvas context");const c=We(),d=s.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];d.canvas||(d.canvas=s),s.startCapture=()=>{if(!n)return s.stopCapture&&s.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,i=n.videoHeight/e,o=s.width*i;Math.abs(o-s.height)>=2&&(t.debug("adjust low stream resolution","".concat(s.width,"x").concat(s.height," -> ").concat(s.width,"x").concat(o)),s.height=o)}a.drawImage(n,0,0,s.width,s.height),d.requestFrame&&d.requestFrame(),r!==e._mediaStreamTrack&&(r=e._mediaStreamTrack,n.srcObject=new MediaStream([r]))},s.stopCapture=Ke((()=>s.startCapture&&s.startCapture()),o);const l=d.stop;return d.stop=()=>{l.call(d),n&&(n.remove(),n.srcObject=null,n=null),s&&(s.width=0,s.remove(),s.stopCapture&&s.stopCapture(),s.startCapture=void 0,s.stopCapture=void 0,s=null),t.debug("clean low stream renderer")},d}var Cv,Rv,Iv,vv,yv,Av,wv,bv,Nv,Ov,Pv;pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],Sv.prototype,"establish",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],Sv.prototype,"connect",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,String]),_T("design:returntype",AS)],Sv.prototype,"receive",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,String]),_T("design:returntype",AS)],Sv.prototype,"mockReceive",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Sv.prototype,"stopReceiving",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],Sv.prototype,"restartICE",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],Sv.prototype,"close",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],Sv.prototype,"updateEncoderConfig",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],Sv.prototype,"updateSendParameters",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[He,String]),_T("design:returntype",AS)],Sv.prototype,"replaceTrack",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Sv.prototype,"muteLocal",null),pT([Tv,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Sv.prototype,"unmuteLocal",null),function(e){e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH"}(Cv||(Cv={})),function(e){e[e.HEIGHT=2072]="HEIGHT",e[e.FRAME_RATE=2074]="FRAME_RATE",e[e.WIDTH=2076]="WIDTH"}(Rv||(Rv={})),function(e){e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM"}(Iv||(Iv={})),function(e){e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH"}(vv||(vv={})),function(e){e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(yv||(yv={})),function(e){e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(Av||(Av={})),function(e){e[e.PCM_LEVEL=2104]="PCM_LEVEL"}(wv||(wv={})),function(e){e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED"}(bv||(bv={})),function(e){e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(Nv||(Nv={})),function(e){e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL"}(Ov||(Ov={})),function(e){e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE"}(Pv||(Pv={}));const Dv=1e3,Lv=3;function kv(e,t,i){null!=i&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function Mv(e){const t={[Pv.CONN_TYPE]:0,[Pv.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t[Pv.CONN_TYPE]=1),"tcp"===i&&(t[Pv.CONN_TYPE]=3),"tls"===i&&(t[Pv.CONN_TYPE]=4);break}case"srflx":t[Pv.CONN_TYPE]=2}return t}class Uv extends T{constructor(e){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,i;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),t||i){const n={};if(this.uploadTransportStarted&&t){const s=this.getTransportStats(t,i,e);s&&(n.misc=[s])}if(this.uploadOutboundStarted&&t){const i=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);i&&(n.outbound=[i])}if(this.uploadInboundStarted&&i){const t=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(n.inbound=t)}this.requestUploadStats(n)}this.lastRecvStats=i,this.lastSendStats=t,e||(this.lastFullRecvStats=i,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==Lv),++e===Lv+1&&(e=1)}),Dv)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,i){if(!this.requestStats)return;if(i)return null==e.rtt?void 0:{addition:{[Pv.RTT]:e.rtt,[Pv.CONN_TYPE]:void 0}};const n=Mv(e);if(this.store.useP2P){if(t){const e=Mv(t);n[Pv.CONN_TYPE]+=e[Pv.CONN_TYPE]<<3}n[Pv.CONN_TYPE]+=110}else n[Pv.CONN_TYPE]+=100;return{addition:n}}getOutboundStats(e,t,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const n=this.requestLocalMedia();if(!n||0===n.length)return;let s,o,r;return n.forEach((n=>{let[a,{track:c,ssrcs:d}]=n;switch(a){case qT.LocalVideoLowTrack:case qT.LocalVideoTrack:if(a===qT.LocalVideoTrack){const n=function(e,t,i,n,s){const o=t.videoSend.find((t=>t.ssrc===e));if(!o)return;const r={},{sentFrame:a,inputFrame:c}=o;if(c&&a){const e=c.frameRate,t=a.frameRate;r[Iv.FREEZE]=function(e,t){let i=!0;return i=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),i}(e,t)?1:0}if(kv(r,Iv.QP_SUM,o.qpSumPerFrame),s)return r;switch(a&&(kv(r,Iv.HEIGHT,a.height),kv(r,Iv.WIDTH,a.width),kv(r,Iv.FRAME_RATE,a.frameRate)),r[Iv.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0,o.adaptionChangeReason){case"none":r[Iv.ADAPTATION]=0;break;case"cpu":r[Iv.ADAPTATION]=1;break;case"bandwidth":r[Iv.ADAPTATION]=2;break;case"other":r[Iv.ADAPTATION]=3}r[Iv.PLAYER_STATUS]=qe[n._player?n._player.videoElementStatus:"uninit"],kv(r,Iv.NACKS,o.nacksCount),kv(r,Iv.PLIS,o.plisCount),kv(r,Iv.FIRS,o.firsCount),kv(r,Iv.AVG_ENCODE,o.avgEncodeMs);const d=i&&i.videoSend.find((t=>t.ssrc===e));if(d){let e=s?Dv:Dv*Lv;d.timestamp&&o.timestamp&&(e=o.timestamp-d.timestamp),null!=d.packets&&null!=o.packets&&kv(r,Iv.PACKAGE_RATE,1e3*(o.packets-d.packets)/e),null!=o.packetsLost&&null!=d.packetsLost&&kv(r,Iv.PACKAGE_LOST,o.packetsLost-d.packetsLost),null!=d.bytes&&null!=o.bytes&&kv(r,Iv.BITRATE,8*(o.bytes-d.bytes)/e)}return r}(d[0].ssrcId,e,t,c,i),s=i?null:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return null;const s={},o=n.inputFrame,r=o&&o.height||i&&i._videoHeight||0,a=o&&o.width||i&&i._videoWidth||0,c=o&&o.frameRate||0;return kv(s,Cv.HEIGHT,r),kv(s,Cv.WIDTH,a),kv(s,Cv.FRAME_RATE,c),s}(d[0].ssrcId,e,c),r=i?null:function(e){const t={};return kv(t,Iv.RETRANSMIT,e.bitrate.retransmit),kv(t,Iv.TARGET_ENCODED,e.bitrate.targetEncoded),kv(t,Iv.ACTUAL_ENCODED,e.bitrate.actualEncoded),kv(t,Iv.TRANSMIT,e.bitrate.transmit),kv(t,Iv.BANDWIDTH,e.sendBandwidth),t}(e);o=Object.assign({},n,s,r)}else r=i?void 0:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return;const s={},o=n.sentFrame;if(o&&(kv(s,vv.HEIGHT,o.height),kv(s,vv.WIDTH,o.width),kv(s,vv.FRAME_RATE,o.frameRate)),i){const t=i.videoSend.find((t=>t.ssrc===e));if(t){let e=Dv*Lv;t.timestamp&&n.timestamp&&(e=n.timestamp-t.timestamp),null!=t.packets&&null!=n.packets&&kv(s,vv.PACKAGE_RATE,1e3*(n.packets-t.packets)/e),null!=n.packetsLost&&null!=t.packetsLost&&kv(s,vv.PACKAGE_LOST,n.packetsLost-t.packetsLost),null!=t.bytes&&null!=n.bytes&&kv(s,vv.BITRATE,8*(n.bytes-t.bytes)/e)}}return s}(d[0].ssrcId,e,t);break;case qT.LocalAudioTrack:s=i?void 0:function(e,t,i,n){const s=t.audioSend.find((t=>t.ssrc===e));if(!s)return;const o={};o[bv.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0;const r=n._source.getAccurateVolumeLevel(),a=s.inputLevel;kv(o,bv.LEVEL,100*(null==a?r:a)),kv(o,wv.PCM_LEVEL,100*r),kv(o,bv.AEC_RETURN_LOSS,s.aecReturnLoss),kv(o,bv.AEC_RETURN_LOSS_ENH,s.aecReturnLossEnhancement),o[bv.FREEZE]=0;const c=i&&i.audioSend.find((t=>t.ssrc===e));if(c){let e=Dv*Lv;c.timestamp&&s.timestamp&&(e=s.timestamp-c.timestamp),null!=c.bytes&&null!=s.bytes&&kv(o,bv.BITRATE,8*(s.bytes-c.bytes)/e),null!=c.packets&&null!=s.packets&&kv(o,bv.PACKAGE_RATE,1e3*(s.packets-c.packets)/e)}return o}(d[0].ssrcId,e,t,c)}})),{high:o,low:r,audio:s}}getInboundStats(e,t,i){if(!this.requestRemoteMedia)return;const n=this.requestRemoteMedia()||[],s=[];return n.forEach((n=>{let[o,r]=n;const a={peer:o.uid};if(r.has(WT.VIDEO)&&o.videoTrack){const n=o._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(o._videoSSRC)||!1,s=o.videoTrack?function(e,t,i,n,s,o,r){const a=t.videoRecv.find((t=>t.ssrc===e));if(!a)return;const c={},{receivedFrame:d,outputFrame:l,decodeFrameRate:h}=a,u=i&&i.videoRecv.find((t=>t.ssrc===e));if(c[yv.FREEZE]=s&&qv.isRemoteVideoFreeze(n,a,u)?1:0,kv(c,Av.FRAME_RATE_DECODE,h),kv(c,yv.QP_SUM,a.qpSumPerFrame),a.framesRateFirefox&&kv(c,yv.FRAME_RATE,a.framesRateFirefox),d&&kv(c,yv.FRAME_RATE,d.frameRate),u){const e=t.timestamp-i.timestamp||(r?Dv:Lv*Dv);null!=a.packetsLost&&null!=u.packetsLost&&kv(c,yv.PACKAGE_LOST,a.packetsLost-u.packetsLost),null!=u.bytes&&null!=a.bytes&&kv(c,yv.BITRATE,8*(a.bytes-u.bytes)/e),null!=u.packets&&null!=a.packets&&kv(c,yv.PACKAGE_RATE,1e3*(a.packets-u.packets)/e)}if(r)return c;if(d?(kv(c,yv.HEIGHT,d.height),kv(c,yv.WIDTH,d.width)):n&&(kv(c,yv.HEIGHT,n._videoHeight||0),kv(c,yv.WIDTH,n._videoWidth||0)),l&&kv(c,Av.FRAME_RATE_RENDER,l.frameRate),kv(c,yv.JITTER_BUFFER,a.jitterBufferMs),kv(c,yv.CURRENT_DELAY,a.currentDelayMs),kv(c,yv.FIRS,a.firsCount),kv(c,yv.NACKS,a.nacksCount),kv(c,yv.PLIS,a.plisCount),n){c[yv.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1;const e=n._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:i}=e;if(t&&t.length>0&&kv(c,Av.FREEZE_TIME,t.splice(0,1)[0]),o&&"visible"===Ye.visibility){const t=Math.min(6e3,i);e.renderFreezeAccTime=Math.max(0,i-t),kv(c,Av.FREEZE_TIME_RENDER,t)}}}if(c[yv.PLAYER_STATUS]=qe[n._player?n._player.videoElementStatus:"uninit"],u&&void 0!==a.totalInterFrameDelay&&void 0!==a.totalSquaredInterFrameDelay&&void 0!==u.totalInterFrameDelay&&void 0!==u.totalSquaredInterFrameDelay){const e=a.totalInterFrameDelay-u.totalInterFrameDelay,t=a.totalSquaredInterFrameDelay-u.totalSquaredInterFrameDelay,i=a.framesDecodeCount-u.framesDecodeCount,n=e/i*1e3,s=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/i)/i));!isNaN(s)&&n+s>Math.max(3*n,n+150)&&(c[yv.I_FRAME_DELAY]=s)}return c}(o._videoSSRC,e,t,o.videoTrack,!0===n,this.needUploadRenderFreezeTime,i):void 0;s&&(a.video=s)}if(r.has(WT.AUDIO)&&o.audioTrack){const n=o.audioTrack?function(e,t,i,n,s){const o=t.audioRecv.find((t=>t.ssrc===e));if(!o)return;const r={},a=i&&i.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:d}=o;var l,h;if(kv(r,Nv.JITTER,o.jitterMs),null!=c&&null!=d&&(r[Nv.FREEZE]=(h=d,0===(l=c)||100*h/l>20?1:0)),a){const e=t.timestamp-i.timestamp||(s?Dv:Dv*Lv);null!=o.packets&&null!=a.packets&&kv(r,Nv.PACKAGE_RATE,1e3*(o.packets-a.packets)/e),null!=a.bytes&&null!=o.bytes&&kv(r,Nv.BITRATE,8*(o.bytes-a.bytes)/e),null!=o.packetsLost&&null!=a.packetsLost&&kv(r,Nv.PACKAGE_LOST,o.packetsLost-a.packetsLost)}if(s)return r;const u=n._source.getAccurateVolumeLevel(),p=o.outputLevel;if(kv(r,Ov.LEVEL,100*(null==p?u:p)),kv(r,Nv.PCM_LEVEL,100*u),n&&(r[Nv.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1),kv(r,Nv.JITTER_BUFFER,o.jitterBufferMs),kv(r,Nv.CURRENT_DELAY,o.jitterBufferMs),r[Nv.PLAYER_STATUS]=qe[Je.getPlayerState(n.getTrackId())],a){const e=o.concealedSamples-a.concealedSamples;e>0&&kv(r,Nv.CONCEALED_SAMPLES,e)}return r}(o._audioSSRC,e,t,o.audioTrack,i):void 0;n&&(a.audio=n)}(a.video||a.audio)&&s.push(a)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof Xe));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(YS.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{if(!this.requestUpload||!this.requestRemoteMedia)return;(this.requestRemoteMedia()||[]).forEach((e=>{let[t,i]=e;if(i.has(WT.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}if(i.has(WT.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),i={connectionInterval:g("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let n=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of s)!e.muted&&e.enabled&&(n=n.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,t]of o)t.has(WT.VIDEO)&&e.videoTrack&&(n=n.concat(await e.videoTrack.getProcessorUsage())),t.has(WT.AUDIO)&&e.audioTrack&&(n=n.concat(await e.audioTrack.getProcessorUsage()));if(0===n.length)return;i.details=function(e,t){const i={};for(const{id:r,value:a,level:c,direction:d}of e){var n;const e=null!==(n=t.get(r))&&void 0!==n?n:0,l=2===a?e+g("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,o;t.set(r,l),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===d&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(s=t.get(r))&&void 0!==s?s:0):i[r]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(n,e);const r=Date.now(),a=r>t?r:t+1;this.requestUpload&&this.requestUpload(YS.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:a})}),g("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class xv{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=e,this._uintid=t}}var Vv;function Fv(e,t){var i;let n;switch(t){case qT.LocalAudioTrack:n=PT.Audio;break;case qT.LocalVideoTrack:n=Ho(i=e._hints).call(i,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:n=PT.Low}return n}function jv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Bv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?jv(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):jv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}!function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(Vv||(Vv={}));class Gv extends T{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(JT.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new v("P2PChannel2-send-mutex"),this.recvMutex=new v("P2PChannel2-recv-mutex"),this._state=YT.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==YT.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const r=this.filterTobeMutedTracks(e);if(0===r.length)return void t();const a=r.find((e=>"videoLowTrack"===e[0]));if(a){a[1].track._originMediaStreamTrack.stop()}await this.sendConnection.muteLocal(r.map((e=>{let[,{id:t}]=e;return t})));let c=!1;var s,o;if("video"===e.trackMediaType)c=!(null===(s=this.localTrackMap.get(qT.LocalAudioTrack))||void 0===s||!s.track._muted);else c=void 0===(null===(o=this.localTrackMap.get(qT.LocalVideoTrack))||void 0===o?void 0:o.id);const d=this.createMuteMessage(r);await oe(this,JT.RequestMuteLocal,d);const u="video"===e.trackMediaType?cg.MUTE_LOCAL_VIDEO:cg.MUTE_LOCAL_AUDIO;await oe(this,JT.RequestP2PMuteLocal,{action:u,message:d,isMuteAll:c}),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==YT.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();await this.sendConnection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(s),r="video"===e.trackMediaType?cg.UNMUTE_LOCAL_VIDEO:cg.UNMUTE_LOCAL_AUDIO;await oe(this,JT.RequestP2PMuteLocal,{action:r,message:o}),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(qT.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==YT.Connected)return void t();const{id:s,track:o}=i;s&&(await this.sendConnection.updateSendParameters(s,o),await this.sendConnection.updateEncoderConfig(s,o),this.emit(JT.UpdateVideoEncoder,o)),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const i=this.localTrackMap.get(qT.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==YT.Connected)return;const{id:s,track:o}=i;s&&await this.sendConnection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var r;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!t||void 0===t[1].id||this.state!==YT.Connected)return void i();if(await(null===(r=this.sendConnection)||void 0===r?void 0:r.replaceTrack(e,t[1].id)),t[0]===qT.LocalVideoTrack&&We().supportDualStreamEncoding){const t=this.localTrackMap.get(qT.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new AS(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new Uv(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),g("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new l(h.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,i,n,s,o){throw new l(h.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,i){let n;try{if(i){this.recvConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Sv(e,this.store,zS.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const s=await this.recvConnection.establish(i);return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}{this.state=YT.New,this.sendConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Sv(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=YT.Connected}async addRemoteCandidate(e,t){if(t===zS.RECEIVE_ONLY){if(!this.sendConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==YT.Connected){n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,KR.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield YR(n.tryToUnmuteAudio(e)));o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===qT.LocalAudioTrack?"audio":"video",s)})),n.bindLocalTrackEvents(o);const r=yield YR(n.sendConnection.send(o.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),a=(yield YR(r.next())).value,c=n.createGatewayPublishMessage(o,a);try{yield c}catch(e){throw r.throw(e),(null==e?void 0:e.code)===h.WS_ABORT&&o.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(o),e}yield YR(r.next()),o.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(o,a),o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===qT.LocalAudioTrack?"audio":"video",void 0,s)})),n.startUploadUplinkState()}finally{s()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==YT.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!Ho(e).call(e,t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}const n=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===YT.Connected){if(i){i[1].track.close()}return n}e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[n,{track:s,ssrcs:o}]=i;const r={stream_type:Fv(s,n),ssrcs:o};s._muted||!s._enabled?e.push(r):t.push(r)})),e.length>0&&e.forEach((e=>{oe(this,JT.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{oe(this,JT.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return iI((function*(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await O(this,JT.RequestRePublish,this.pendingLocalTracks),this.emit(JT.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,i,n,s){var o;if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(i))return;const{track:r,mid:a,transceiver:c}=await this.recvConnection.receive(i,[{ssrcId:n}],String(e.uid),s);i===WT.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(r):(e._audioTrack=new ze(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(r):(e._videoTrack=new Qe(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(i,a):this.remoteUserMap.set(e,new Map([[i,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==u&&(this.pendingRemoteTracks.splice(u,1),this.emit(JT.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,n){if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),n)}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===WT.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===WT.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const s=this.filterTobeUnSubscribedTracks(e,t);0!==s.length&&(await this.recvConnection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===WT.VIDEO&&t._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===WT.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===WT.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),s.forEach((e=>{let[,{kind:t}]=e;oe(this,JT.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[WT.VIDEO,WT.AUDIO].forEach((e=>{t.has(e)?oe(this,JT.RequestP2PUnmuteRemote,e):oe(this,JT.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===WT.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(qT.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Fe){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==qT.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===qT.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===qT.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(qT.LocalAudioTrack),r=s?this.localTrackMap.get(qT.LocalVideoLowTrack):this.localTrackMap.get(qT.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:KR.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(Ge.SCREEN_TRACK)),audio:!!n,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var r;n||(n=[]);const a=n.find((e=>e instanceof je)),c=s?null===(r=this.localTrackMap.get(qT.LocalVideoTrack))||void 0===r?void 0:r.track:n.find((e=>e instanceof Be));i.publish(this.store.sessionId,{eventElapse:KR.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==a?void 0:a.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(Ge.SCREEN_TRACK)),audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===WT.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===WT.VIDEO,audio:s===WT.AUDIO,peerid:n.uid,subscribeRequestid:s===WT.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:KR.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new v("P2PChannel2-send-mutex"),this.sendMutex=new v("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(qT.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Fe){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=YT.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(qT.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Be||t&&t.track instanceof je?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(qT.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=ZC(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=YT.Reconnecting,g("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[i,{track:n}]=e;switch(i){case qT.LocalVideoTrack:Ho(t=n._hints).call(t,Ge.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case qT.LocalAudioTrack:n instanceof Fe?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case qT.LocalVideoLowTrack:}})),this.emit(JT.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(lI(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(JT.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof xv?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,n;if(e===zS.SEND_ONLY){if(!this.sendConnection)throw new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(t){const e=await n.restartICE(t);return n.isInRestartIce=!1,e}{const e=await n.restartICE();if(e){const t=await O(this,JT.RequestP2PRestartICE,{direction:zS.RECEIVE_ONLY,iceParameter:e});await n.restartICE(t),n.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(qT.LocalVideoTrack),i=this.localTrackMap.get(qT.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!s)return 1;const o=P(this,JT.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(Ge.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return Qo[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=P(this,JT.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new AS(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=We(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=re(e);let r=!1,a=!1;for(const o of e){if(o instanceof Be&&(this.localTrackMap.has(qT.LocalVideoTrack)||r?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:qT.LocalVideoTrack}),r=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:qT.LocalVideoLowTrack})}if(o instanceof je){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(e){if(!(e.track instanceof Fe))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===qT.LocalAudioTrack}));if(!(e.track instanceof Fe))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Fe||o._bypassWebAudio)n.push({track:o,type:qT.LocalAudioTrack});else{const e=new Fe;e.addAudioTrack(o),n.push({track:e,type:qT.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=re(e);for(const i of e){if(i instanceof je){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(!e)continue;e.track instanceof Fe?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([qT.LocalAudioTrack,e]),e.track.close())):t.push([qT.LocalAudioTrack,e])}if(i instanceof Be){const e=this.localTrackMap.get(qT.LocalVideoTrack);if(!e)continue;t.push([qT.LocalVideoTrack,e]);const i=this.localTrackMap.get(qT.LocalVideoLowTrack);i&&t.push([qT.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case qT.LocalVideoTrack:t.addListener(Ze.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ze.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Ze.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case qT.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case qT.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Fe?e.trackList.forEach((e=>{e.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Ze.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(Ze.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case qT.LocalVideoTrack:t.off(Ze.GET_STATS,this.handleGetLocalVideoStats),t.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Ze.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Ze.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case qT.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case qT.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Fe?e.trackList.forEach((e=>{e.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ze.GET_STATS,this.handleGetLocalAudioStats),e.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(Ze.GET_STATS,this.handleGetLocalAudioStats),e.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Qe&&t.addListener(Ze.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ze&&t.addListener(Ze.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Ze.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(WT.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(WT.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{var n;let s,{track:o,type:r}=e;switch(r){case qT.LocalAudioTrack:s=PT.Audio;break;case qT.LocalVideoTrack:s=Ho(n=o._hints).call(n,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:s=PT.Low}return{kind:r===qT.LocalAudioTrack?WT.AUDIO:WT.VIDEO,stream_type:s,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{var n;t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(i,")")),this.emit(JT.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(e.isInRestartIce=!1),Ho(n=this._restartStates).call(n,i)&&!e.isInRestartIce&&("disconnected"===i&&await N(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(JT.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var r;o&&(this.store.subscribe(o.uid,"audio",void 0,void 0,void 0,Date.now()),null===(r=o.audioTrack)||void 0===r||r.emit($e.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(JT.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(JT.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const i=e===zS.SEND_ONLY?this.sendConnection:this.recvConnection;i&&!i.isInRestartIce&&(i.isInRestartIce=!0,t.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(i.name,"] start use restartICE")),e===zS.SEND_ONLY?this.restartICE(e):O(this,JT.RequestP2PRestartICE,{direction:zS.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(qT.LocalAudioTrack);if(e instanceof je&&(null==i?void 0:i.track)instanceof Fe)return i.track.isActive||t.push([qT.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===qT.LocalVideoTrack)){const e=this.localTrackMap.get(qT.LocalVideoLowTrack);e&&t.push([qT.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(qT.LocalAudioTrack);if(e instanceof je&&(null==i?void 0:i.track)instanceof Fe)return i.track.isActive&&t.push([qT.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===qT.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(qT.LocalVideoLowTrack);e&&t.push([qT.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case WT.VIDEO:return void(i._videoSSRC&&t.push({stream_type:WT.VIDEO,ssrcId:i._videoSSRC}));case WT.AUDIO:return void(i._audioSSRC&&t.push({stream_type:WT.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(qT.LocalVideoTrack),i=this.localTrackMap.get(qT.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof je){const i=this.filterTobeUnmutedTracks(e[t]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await oe(this,JT.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(JT.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(JT.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await N(b(this.dtlsFailedCount,Z)),this.emit(JT.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(qT.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof Be))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof Be)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof je)).length>1&&(e.some((e=>e instanceof je&&e._bypassWebAudio))||!We().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Be&&this.pendingLocalTracks.some((e=>e instanceof Be)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof je&&this.pendingLocalTracks.some((e=>e instanceof je))&&(!We().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof je&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!g("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding,n=Bv(Bv({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():gv(e,n);const o=M(8,"track-low-"),r=new Be(s,Bv(Bv({},i&&{scaleResolutionDownBy:aC(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(et.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,tt.LOW_STREAM)})),r._hints.push(Ge.LOW_STREAM),e.addListener(Ze.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,o,r){var a;const c=Array.from(lI(a=this.remoteUserMap).call(a)).find((t=>t._videoSSRC===e));if(c){r||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find((e=>e.userId===c.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:o,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===YT.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async preConnect(e,t,i,n,s,o){throw new l(h.NOT_SUPPORTED)}getEstablishParams(){throw new l(h.NOT_SUPPORTED)}async reSubscribe(e){throw new l(h.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new l(h.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===qT.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,tt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}function Wv(e){return function(t,i,n){const s=t[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];switch(e){case Vv.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}case Vv.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e(),t()}}}},n}}function Hv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Kv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Hv(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Hv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}pT([Wv(Vv.SEND_ONLY),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],Gv.prototype,"p2pConnect",null),pT([Wv(Vv.SEND_ONLY),_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Gv.prototype,"unpublish",null),pT([Wv(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],Gv.prototype,"unpublishLowStream",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String,Number,String]),_T("design:returntype",AS)],Gv.prototype,"subscribe",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String,Number,String]),_T("design:returntype",AS)],Gv.prototype,"mockSubscribe",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String,Boolean]),_T("design:returntype",AS)],Gv.prototype,"unsubscribe",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Gv.prototype,"muteRemote",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Gv.prototype,"unmuteRemote",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Gv.prototype,"hasRemoteMediaWithLock",null),pT([Wv(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],Gv.prototype,"disconnectForReconnect",null),pT([Wv(Vv.RECEIVE_ONLY),_T("design:type",Function),_T("design:paramtypes",[xv,String,Number]),_T("design:returntype",AS)],Gv.prototype,"remoteMediaSsrcChanged",null);class qv{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=xS.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new WR,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(qT.LocalAudioTrack)||Kv({},it)}getLocalVideoTrackStats(){return this.localStats.get(qT.LocalVideoTrack)||Kv({},nt)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(qT.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(qT.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const r=this.localStats.get(qT.LocalVideoLowTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?KR.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?KR.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&t.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((i=>{let[n,s]=i;switch(n){case qT.LocalVideoTrack:case qT.LocalVideoLowTrack:{const i=s,r=Kv({},nt),a=e.getStats(),c=e.getLocalMedia(n);if(a){const n=a.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(n){const s=e.getLocalVideoSize(),o=e.getEncoderConfig(qT.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(r.codecType=n.codec),r.sendBytes=n.bytes,r.sendBitrate=i?8*Math.max(0,r.sendBytes-i.sendBytes):0,n.inputFrame?(r.captureFrameRate=n.inputFrame.frameRate,r.captureResolutionHeight=n.inputFrame.height,r.captureResolutionWidth=n.inputFrame.width):s&&(r.captureResolutionWidth=s.width,r.captureResolutionHeight=s.height),n.sentFrame?(r.sendFrameRate=n.sentFrame.frameRate,r.sendResolutionHeight=n.sentFrame.height,r.sendResolutionWidth=n.sentFrame.width):s&&(r.sendResolutionWidth=s.width,r.sendResolutionHeight=s.height),n.avgEncodeMs&&(r.encodeDelay=n.avgEncodeMs),o&&o.bitrateMax&&(r.targetSendBitrate=1e3*o.bitrateMax),r.sendPackets=n.packets,r.sendPacketsLost=n.packetsLost,r.sendJitterMs=n.jitterMs,r.sendRttMs=n.rttMs,r.totalDuration=i?i.totalDuration+1:1,r.totalFreezeTime=i?i.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(r.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(t.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(r.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;if(this.localStats.set(n,r),(null==i?void 0:i.sendResolutionWidth)!==r.sendResolutionWidth||(null==i?void 0:i.sendResolutionHeight)!==r.sendResolutionHeight)null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:r.sendResolutionWidth,height:r.sendResolutionHeight});r&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,r);break}case qT.LocalAudioTrack:{const t=s,i=Kv({},it),o=e.getStats(),r=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==r?void 0:r.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(i.codecType=n.codec),n.inputLevel)i.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(i.sendVolumeLevel=Math.round(32767*t))}i.sendBytes=n.bytes,i.sendPackets=n.packets,i.sendPacketsLost=n.packetsLost,i.sendJitterMs=n.jitterMs,i.sendRttMs=n.rttMs,i.sendBitrate=t?8*Math.max(0,i.sendBytes-t.sendBytes):0}}this.trafficStats&&(i.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(qT.LocalAudioTrack,i),i&&r&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,r.track,i);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var i,n;let[s,{videoStats:o,audioStats:r,videoPcStats:a}]=t;const c=r,d=o,l=a,h=Kv({},st),u=Kv({},ot),p=Kv({},rt),{audioTrack:_,videoTrack:E,audioSSRC:m,videoSSRC:f}=e.getRemoteMedia(s);let S;S=e instanceof Gv?e.getStats(!0):e.getStats();const T=null===(i=S)||void 0===i?void 0:i.audioRecv.find((e=>e.ssrc===m)),g=null===(n=S)||void 0===n?void 0:n.videoRecv.find((e=>e.ssrc===f)),C=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===s));if(T&&("opus"!==T.codec&&"aac"!==T.codec&&"PCMU"!==T.codec&&"PCMA"!==T.codec&&"G722"!==T.codec||(h.codecType=T.codec),T.outputLevel?h.receiveLevel=Math.round(32767*T.outputLevel):_&&(h.receiveLevel=Math.round(32767*_.getVolumeLevel())),h.receiveBytes=T.bytes,h.receivePackets=T.packets,h.receivePacketsLost=T.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=c?8*Math.max(0,h.receiveBytes-c.receiveBytes):0,h.totalDuration=c?c.totalDuration+1:1,h.totalFreezeTime=c?c.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=T.jitterBufferMs,h.totalDuration>10&&qv.isRemoteAudioFreeze(_)&&(h.totalFreezeTime+=1)),g){"H264"!==g.codec&&"H265"!==g.codec&&"VP8"!==g.codec&&"VP9"!==g.codec&&"AV1X"!==g.codec&&"AV1"!==g.codec||(u.codecType=g.codec),u.receiveBytes=g.bytes,u.receiveBitrate=d?8*Math.max(0,u.receiveBytes-d.receiveBytes):0,u.decodeFrameRate=g.decodeFrameRate<0?0:g.decodeFrameRate,u.renderFrameRate=g.decodeFrameRate<0?0:g.decodeFrameRate,g.outputFrame&&(u.renderFrameRate=g.outputFrame.frameRate),g.receivedFrame?(u.receiveFrameRate=g.receivedFrame.frameRate,u.receiveResolutionHeight=g.receivedFrame.height,u.receiveResolutionWidth=g.receivedFrame.width):E&&(u.receiveResolutionHeight=E._videoHeight||0,u.receiveResolutionWidth=E._videoWidth||0),void 0!==g.framesRateFirefox&&(u.receiveFrameRate=Math.round(g.framesRateFirefox)),u.receivePackets=g.packets,u.receivePacketsLost=g.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.totalDuration=d?d.totalDuration+1:1,u.totalFreezeTime=d?d.totalFreezeTime:0,u.receiveDelay=g.jitterBufferMs||0;const t=!!f&&e.getRemoteVideoIsReady(f);E&&t&&qv.isRemoteVideoFreeze(E,g,l)&&(u.totalFreezeTime+=1),u.freezeRate=u.totalFreezeTime/u.totalDuration}C&&(h.end2EndDelay=C.B_ad,u.end2EndDelay=C.B_vd,h.transportDelay=C.B_ed,u.transportDelay=C.B_ed,h.currentPacketLossRate=C.B_ealr4/100,u.currentPacketLossRate=C.B_evlr4/100,p.uplinkNetworkQuality=C.B_punq?C.B_punq:0,p.downlinkNetworkQuality=C.B_pdnq?C.B_pdnq:0),this.remoteStats.set(s,{audioStats:h,videoStats:u,videoPcStats:g,networkStats:p}),_&&this.exceptionMonitor.setRemoteAudioStats(_,h),E&&this.exceptionMonitor.setRemoteVideoStats(E,u)}))}}function Yv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Jv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Yv(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Yv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Xv extends T{constructor(e,t,n,s){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===ZS.INJECT?this.emit(IT.INJECT_STREAM_STATUS,t):(i.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===ZS.TRANSCODE?1:2}),this.emit(IT.PUBLISH_STREAM_STATUS,t))},this.spec=t,this.token=e,this.serviceMode=s,this.websocket=new Og("live-streaming",n),this.websocket.on(QS.CONNECTED,this.handleWebSocketOpen),this.websocket.on(QS.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(QS.REQUEST_NEW_URLS,((e,t)=>{O(this,IT.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(QS.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,n,s){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const o=this.commandReqId,r=this.reqId;if(!r||!this.websocket)throw new ET(h.UNEXPECTED_ERROR);const a=Jv({command:e,sdkVersion:"4.20.0"===H?"0.0.1":H,seq:r,requestId:r,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new ET(h.WS_DISCONNECT);const c=()=>new AS(((e,t)=>{this.websocket.once(QS.CLOSED,(()=>t(new ET(h.WS_ABORT)))),this.websocket.once(QS.CONNECTED,e)}));"connected"!==this.websocket.state&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new AS(((e,t)=>{const i=()=>{t(new ET(h.WS_ABORT))};this.websocket.once(QS.RECONNECTING,i),this.websocket.once(QS.CLOSED,i),this.once("@".concat(r,"-").concat(this.spec.sid),(t=>{e(t)}))}));s&&i.workerEvent(this.spec.sid,Jv(Jv({},s),{},{requestId:o,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(i){if("closed"===this.websocket.state)throw i;return await c(),await this.request(e,t,n)}return s&&i.workerEvent(this.spec.sid,Jv(Jv({},s),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:200===u.code,responseTime:Date.now()-l})),200!==u.code&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.20.0"===H?"0.0.1":H;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case yT.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void t.warning("live stream response already exists stream");case yT.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case yT.LIVE_STREAM_RESPONSE_BAD_STREAM:case yT.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new ET(h.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case yT.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case yT.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new ET(h.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case yT.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new ET(h.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(IT.WARNING,t,e.serverResponse.url)}case yT.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new ET(h.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(IT.WARNING,t,e.serverResponse.url)}case yT.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case yT.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new ET(h.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case yT.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new ET(h.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(IT.WARNING,t,e.serverResponse.url)}case yT.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case yT.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case yT.LIVE_STREAM_RESPONSE_WORKER_LOST:case yT.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case yT.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case yT.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new ET(h.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(ae)}),6e3)}}function zv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Qv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?zv(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):zv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Zv extends T{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Z,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new v("live-streaming"),this.cancelToken=Ve.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=Qv({},RT),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){const i=Qv(Qv({},CT),e);66!==i.videoCodecProfile&&77!==i.videoCodecProfile&&100!==i.videoCodecProfile&&(t.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map((e=>Qv(Qv(Qv({},ST),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){p(e.width)||_(e.width,"config.width",0,1e4),p(e.height)||_(e.height,"config.height",0,1e4),p(e.videoBitrate)||_(e.videoBitrate,"config.videoBitrate",1,1e6),p(e.videoFrameRate)||_(e.videoFrameRate,"config.videoFrameRate"),p(e.lowLatency)||E(e.lowLatency,"config.lowLatency"),p(e.audioSampleRate)||m(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),p(e.audioBitrate)||_(e.audioBitrate,"config.audioBitrate",1,128),p(e.audioChannels)||m(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),p(e.videoGop)||_(e.videoGop,"config.videoGop"),p(e.videoCodecProfile)||m(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),p(e.userCount)||_(e.userCount,"config.userCount",0,17),p(e.backgroundColor)||_(e.backgroundColor,"config.backgroundColor",0,16777215),p(e.userConfigExtraInfo)||f(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!p(e.transcodingUsers)&&(S(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{fT(e.uid),p(e.x)||_(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),p(e.y)||_(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),p(e.width)||_(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),p(e.height)||_(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),p(e.zOrder)||_(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),p(e.alpha)||_(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),p(e.watermark)||gT(e.watermark,"watermark"),p(e.backgroundImage)||gT(e.backgroundImage,"backgroundImage"),e.images&&!p(e.images)&&(S(e.images,"config.images"),e.images.forEach(((e,t)=>{gT(e,"images[".concat(t,"]"))})))}(i);const n=[];i.images&&n.push(...i.images.map((e=>Qv(Qv(Qv({},TT),e),{},{zOrder:255})))),i.backgroundImage&&(n.push(Qv(Qv(Qv({},TT),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(Qv(Qv(Qv({},TT),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map((e=>Qv({},e))),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const s=(i.userConfigs||[]).map((e=>"number"==typeof e.uid?AS.resolve(e.uid):kR(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await AS.all(s)).forEach(((e,t)=>{i.userConfigs&&i.userConfigs[t]&&(i.userConfigs[t].uid=e)})),this.transcodingConfig=i,this.connection)try{var o;const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(uT(o=this.streamingTasks).call(o)).map((e=>e.taskId)).join("#")});t.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((i=>{t.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,e).then((()=>{t.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(i.url," success"))})).catch((e=>{t.error("[".concat(this.spec.clientId,"] live streaming republish failed"),i.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,i,n){var s;if(Array.from(uT(s=this.streamingTasks).call(s)).find((e=>e.mode===ZS.INJECT))&&i===ZS.INJECT)return new ET(h.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===ZS.TRANSCODE)throw new ET(h.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};t.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const r=await this.taskMutex.lock();if(!this.connection&&n)return void r();if(this.streamingTasks.get(e)&&!n)return r(),new ET(h.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(e){throw r(),e}switch(i){case ZS.TRANSCODE:o.transcodingConfig=Qv({},this.transcodingConfig);break;case ZS.RAW:break;case ZS.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const s=new AS(((t,i)=>{N(this.retryTimeout).then((()=>{if(n)return i(n);const t=this.statusError.get(e);return t?(this.statusError.delete(e),i(t)):void 0}))})),c=await AS.race([this.connection.request("request",{clientRequest:o},!0,{url:e,command:"PublishStream",workerType:i===ZS.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),s]);this.isStartingStreamingTask=!1,t.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:o,mode:i,url:e,taskId:a}),r()}catch(t){if(r(),this.isStartingStreamingTask=!1,!t.data||!t.data.retry||n)throw t;return t.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,t)):await this.startLiveStreamingTask(e,i,t)}}stopLiveStreamingTask(e){return new AS(((i,n)=>{const s=this.streamingTasks.get(e);if(!s||!this.connection)return new ET(h.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=s.mode;s.abortTask=()=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:o===ZS.INJECT?"UninjectStream":"UnpublishStream",url:s.url}},!1,{url:e,command:"UnPublishStream",workerType:o===ZS.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&o!==ZS.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===ZS.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(n)}))}async controlInjectStream(e,t,i,n){const s=this.streamingTasks.get(e);if(!s||!this.connection||s.mode!==ZS.INJECT)throw new ET(h.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var e;const t=Array.from(uT(e=this.streamingTasks).call(e));this.terminate();for(const e of t)this.startLiveStreamingTask(e.url,e.mode).catch((t=>{this.onLiveStreamError&&this.onLiveStreamError(e.url,t)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Ve.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new ET(h.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await O(this,vT.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new Xv(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(IT.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(IT.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(IT.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(IT.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new ET(h.UNEXPECTED_ERROR,"can not get new live streaming address list"));O(this,vT.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),s=e.reason;switch(e.code){case yT.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case yT.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new ET(h.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return t.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case yT.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new ET(h.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,s);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,e)}case yT.LIVE_STREAM_RESPONSE_WORKER_LOST:case yT.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const i=Array.from(uT(o=this.streamingTasks).call(o));for(const n of i)n.abortTask?n.abortTask():(t.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new ET(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{t.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((e=>{t.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,e)})));return}}}handleInjectStreamServerStatus(e){const i=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_START_SUCCESS,i,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_BROKEN,i,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange($S.INJECT_STREAM_STATUS_START_TIMEOUT,i,n),void this.streamingTasks.delete(n);default:return void t.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class $v{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){xT(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){xT(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){mT(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function ey(e){if(!(e instanceof $v)){return new ET(h.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw()}const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t){return new ET(h.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}if(0===i.size){return new ET(h.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}}class ty extends T{constructor(e,t,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new Og("cross-channel-".concat(this.clientId),i),this.ws.on(QS.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(QS.CONNECTED,this.onOpen),this.ws.on(QS.ON_MESSAGE,this.onMessage),this.ws.on(QS.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new AS(((t,i)=>{const n=window.setTimeout((()=>{i(new ET(h.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new ET(h.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new ET(h.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new ET(h.WS_DISCONNECT);const t=()=>new AS(((e,t)=>{this.ws.once(QS.CLOSED,(()=>t(new ET(h.WS_ABORT)))),this.ws.once(QS.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const i=this.sendMessage(e),n=new AS(((e,t)=>{const n=()=>{t(new ET(h.WS_ABORT))};this.ws.once(QS.RECONNECTING,n),this.ws.once(QS.CLOSED,n),this.once("req_".concat(i),e),N(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(QS.RECONNECTING,n),this.ws.off(QS.CLOSED,n),t(new ET(h.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new ET(h.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(QS.REQUEST_NEW_URLS),this.ws.on(QS.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class iy extends T{set state(e){e!==this._state&&(e!==NT.RELAY_STATE_FAILURE&&(this.errorCode=OT.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,s,o){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=Ve.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=NT.RELAY_STATE_IDLE,this.errorCode=OT.RELAY_OK,this.onStatus=e=>{t.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",bT.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",bT.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=OT.SRC_TOKEN_EXPIRED,this.state=NT.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=OT.DEST_TOKEN_EXPIRED,this.state=NT.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{t.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",bT.NETWORK_DISCONNECTED),this.state=NT.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==NT.RELAY_STATE_IDLE&&(t.error("auto restart channel media relay failed",e.toString()),this.errorCode=OT.SERVER_CONNECTION_LOST,this.state=NT.RELAY_STATE_FAILURE)}))},this.joinInfo=e,this.clientId=i,this.sid=ce(),this.signal=new ty(this.joinInfo,this.clientId,n),this.httpRetryConfig=s,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==NT.RELAY_STATE_IDLE)throw new ET(h.INVALID_OPERATION);this.state=NT.RELAY_STATE_CONNECTING,await this.connect(),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new ET(h.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new ET(h.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new ET(h.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==NT.RELAY_STATE_RUNNING)throw new ET(h.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==NT.RELAY_STATE_RUNNING)throw new ET(h.INVALID_OPERATION);const i=this.genMessage(wT.SetVideoProfile);await this.signal.request(i),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),t.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=NT.RELAY_STATE_IDLE,this.dispose()}dispose(){t.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Ve.CancelToken.source(),this.state=NT.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await VR(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",bT.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(wT.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(wT.SetSdkProfile,e);await this.signal.request(n),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const s=this.genMessage(wT.SetSourceChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",bT.PACKET_JOINED_SRC_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(wT.SetSourceUserId,e);await this.signal.request(o),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const r=this.genMessage(wT.SetDestChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",bT.PACKET_JOINED_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(wT.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",bT.PACKET_SENT_TO_DEST_CHANNEL),this.state=NT.RELAY_STATE_RUNNING,t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const i=this.genMessage(wT.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",bT.PACKET_UPDATE_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(wT.StopPacketTransfer);await this.signal.request(e),t.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:H,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.20.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(e){case wT.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case wT.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new ET(h.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case wT.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new ET(h.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case wT.SetDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new ET(h.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case wT.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case wT.Reconnect:return o.clientRequest={command:"Reconnect"},o;case wT.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case wT.UpdateDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new ET(h.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case wT.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}function ny(e){var t={},i=!1;function n(t,n){return i=!0,{done:!1,value:new qR(n=new ZR((function(i){i(e[t](n))})),1)}}return t[void 0!==ip&&Tp||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}var sy=St($R);function oy(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ry(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oy(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oy(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function ay(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function cy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ay(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ay(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class dy extends ug{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))]}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=t,this.peerConnection=new RTCPeerConnection(dy.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=YI(this.peerConnection,g("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=QI(e.sdp),i=zI(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:g("FILTER_VIDEO_FEC"),filterAudioFec:g("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,cy(cy({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,sdkCodec:a,cname:c}=e,d=wI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=o,this.localCapabilities=r,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const r=d.mediaDescriptions[e];if(r.attributes.iceUfrag=t.iceUfrag,r.attributes.icePwd=t.icePwd,r.attributes.fingerprints=i.fingerprints,r.attributes.candidates=n,r.attributes.setup=o,"video"===r.media.mediaType){r.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10)));let e=s.videoCodecs.filter((e=>{var t,i;return null===(t=e.rtpMap)||void 0===t?void 0:Ho(i=t.encodingName.toLowerCase()).call(i,a)}));0===e.length&&(e=s.videoCodecs),r.attributes.payloads=e,r.attributes.extmaps=s.videoExtensions}"audio"===r.media.mediaType&&(r.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),r.attributes.payloads=s.audioCodecs,r.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(r)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return wI.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=ev(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===WT.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),r=n[0].attributes.label,a=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:r,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{Ho(e).call(e,t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{var t;Ho(t=s.map((e=>e.ssrcId))).call(t,e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===HT.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(ry(ry({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=$(e);return tv(i,t),nv(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===WT.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=$(e);return iv(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new l(h.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var i=this;return iI((function*(){const n=yield YR(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),o=yield YR(i.peerConnection.createOffer()),r=wI.parse(o.sdp),a=e.map((e=>{const t=e._mediaStreamTrack,n=r.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let c;try{c=yield a}catch(e){throw s.forEach((e=>{le()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const d=i.mungSendOfferSDP(o.sdp,e);i.remoteSDP.receive(e,t,c);const l=i.remoteSDP.toString();return yield YR(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield YR(i.applySendEncodings(s,e)),yield YR(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:a[t],id:i}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{le()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),o=new AS(((t,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),r=n=>{const a=Q();if(("Safari"===a.name&&11===Number(a.version)||he())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(n.track)};this.peerConnection.addEventListener("track",r)})),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a);return{track:await o,id:i}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(le()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(le()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return iI((function*(){const n=yield YR(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(We().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===HT.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===HT.RELAY)return;e!==HT.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield YR(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=QI(s.sdp),{remoteIceParameters:r}=yield o.iceParameters;i.remoteSDP.restartICE(r);const a=i.remoteSDP.toString();yield YR(i.peerConnection.setLocalDescription(s)),yield YR(i.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new l(h.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new l(h.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),g("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...dy.turnServerConfigToIceServers(e.turnServer.servers)),g("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...dy.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e._mediaStreamTrack.id}))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!We().supportSetRtpSenderParameters)return t.warn("Browser not support set rtp-sender parameters");const s={},o={};if(e instanceof Be)switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(g("DSCP_TYPE")&&se()){var r;const e=g("DSCP_TYPE");Ho(r=["very-low","low","medium","high"]).call(r,e)&&(o.networkPriority=e)}const a=i.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];c&&Object.assign(c,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!We().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=wI.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&tv(s,e)})),wI.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:o}=e[i];return new AS(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),r=t=>{const a=Q();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,t.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",r)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await AS.all(t)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(We().supportPCSetConfiguration){const t=dy.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function ly(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function hy(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function uy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?hy(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):hy(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}pT([ly,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],dy.prototype,"connect",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dy.prototype,"stopSending",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,Object]),_T("design:returntype",AS)],dy.prototype,"receive",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dy.prototype,"stopReceiving",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],dy.prototype,"muteRemote",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],dy.prototype,"unmuteRemote",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dy.prototype,"muteLocal",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dy.prototype,"unmuteLocal",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],dy.prototype,"close",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],dy.prototype,"updateEncoderConfig",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],dy.prototype,"updateSendParameters",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[He,String]),_T("design:returntype",AS)],dy.prototype,"replaceTrack",null),pT([ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],dy.prototype,"getRemoteSSRC",null);const py="9",_y=4e4;function Ey(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function my(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ey(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ey(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class fy extends ug{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))]}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=g("USE_XR"),this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=t,this.peerConnection=new RTCPeerConnection(fy.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=YI(this.peerConnection,g("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void t.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else t.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=QI(e.sdp),i=await av({filterRTX:!g("USE_PUB_RTX")&&!g("USE_SUB_RTX"),filterVideoFec:g("FILTER_VIDEO_FEC"),filterAudioFec:g("FILTER_AUDIO_FEC"),filterVideoCodec:g("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=lv(i),this.initialOffer=e,my(my({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,n,s,o,r){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=wI.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:_y,rtx:g("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,hv(e),g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=g("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,r=2*o+_y,{ssrcs:a,ssrcGroups:c}=ev([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=ev([{ssrcId:r,rtx:g("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:py,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:py,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return wI.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=ev(t,this.cname,g("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(le()||ue())||0===t&&g("USE_SUB_RTX")||pe()?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||pe()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===HT.TCP){if(0===t.length)return;if(g("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(uy(uy({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(uy(uy({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===HT.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(uy(uy({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(uy(uy({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:py,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,n,s,o){const r=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=pv(r,a,this.localCapabilities.send,r===WT.VIDEO?n:s),d=r===WT.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:r,port:py,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,o);const u=this.findFirstClosedMedia(r);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,i,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))],o=new Set(i);if(s.every((e=>o.has(e))))return t.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const r=this._rtpCapabilities.recv.videoCodecs.filter((e=>i.some((t=>{var i;return Ho(i=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(i,t)}))));if(0===r.length)return t.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(i)),!1;const a=[...new Set(r.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let c;if(t.debug("updateRemoteCodec, from ".concat(s," to ").concat(a)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(c=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Ho(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),c.length!==e.length)return t.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=r;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,h=pv(WT.VIDEO,l,d,n);return c.forEach((e=>{const i=h.map((e=>e.payloadType.toString(10)));t.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(h)),e.attributes.payloads=h,e.media.fmts=i})),!0}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===WT.VIDEO?o.videoCodecs:o.audioCodecs,a=e===WT.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:py,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=$(e);return iv(n),tv(n,t),nv(n,t),sv(n),ov(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return ov(i,t,this.localCapabilities.recv),hv(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:this.localCapabilities,cname:r}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const a=this.remoteSDP.toString(),c=wI.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find((e=>"audio"===e.media.mediaType));d&&hv(d),this.useXR&&uv(c);const l=wI.print(c),h=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==h||h(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const u=this.peerConnection.getTransceivers()[0];if(null!=u&&u.receiver&&this.tryBindTransportEvents(u.receiver),g("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)})),I()&&!0===g("SIMULCAST")&&(yield YR(n.applySimulcastForFirefox(o,e)));const r=yield YR(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(r.sdp,e,a),d=wI.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return ZI(t,g("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(e,t,i,h);const o=n.remoteSDP.toString();throw yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield YR(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield YR(n.stopSending(a,!0)),s}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield YR(n.applySimulcastEncodings(o,e)),yield YR(n.applySendEncodings(o,e)),null==p||p(u),yield YR(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);n&&"open"===n.readyState?t.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:g("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),i.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i),t.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else t.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof l?e:new l(h.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return iI((function*(){const n=yield YR(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(We().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===HT.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===HT.RELAY)return;i.remoteSDP.updateCandidates(e);const s=yield YR(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=QI(s.sdp),{remoteIceParameters:r}=yield o.iceParameters;i.remoteSDP.restartICE(r);const a=i.remoteSDP.toString(),c=i.logSDPExchange(s.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield YR(i.peerConnection.setLocalDescription(s)),null==c||c(a),yield YR(i.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:my(my({},PI),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:my(my({},PI),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),g("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...fy.turnServerConfigToIceServers(e.turnServer.servers)),g("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...fy.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),g("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),g("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(eC(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!g("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:i}=n.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!We().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){var r;const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),(Ho(r=e._hints).call(r,Ge.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(i&&(o.maxFramerate=iC(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(g("DSCP_TYPE")&&se()){var a;const e=g("DSCP_TYPE");Ho(a=["very-low","low","medium","high"]).call(a,e)&&(o.networkPriority=e)}const c=i.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];I()&&!d&&(s.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(e,i){try{if(!We().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof Be&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=wI.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(tv(o,e),rv(o,e,this.store.codec))})),wI.print(n)}mungReceiveAnswerSDP(e,t,i){const n=wI.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===WT.AUDIO&&"audio"===s.media.mediaType&&hv(s),this.useXR&&uv(n)),wI.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof Be&&!Ho(i=d._hints).call(i,Ge.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Be&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof Be&&g("SIMULCAST")&&"vp8"===this.store.codec&&!Ho(t=e._hints).call(t,Ge.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(g("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(We().supportPCSetConfiguration){const t=fy.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function Sy(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function Ty(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function gy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ty(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ty(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Array,Array]),_T("design:returntype",AS)],fy.prototype,"updateRemoteRTPCapabilities",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],fy.prototype,"connect",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Object,Array]),_T("design:returntype",AS)],fy.prototype,"createDataChannels",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,Object]),_T("design:returntype",AS)],fy.prototype,"receive",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],fy.prototype,"batchReceive",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],fy.prototype,"stopReceiving",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],fy.prototype,"muteRemote",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],fy.prototype,"unmuteRemote",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],fy.prototype,"muteLocal",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],fy.prototype,"unmuteLocal",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],fy.prototype,"close",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],fy.prototype,"updateEncoderConfig",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],fy.prototype,"updateSendParameters",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[He,String]),_T("design:returntype",AS)],fy.prototype,"replaceTrack",null),pT([Sy,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],fy.prototype,"getRemoteSSRC",null);const Cy="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",Ry="9",Iy=2e4,vy=4e4;class yy{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=wI.parse(Cy);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:vy,rtx:g("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,hv(e),g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:Iy}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=wI.parse(Cy);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:vy,rtx:g("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,g("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=ev([{ssrcId:Iy}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+Iy,r=2*o+vy,{ssrcs:a,ssrcGroups:c}=ev([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=ev([{ssrcId:r,rtx:g("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Ry,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Ry,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return wI.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=ev(t,this.cname,g("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||le()||he()||ue()||0===t&&g("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||le()||he()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Ho(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===HT.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(gy(gy({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,t,i,n,s,o){const r=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=pv(r,a,this.localCapabilities.send,r===WT.VIDEO?n:s),d=r===WT.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:r,port:Ry,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,o);const u=this.findFirstClosedMedia(r);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,i,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))],o=new Set(i);if(s.every((e=>o.has(e))))return t.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const r=this._rtpCapabilities.recv.videoCodecs.filter((e=>i.some((t=>{var i;return Ho(i=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(i,t)}))));if(0===r.length)return t.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(i)),!1;const a=[...new Set(r.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let c;if(t.debug("updateRemoteCodec, from ".concat(s," to ").concat(a)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(c=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Ho(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),c.length!==e.length)return t.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=r;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,h=pv(WT.VIDEO,l,d,n);return c.forEach((e=>{const i=h.map((e=>e.payloadType.toString(10)));t.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(h)),e.attributes.payloads=h,e.media.fmts=i})),!0}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===WT.VIDEO?o.videoCodecs:o.audioCodecs,a=e===WT.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:Ry,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=$(e);return iv(n),tv(n,t),nv(n,t),sv(n),ov(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return ov(i,t,this.localCapabilities.recv),hv(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}function Ay(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function wy(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ay(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ay(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class by extends ug{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=lv(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))]}constructor(e,t,i){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=g("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.remoteCodecs=void 0,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=t,this.peerConnection=i,this.statsFilter=YI(this.peerConnection,g("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=QI(e.sdp),i=await av({filterRTX:!g("USE_PUB_RTX")&&!g("USE_SUB_RTX"),filterVideoFec:g("FILTER_VIDEO_FEC"),filterAudioFec:g("FILTER_AUDIO_FEC"),filterVideoCodec:g("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=i,this.initialOffer=e,wy(wy({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new ET(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new yy({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:lv(this.localCapabilities),cname:o});const r=this.remoteSDP.toString(),a=wI.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&hv(c),this.useXR&&uv(a);const d=wI.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void t.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else t.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var i,n,s,o;(null===(i=this.remoteSDP)||void 0===i||i.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0)&&(null===(o=this.remoteSDP)||void 0===o||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec));null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const r=null===(s=this.remoteSDP)||void 0===s?void 0:s.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),t.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t)})),I()&&!0===g("SIMULCAST")&&(yield YR(n.applySimulcastForFirefox(o,e)));const r=yield YR(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(r.sdp,e,a),d=wI.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return ZI(t,g("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(e,t,i,h);const o=n.remoteSDP.toString();throw yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield YR(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield YR(n.stopSending(a,!0)),s}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield YR(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield YR(n.applySimulcastEncodings(o,e)),yield YR(n.applySendEncodings(o,e)),null==p||p(u),yield YR(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof ET?e:new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);return n&&"open"===n.readyState?t.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:g("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),void i.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof ET?e:new ET(h.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof ET?e:new ET(h.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else t.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else t.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return iI((function*(){const n=yield YR(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(We().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===HT.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===HT.RELAY)return;e!==HT.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield YR(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=QI(s.sdp),{remoteIceParameters:r}=yield o.iceParameters;i.remoteSDP.restartICE(r);const a=i.remoteSDP.toString(),c=i.logSDPExchange(s.sdp||"","offer","local","restartICE");yield YR(i.peerConnection.setLocalDescription(s)),null==c||c(a),yield YR(i.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(e){t.warning("restart ICE failed, abort operation",e)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new ET(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return wy(wy({},QI(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),g("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...by.turnServerConfigToIceServers(e.turnServer.servers)),g("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...by.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),g("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(eC(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!g("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,i){try{if(!We().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const h=e[t],u=i[t];if(u&&u instanceof Be){var n,s,o;if(this.isVP8Simulcast(u))continue;const e={},t={};switch(u._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var r,a,c,d;if(null!==(n=u._encoderConfig)&&void 0!==n&&n.bitrateMax)t.maxBitrate=1e3*(null===(r=u._encoderConfig)||void 0===r?void 0:r.bitrateMax);if(Ho(s=u._hints).call(s,Ge.LOW_STREAM))null!==(a=u._encoderConfig)&&void 0!==a&&a.frameRate&&(t.maxFramerate=iC(u._encoderConfig.frameRate)),null!==(c=u._encoderConfig)&&void 0!==c&&c.scaleResolutionDownBy&&(null===(d=u._encoderConfig)||void 0===d?void 0:d.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=u._encoderConfig.scaleResolutionDownBy);if(g("DSCP_TYPE")&&se()){var l;const e=g("DSCP_TYPE");Ho(l=["very-low","low","medium","high"]).call(l,e)&&(t.networkPriority=e)}const i=h.sender.getParameters(),p=null===(o=i.encodings)||void 0===o?void 0:o[0];I()&&!p&&(e.encodings=[t]),p&&Object.assign(p,t),Object.assign(i,e),await h.sender.setParameters(i)}}}catch(e){t.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=wI.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(tv(o,e),rv(o,e,this.store.codec))})),wI.print(n)}mungReceiveAnswerSDP(e,t,i){const n=wI.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===WT.AUDIO&&"audio"===s.media.mediaType&&hv(s),this.useXR&&uv(n),wI.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof Be&&!Ho(i=d._hints).call(i,Ge.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof Be&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof Be&&g("SIMULCAST")&&"vp8"===this.store.codec&&!Ho(t=e._hints).call(t,Ge.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(g("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during NVExtentionsConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(We().supportPCSetConfiguration){const t=by.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function Ny(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function Oy(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=sy,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Py(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Py(e){function t(e){if(Object(e)!==e)return AS.reject(new TypeError(e+" is not an object."));var t=e.done;return AS.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Py=function(e){this.s=e,this.n=e.next},Py.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?AS.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?AS.reject(e):t(i.apply(this.s,arguments))}},new Py(e)}pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],by.prototype,"connect",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Array,Array]),_T("design:returntype",AS)],by.prototype,"updateRemoteRTPCapabilities",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],by.prototype,"updateRemoteConnect",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Object,Array]),_T("design:returntype",AS)],by.prototype,"createDataChannels",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,Object]),_T("design:returntype",AS)],by.prototype,"receive",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],by.prototype,"batchReceive",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],by.prototype,"stopReceiving",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],by.prototype,"muteRemote",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],by.prototype,"unmuteRemote",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],by.prototype,"muteLocal",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],by.prototype,"unmuteLocal",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],by.prototype,"close",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],by.prototype,"updateEncoderConfig",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],by.prototype,"updateSendParameters",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[He,String]),_T("design:returntype",AS)],by.prototype,"replaceTrack",null),pT([Ny,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],by.prototype,"getRemoteSSRC",null);class Dy extends ug{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new v("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Dy.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new by(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(e,t,i,n,s,o),await new AS(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new ET(h.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.mutex.lock("From DataChannelConnection.send"));try{return yield*ny(Oy(n._p2pConnection.send(e,t,i)))}finally{s()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,i,n,s){return this._nvMedia?(t.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,i,this.cname)):(t.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,i,n,s))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return iI((function*(){return yield*ny(Oy(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,i,n,s){if(g("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during DataChannelConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(ne(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Dy.turnServerConfigToIceServers(e.turnServer.servers)),g("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Dy.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),g("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(eC(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!g("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function Ly(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function ky(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function My(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ky(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ky(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Uy(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=sy,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new xy(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function xy(e){function t(e){if(Object(e)!==e)return AS.reject(new TypeError(e+" is not an object."));var t=e.done;return AS.resolve(e.value).then((function(e){return{value:e,done:t}}))}return xy=function(e){this.s=e,this.n=e.next},xy.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?AS.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?AS.reject(e):t(i.apply(this.s,arguments))}},new xy(e)}pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],Dy.prototype,"connect",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Array,Array]),_T("design:returntype",AS)],Dy.prototype,"updateRemoteRTPCapabilities",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Object,Array]),_T("design:returntype",AS)],Dy.prototype,"createDataChannels",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String,Array,String,Object]),_T("design:returntype",AS)],Dy.prototype,"receive",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Dy.prototype,"stopReceiving",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],Dy.prototype,"muteRemote",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],Dy.prototype,"unmuteRemote",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Dy.prototype,"muteLocal",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Dy.prototype,"unmuteLocal",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],Dy.prototype,"close",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],Dy.prototype,"updateEncoderConfig",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String,He]),_T("design:returntype",AS)],Dy.prototype,"updateSendParameters",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[He,String]),_T("design:returntype",AS)],Dy.prototype,"replaceTrack",null),pT([Ly,_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],Dy.prototype,"getRemoteSSRC",null);class Vy extends T{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(JT.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new v("P2PChannel-mutex"),this._state=YT.Disconnected,this._pcStatsUploadType=g("NEW_ICE_RESTART")?KT.FIRST_CONNECTION:KT.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==YT.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){o[1].track._originMediaStreamTrack.stop()}await this.connection.muteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const r=this.createMuteMessage(s);await oe(this,JT.RequestMuteLocal,r),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==YT.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){const t=o[1];if(t.track._originMediaStreamTrack.stop(),!g("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=gv(e,U(this,JT.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new AS(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const r=this.createUnmuteMessage(s);await oe(this,JT.RequestUnmuteLocal,r),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(qT.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==YT.Connected)return void t();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),await this.connection.updateEncoderConfig(s,o),this.emit(JT.UpdateVideoEncoder,o),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(qT.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==YT.Connected)return;const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var r;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!t||this.state!==YT.Connected)return void i();if(await(null===(r=this.connection)||void 0===r?void 0:r.replaceTrack(e,t[1].id)),this.isPlanB){const i=t[1];i.id=e._mediaStreamTrack.id,this.localTrackMap.set(t[0],i)}if(t[0]===qT.LocalVideoTrack&&!g("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding){const t=this.localTrackMap.get(qT.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new AS(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetRTCStats=e=>{e(this.statsCollector.getRTCStats())},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new Uv(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!We().supportUnifiedPlan||g("CHROME_FORCE_PLAN_B")&&se(),this.shouldForwardP2PCreation=g("FORWARD_P2P_CREATION")&&We().supportPCSetConfiguration&&_e(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Dy({},this.store):this.isPlanB?new dy({},this.store):new fy({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,i){var n;this.state=YT.New;const s=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!s||(s&&this.connection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Dy(e,this.store):this.isPlanB?new dy(e,this.store):new fy(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=g("NEW_ICE_RESTART")?KT.FIRST_CONNECTION:KT.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,n,s,o){if(!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Dy?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=YT.Connected)}updateRemoteRTPCapabilities(e){const n=Array.from(this.localTrackMap.entries()).filter((e=>{var t;let[i]=e;return Ho(t=[qT.LocalVideoLowTrack,qT.LocalVideoTrack]).call(t,i)})),s=n.map((e=>{let[,{id:t}]=e;return t})),o=n.map((e=>{let[t]=e;return t}));if(this.connection instanceof fy){if(i.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(o),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!Ho(e).call(e,this.store.codec)){const i=["vp8","h264"].find((t=>Ho(e).call(e,t)));i&&(this.store.codec=i,t.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(s,e)}}async preConnect(e,t,i,n,s,o){if(!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const r=await this.connection.connect(e,t,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=YT.Connected,r}getEstablishParams(){if(this.connection instanceof Dy)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection){if(this.state===YT.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const t=e.filter((e=>-1!==this.pendingLocalDataChannels.findIndex((t=>t.id===e.id))));return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(t))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,i){var n=this;return iI((function*(){const s=yield YR(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==YT.Connected){if(n.state===YT.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,KR.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield YR(n.tryToUnmuteAudio(e)));yield*ny(Uy(n.doPublish(n.connection,o)))}finally{s()}}))()}doPublish(e,t){var i=this;return iI((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===qT.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=yield YR(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),s=(yield YR(n.next())).value,o=i.createGatewayPublishMessage(t,s);let r;try{r=yield o}catch(e){throw n.throw(e),(null==e?void 0:e.code)===h.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const a=i.mapPubResToRemoteConfig(o,r),c=(yield YR(n.next(a))).value;t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,c),i.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===qT.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(e,i){const n=this.localTrackMap.get(i);if(!n)return;if(!(n.track instanceof Be))return t.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof fy||this.connection instanceof dy))return t.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,o=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=aC(e,t)),i.maxFramerate=e.framerate?iC(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(e,s);if(s._encoderConfig||(s._encoderConfig={}),i!==qT.LocalVideoLowTrack||!g("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(s._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const i=s._originMediaStreamTrack;if(!i.canvas)return t.warn("[".concat(s.getTrackId(),"] no canvas on track"));!function(e,t){const i=e.canvas;t.width&&(i.width=iC(t.width)),t.height&&(i.height=iC(t.height)),t.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=Ke((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),iC(t.framerate)))}(i,e)}null!=o.maxBitrate&&(s._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(s._encoderConfig.frameRate&&"object"==typeof s._encoderConfig.frameRate?s._encoderConfig.frameRate.max=o.maxFramerate:s._encoderConfig.frameRate={max:o.maxFramerate}),t.debug("[".concat(s.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(s._encoderConfig))),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(e){var t=this;return iI((function*(){if(!t.connection||t.state!==YT.Connected)return;const i=yield YR(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=t.localTrackMap.get(qT.LocalVideoTrack);if(!s)throw new l(h.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(qT.LocalVideoLowTrack))throw new l(h.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:t.getLowVideoTrack(s.track,e),type:qT.LocalVideoLowTrack}];if(yield*ny(Uy(t.doPublish(t.connection,o))),s.track.muted||!s.track.enabled){var n;const e=null===(n=t.localTrackMap.get(qT.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield YR(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await O(this,JT.RequestRePublish,this.pendingLocalTracks),this.emit(JT.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(t.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await O(this,JT.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==WT.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==WT.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await O(this,JT.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===WT.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(JT.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==YT.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}return this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==YT.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==YT.Connected)return;const e=this.localTrackMap.get(qT.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[qT.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==YT.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(e,i,n,s,o){var r;if(!this.connection||this.state!==YT.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(r=this.remoteUserMap.get(e))&&void 0!==r&&r.has(i))return;let a,c,d;if(o){const t=o.find((e=>{let{stream_type:t}=e;return t===i}));if(!t)throw new l(h.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const n=await this.connection.receive(i,t.ssrcs,String(e._uintid),t.attributes);this.connection instanceof fy&&(d=n.transceiver),a=n.track,c=n.id}else{const t=await this.connection.receive(i,[{ssrcId:n,rtx:s}],String(e._uintid),void 0);this.connection instanceof fy&&(d=t.transceiver),a=t.track,c=t.id}i===WT.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new ze(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new Qe(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack));const u=this.remoteUserMap.get(e);u?u.set(i,c):this.remoteUserMap.set(e,new Map([[i,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const p=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==p&&(this.pendingRemoteTracks.splice(p,1),this.emit(JT.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==YT.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const i=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));e.forEach(((e,n)=>{let{user:s,mediaType:o}=e;const{track:r,id:a,transceiver:c}=i[n];o===WT.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(r):(s._audioTrack=new ze(r,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),c&&s._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(r):(s._videoTrack=new Qe(r,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),c&&s._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._videoTrack));const d=this.remoteUserMap.get(s);d?d.set(o,a):this.remoteUserMap.set(s,new Map([[o,a]])),this.statsCollector.addRemoteStats(s.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===s.uid&&o===i}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(JT.MediaReconnectEnd,s.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===YT.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===WT.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===WT.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==YT.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===WT.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===WT.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===WT.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==YT.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===WT.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===WT.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=sT(e).call(e,((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;i===WT.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===WT.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===WT.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),n}async muteRemote(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===WT.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(qT.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Fe){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==qT.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===qT.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===qT.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(qT.LocalAudioTrack),r=s?this.localTrackMap.get(qT.LocalVideoLowTrack):this.localTrackMap.get(qT.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:KR.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(Ge.SCREEN_TRACK)),audio:!!n,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var r;n||(n=[]);const a=n.find((e=>e instanceof je)),c=s?null===(r=this.localTrackMap.get(qT.LocalVideoTrack))||void 0===r?void 0:r.track:n.find((e=>e instanceof Be));i.publish(this.store.sessionId,{eventElapse:KR.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==a?void 0:a.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(Ge.SCREEN_TRACK)),audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===WT.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===WT.VIDEO,audio:s===WT.AUDIO,peerid:n.uid,subscribeRequestid:s===WT.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:KR.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new v("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Dy({},this.store):this.isPlanB?new dy({},this.store):new fy({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(qT.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Fe){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=YT.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(qT.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Be||t&&t.track instanceof je?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(qT.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=ZC(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=YT.Reconnecting,g("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Dy({},this.store):this.isPlanB?new dy({},this.store):new fy({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[i,{track:n}]=e;switch(i){case qT.LocalVideoTrack:Ho(t=n._hints).call(t,Ge.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case qT.LocalAudioTrack:n instanceof Fe?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case qT.LocalVideoLowTrack:}})),this.emit(JT.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(lI(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(JT.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(lI(i).call(i)).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof xv?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof xv?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return iI((function*(){if(!t.connection||t.state!==YT.Connected||t.connection instanceof Dy)return;const i=yield YR(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield YR(t.connection.restartICE(e));const s=yield YR(n.next());if(s.done)return;const o=s.value,r=yield o;switch(t.reportPCDisconnectedOrFailed(e),e){case HT.TCP:t._pcStatsUploadType=KT.TCP_RESTART;break;case HT.RELAY:t._pcStatsUploadType=KT.RELAY_RESTART;break;default:t._pcStatsUploadType=KT.OLD_RESTART}t._isInRestartIce=!0,n.next(r)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(qT.LocalVideoTrack),i=this.localTrackMap.get(qT.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=P(this,JT.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(Ge.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return Qo[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=P(this,JT.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new AS(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=We(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=re(e);let r=!1,a=!1;for(const o of e){if(o instanceof Be&&(this.localTrackMap.has(qT.LocalVideoTrack)||r?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:qT.LocalVideoTrack}),r=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:qT.LocalVideoLowTrack})}if(o instanceof je){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(e){if(!(e.track instanceof Fe))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===qT.LocalAudioTrack}));if(!(e.track instanceof Fe))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Fe||o._bypassWebAudio)n.push({track:o,type:qT.LocalAudioTrack});else{const e=new Fe;e.addAudioTrack(o),n.push({track:e,type:qT.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=re(e);for(const i of e){if(i instanceof je){const e=this.localTrackMap.get(qT.LocalAudioTrack);if(!e)continue;e.track instanceof Fe?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([qT.LocalAudioTrack,e]),e.track.close())):t.push([qT.LocalAudioTrack,e])}if(i instanceof Be){const e=this.localTrackMap.get(qT.LocalVideoTrack);if(!e)continue;t.push([qT.LocalVideoTrack,e]);const i=this.localTrackMap.get(qT.LocalVideoLowTrack);i&&t.push([qT.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=re(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=re(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case qT.LocalVideoTrack:t.addListener(Ze.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Ze.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Ze.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Ze.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case qT.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case qT.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Fe?e.trackList.forEach((e=>{e.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Ze.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(Ze.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case qT.LocalVideoTrack:t.off(Ze.GET_STATS,this.handleGetLocalVideoStats),t.off(Ze.GET_RTC_STATS,this.handleGetRTCStats),t.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Ze.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Ze.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case qT.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case qT.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Fe?e.trackList.forEach((e=>{e.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ze.GET_STATS,this.handleGetLocalAudioStats),e.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(Ze.GET_STATS,this.handleGetLocalAudioStats),e.off(Ze.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Ze.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Ze.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Ze.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Qe&&t.addListener(Ze.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ze&&t.addListener(Ze.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Ze.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(WT.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(WT.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{var n;let s,o,{track:r,type:a}=e;switch(a){case qT.LocalAudioTrack:s=PT.Audio,o={dtx:r instanceof Xe&&r._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case qT.LocalVideoTrack:s=Ho(n=r._hints).call(n,Ge.SCREEN_TRACK)?PT.Screen:PT.High,o=My(My({},nC(r)),{},{codec:this.store.codec});break;case qT.LocalVideoLowTrack:s=PT.Low,o=My(My({},nC(r)),{},{codec:this.store.codec})}return{stream_type:s,attributes:o,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{if(t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(JT.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),g("NEW_ICE_RESTART")){var n;if(Ho(n=this._restartStates).call(n,i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=i=>{if("disconnected"===e.iceConnectionState||"checking"===e.iceConnectionState||"failed"===e.iceConnectionState){t.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(i));"CONNECTED"===P(this,JT.QueryClientConnectionState)&&this.emit(JT.RequestRestartICE,i)}},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),t.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(JT.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},s=g("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(g("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&We().supportPCSetConfiguration)i(HT.RELAY),this._restartTimer=window.setTimeout(n,s);else if(I())i(HT.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(i(HT.TCP),We().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{i(HT.RELAY),this._restartTimer=window.setTimeout(n,s)}),s));this._restartTimer=window.setTimeout(n,s)}}),800))}}else{if("disconnected"===i&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{if("disconnected"===e.iceConnectionState&&g("ICE_RESTART")){"CONNECTED"===P(this,JT.QueryClientConnectionState)&&this.emit(JT.RequestRestartICE)}}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(JT.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===i&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(JT.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(JT.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var r;o&&(this.store.subscribe(o.uid,"audio",void 0,void 0,void 0,Date.now()),null===(r=o.audioTrack)||void 0===r||r.emit($e.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{var t;const o=Array.from(lI(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:o._uintid,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(JT.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(qT.LocalAudioTrack);if(e instanceof je&&(null==i?void 0:i.track)instanceof Fe)return i.track.isActive||t.push([qT.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===qT.LocalVideoTrack)){const e=this.localTrackMap.get(qT.LocalVideoLowTrack);e&&t.push([qT.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(qT.LocalAudioTrack);if(e instanceof je&&(null==i?void 0:i.track)instanceof Fe)return i.track.isActive&&t.push([qT.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===qT.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(qT.LocalVideoLowTrack);e&&t.push([qT.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case qT.LocalAudioTrack:i=PT.Audio;break;case qT.LocalVideoTrack:i=Ho(t=s._hints).call(t,Ge.SCREEN_TRACK)?PT.Screen:PT.High;break;case qT.LocalVideoLowTrack:i=PT.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case WT.VIDEO:return void(i._videoSSRC&&t.push({stream_type:WT.VIDEO,ssrcId:i._videoSSRC}));case WT.AUDIO:return void(i._audioSSRC&&t.push({stream_type:WT.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===WT.VIDEO?e|=kT.Video:e|=kT.Audio,t.set(i,e)}else n===WT.VIDEO?t.set(i,kT.Video):t.set(i,kT.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(qT.LocalVideoTrack),i=this.localTrackMap.get(qT.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.connection){return"connected"!==this.connection.peerConnectionState}return!0}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof je){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await oe(this,JT.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(JT.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(JT.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await N(b(this.dtlsFailedCount,Z)),this.emit(JT.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await O(this,JT.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(JT.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(qT.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof Be))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof Be)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof je)).length>1&&(e.some((e=>e instanceof je&&e._bypassWebAudio))||!We().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Be&&this.pendingLocalTracks.some((e=>e instanceof Be)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof je&&this.pendingLocalTracks.some((e=>e instanceof je))&&(!We().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof je&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!g("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding,n=My(My({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():gv(e,n);const o=M(8,"track-low-"),r=new Be(s,My(My({},i&&{scaleResolutionDownBy:aC(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on(et.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,tt.LOW_STREAM)})),r._hints.push(Ge.LOW_STREAM),e.addListener(Ze.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof fy){var o,r,a,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:h,peerConnectionState:u}=this.connection,{local:p,remote:_}=await this.connection.getSelectedCandidatePair();i.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:l,dtlsstate:h,connectionstate:u,intSucc:t?1:2,error:s,selectedLocalCandidateProtocol:null!==(o=null==p?void 0:p.protocol)&&void 0!==o?o:"",selectedLocalCandidateType:null!==(r=p.candidateType)&&void 0!==r?r:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:null!==(a=_.protocol)&&void 0!==a?a:"",selectedRemoteCandidateType:null!==(c=_.candidateType)&&void 0!==c?c:"",selectedRemoteCandidateAddress:"".concat(_.address,":").concat(_.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,o,r){var a;const c=Array.from(lI(a=this.remoteUserMap).call(a)).find((t=>t._videoSSRC===e));if(c){r||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find((e=>e.userId===c.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:o,subscribeElapse:KR.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===YT.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===MT.datachannel?new Dy({},this.store):this.isPlanB?new dy({},this.store):new fy({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===qT.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,tt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof fy&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===KT.TCP_RESTART&&e===HT.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,KT.DISCONNECTED_OR_FAILED)))}}function Fy(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function jy(e){let t=Qy();return function(e,t){let i=e.appId;void 0!==i&&(hA(t,10),sA(t,i));let n=e.cid;void 0!==n&&(hA(t,16),hA(t,n));let s=e.cname;void 0!==s&&(hA(t,26),sA(t,s));let o=e.deviceId;void 0!==o&&(hA(t,34),sA(t,o));let r=e.elapse;void 0!==r&&(hA(t,40),uA(t,r));let a=e.fileSize;void 0!==a&&(hA(t,48),uA(t,Xy(a)));let c=e.height;void 0!==c&&(hA(t,56),uA(t,Xy(c)));let d=e.jpg;void 0!==d&&(hA(t,66),hA(t,d.length),function(e,t){let i=tA(e,t.length);e.bytes.set(t,i)}(t,d));let l=e.networkType;void 0!==l&&(hA(t,72),uA(t,Xy(l)));let h=e.osType;void 0!==h&&(hA(t,80),uA(t,Xy(h)));let u=e.requestId;void 0!==u&&(hA(t,90),sA(t,u));let p=e.sdkVersion;void 0!==p&&(hA(t,98),sA(t,p));let _=e.sequence;void 0!==_&&(hA(t,104),uA(t,Xy(_)));let E=e.sid;void 0!==E&&(hA(t,114),sA(t,E));let m=e.timestamp;void 0!==m&&(hA(t,120),uA(t,m));let f=e.uid;void 0!==f&&(hA(t,128),hA(t,f));let S=e.vid;void 0!==S&&(hA(t,136),hA(t,S));let T=e.width;void 0!==T&&(hA(t,144),uA(t,Xy(T)));let g=e.service;void 0!==g&&(hA(t,152),hA(t,g));let C=e.callbackData;void 0!==C&&(hA(t,162),sA(t,C));let R=e.jpgEncryption;void 0!==R&&(hA(t,168),hA(t,R));let I=e.requestType;void 0!==I&&(hA(t,176),hA(t,I));let v=e.scorePorn;void 0!==v&&(hA(t,185),dA(t,v));let y=e.scoreSexy;void 0!==y&&(hA(t,193),dA(t,y));let A=e.scoreNeutral;void 0!==A&&(hA(t,201),dA(t,A));let w=e.scene;void 0!==w&&(hA(t,208),hA(t,w));let b=e.ossFilePrefix;void 0!==b&&(hA(t,218),sA(t,b));let N=e.serviceVendor;if(void 0!==N)for(let e of N){hA(t,226);let i=Qy();Wy(e,i),hA(t,i.limit),oA(t,i),Zy(i)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function By(e){return function(e){let t={};e:for(;!eA(e);){let i=lA(e);switch(i>>>3){case 0:break e;case 1:t.code=lA(e);break;case 2:t.msg=nA(e,lA(e));break;case 3:{let i=Hy(e);t.data=Gy(e),e.limit=i;break}default:Ky(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function Gy(e){let t={};e:for(;!eA(e);){let i=lA(e);switch(i>>>3){case 0:break e;case 1:t.requestId=nA(e,lA(e));break;case 2:t.requestType=lA(e)>>>0;break;case 3:t.scorePorn=cA(e);break;case 4:t.scoreSexy=cA(e);break;case 5:t.scoreNeutral=cA(e);break;case 6:t.requestScene=lA(e)>>>0;break;case 7:t.scene=lA(e)>>>0;break;default:Ky(e,7&i)}}return t}function Wy(e,t){let i=e.service;void 0!==i&&(hA(t,8),hA(t,i));let n=e.vendor;void 0!==n&&(hA(t,16),hA(t,n));let s=e.token;void 0!==s&&(hA(t,26),sA(t,s));let o=e.callbackUrl;void 0!==o&&(hA(t,34),sA(t,o))}function Hy(e){let t=lA(e),i=e.limit;return e.limit=e.offset+t,i}function Ky(e,t){switch(t){case 0:for(;128&rA(e););break;case 2:$y(e,lA(e));break;case 5:$y(e,4);break;case 1:$y(e,8);break;default:throw new Error("Unimplemented type: "+t)}}pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Object,Boolean]),_T("design:returntype",AS)],Vy.prototype,"startP2PConnection",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],Vy.prototype,"connect",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",void 0)],Vy.prototype,"updateRemoteRTPCapabilities",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Object,Object,Array,Object,String,String]),_T("design:returntype",AS)],Vy.prototype,"preConnect",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Vy.prototype,"publishDataChannel",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Vy.prototype,"unpublish",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Vy.prototype,"unpublishDataChannel",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],Vy.prototype,"unpublishLowStream",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,Array]),_T("design:returntype",AS)],Vy.prototype,"subscribeDataChannel",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String,Number,Number,Array]),_T("design:returntype",AS)],Vy.prototype,"subscribe",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Vy.prototype,"massSubscribe",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String,Boolean]),_T("design:returntype",AS)],Vy.prototype,"unsubscribe",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,Array]),_T("design:returntype",AS)],Vy.prototype,"unsubscribeDataChannel",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],Vy.prototype,"massUnsubscribe",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Vy.prototype,"muteRemote",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Vy.prototype,"unmuteRemote",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String]),_T("design:returntype",AS)],Vy.prototype,"hasRemoteMediaWithLock",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],Vy.prototype,"disconnectForReconnect",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],Vy.prototype,"updateBitrateLimit",null),pT([Fy,_T("design:type",Function),_T("design:paramtypes",[xv,String,Number]),_T("design:returntype",AS)],Vy.prototype,"remoteMediaSsrcChanged",null);let qy=new Float32Array(1);new Uint8Array(qy.buffer);let Yy=new Float64Array(1),Jy=new Uint8Array(Yy.buffer);function Xy(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let zy=[];function Qy(){const e=zy.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function Zy(e){zy.push(e)}function $y(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function eA(e){return e.offset>=e.limit}function tA(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function iA(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function nA(e,t){let i=iA(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function sA(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}hA(e,n);let s=tA(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function oA(e,t){let i=tA(e,t.limit),n=e.bytes,s=t.bytes;for(let e=0,o=t.limit;e<o;e++)n[e+i]=s[e]}function rA(e){return e.bytes[iA(e,1)]}function aA(e,t){let i=tA(e,1);e.bytes[i]=t}function cA(e){let t=iA(e,8),i=e.bytes;return Jy[0]=i[t++],Jy[1]=i[t++],Jy[2]=i[t++],Jy[3]=i[t++],Jy[4]=i[t++],Jy[5]=i[t++],Jy[6]=i[t++],Jy[7]=i[t++],Yy[0]}function dA(e,t){let i=tA(e,8),n=e.bytes;Yy[0]=t,n[i++]=Jy[0],n[i++]=Jy[1],n[i++]=Jy[2],n[i++]=Jy[3],n[i++]=Jy[4],n[i++]=Jy[5],n[i++]=Jy[6],n[i++]=Jy[7]}function lA(e){let t,i=0,n=0;do{t=rA(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function hA(e,t){for(t>>>=0;t>=128;)aA(e,127&t|128),t>>>=7;aA(e,t)}function uA(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=tA(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}function pA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const _A=new Map([["moderation",1],["supervise",2]]);class EA extends T{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(ZT.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=sT(t=e.map((e=>_A.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=zT.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=Ve.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==zT.CONNECTED)throw new ET(h.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===zT.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=M(5,"inspect-"),this.workerMessageLengthLimit=g("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=g("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=g("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Og("worker-manager-"+this._inspectId,Z),this.on(ZT.STATE_CHANGE,((e,i)=>{this._innerConnectionState=e,t.debug("[".concat(this._inspectId,"] Inspect operation :").concat(QT[e]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new Og("worker-"+this._inspectId,Z),this.handleWorkerEvents()}async init(e,t){this.emit(ZT.STATE_CHANGE,QT.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new AS(((n,s)=>{this.on(ZT.CONNECTION_STATE_CHANGE,((e,t)=>{t===zT.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{s(e)}))}))}async requestAP(e,n,s){const o=g("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,n,s,o){let{appId:r,areaCode:a,cname:c,sid:d,token:l,uid:u}=n;NR++;const p="image_moderation_api",_={service_name:p,json_body:JSON.stringify({appId:r,areaCode:a,cname:c,command:"allocateEdge",requestId:NR,seq:NR,sid:d,token:l,ts:Date.now(),uid:u+""})};let E,m,f=e[0];return z((async()=>{E=Date.now();const e=await aR(f,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new ET(h.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new ET(h.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new ET(h.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=g("VIDEO_INSPECT_WORKER_MANAGER_HOST"),o=g("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(o||i)})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(ZT.STATE_CHANGE,QT.AP_CONNECTED);const{addressList:a}=r;return this.wmSequence++,a}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(ZT.STATE_CHANGE,QT.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(QS.CONNECTED,(async()=>{this.emit(ZT.STATE_CHANGE,QT.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(QS.CLOSED,(()=>{this._innerConnectionState<QT.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(QS.FAILED,(()=>{this._innerConnectionState<QT.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(QS.RECONNECTING,(()=>{this._innerConnectionState<QT.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(QS.ON_MESSAGE,(async e=>{this.emit(ZT.STATE_CHANGE,QT.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(200!==n.code)throw t.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new ET(h.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw t.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new ET(h.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=g("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,t=i.replace(/:\d+\/?$/,":".concat(e));this.emit(ZT.STATE_CHANGE,QT.CONNECT_WORKER,t),this._needWorkUrlOnly?this.emit(ZT.REQUEST_NEW_WORKER_URL,t):await this.connectWorker(t)}})),this.workerManagerConnection.on(QS.WILL_RECONNECT,((e,t,i)=>{i(e)})),this.workerManagerConnection.on(QS.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(QS.CONNECTED,(async()=>{this.emit(ZT.STATE_CHANGE,QT.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=zT.CONNECTED})),this.workerConnection.on(QS.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=By(new Uint8Array(e.data));if(g("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&t.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),200===n.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(ZT.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;const e={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},t=sT(i=Object.keys(e)).call(i,((t,i)=>e[t]>e[i]?t:i),"porn"),s=Object.keys(e).find((e=>e===t));this.emit(ZT.INSPECT_RESULT,s)}else this.emit(ZT.INSPECT_RESULT,void 0,new ET(h.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(ZT.INSPECT_RESULT,void 0,new ET(h.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else t.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ZT.INSPECT_RESULT,void 0,new ET(h.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(QS.CLOSED,(()=>{this.connectionState=zT.CLOSED})),this.workerConnection.on(QS.FAILED,(()=>{this.connectionState=zT.CLOSED})),this.workerConnection.on(QS.RECONNECTING,(()=>{this.connectionState=this.connectionState===zT.CONNECTED?zT.RECONNECTING:zT.CONNECTING})),this.workerConnection.on(QS.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this.workerConnection.on(QS.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(ZT.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=P(this,ZT.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(ZT.INSPECT_RESULT,void 0,new ET(h.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(ZT.INSPECT_RESULT,void 0,new ET(h.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await at(l,n,s),u=this.sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:EA.intToLong(Number(d-this.inspectStartTime)),fileSize:h.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:u,sdkVersion:"4.20.0",sequence:this.sequence,sid:a,timestamp:EA.intToLong(d),uid:c,vid:r,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete p.callbackData,void 0===this.ossFilePrefix&&delete p.ossFilePrefix;const _=jy(p);if(_.byteLength<this.workerMessageLengthLimit){if(g("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?pA(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},p);delete e.jpg,t.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return _}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Ve.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=zT.CLOSED,this.emit(ZT.STATE_CHANGE,QT.CLOSED)}}function mA(e){let t=function(){const e=gA.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let i=e.appId;void 0!==i&&(PA(t,10),wA(t,i));let n=e.cid;void 0!==n&&(PA(t,16),PA(t,n));let s=e.cname;void 0!==s&&(PA(t,26),wA(t,s));let o=e.deviceId;void 0!==o&&(PA(t,34),wA(t,o));let r=e.elapse;void 0!==r&&(PA(t,40),LA(t,r));let a=e.fileSize;void 0!==a&&(PA(t,48),LA(t,TA(a)));let c=e.height;void 0!==c&&(PA(t,56),LA(t,TA(c)));let d=e.jpg;void 0!==d&&(PA(t,66),PA(t,d.length),yA(t,d));let l=e.networkType;void 0!==l&&(PA(t,72),LA(t,TA(l)));let h=e.osType;void 0!==h&&(PA(t,80),LA(t,TA(h)));let u=e.requestId;void 0!==u&&(PA(t,90),wA(t,u));let p=e.sdkVersion;void 0!==p&&(PA(t,98),wA(t,p));let _=e.sequence;void 0!==_&&(PA(t,104),LA(t,TA(_)));let E=e.sid;void 0!==E&&(PA(t,114),wA(t,E));let m=e.timestamp;void 0!==m&&(PA(t,120),LA(t,m));let f=e.uid;void 0!==f&&(PA(t,128),PA(t,f));let S=e.vid;void 0!==S&&(PA(t,136),PA(t,S));let T=e.width;void 0!==T&&(PA(t,144),LA(t,TA(T)));let g=e.service;void 0!==g&&(PA(t,152),PA(t,g));let C=e.callbackData;void 0!==C&&(PA(t,162),PA(t,C.length),yA(t,C));let R=e.ticket;void 0!==R&&(PA(t,170),wA(t,R));let I=e.vendorConfigs;void 0!==I&&(PA(t,178),wA(t,I))}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function fA(e){return function(e){let t={};e:for(;!RA(e);){let i=OA(e);switch(i>>>3){case 0:break e;case 1:t.code=OA(e);break;case 2:t.msg=AA(e,OA(e));break;case 3:t.requestId=AA(e,OA(e));break;case 4:t.timestamp=DA(e,!1);break;default:SA(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function SA(e,t){switch(t){case 0:for(;128&bA(e););break;case 2:CA(e,OA(e));break;case 5:CA(e,4);break;case 1:CA(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function TA(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let gA=[];function CA(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function RA(e){return e.offset>=e.limit}function IA(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function vA(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function yA(e,t){let i=IA(e,t.length);e.bytes.set(t,i)}function AA(e,t){let i=vA(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function wA(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}PA(e,n);let s=IA(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function bA(e){return e.bytes[vA(e,1)]}function NA(e,t){let i=IA(e,1);e.bytes[i]=t}function OA(e){let t,i=0,n=0;do{t=bA(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function PA(e,t){for(t>>>=0;t>=128;)NA(e,127&t|128),t>>>=7;NA(e,t)}function DA(e,t){let i,n=0,s=0,o=0;return i=bA(e),n=127&i,128&i&&(i=bA(e),n|=(127&i)<<7,128&i&&(i=bA(e),n|=(127&i)<<14,128&i&&(i=bA(e),n|=(127&i)<<21,128&i&&(i=bA(e),s=127&i,128&i&&(i=bA(e),s|=(127&i)<<7,128&i&&(i=bA(e),s|=(127&i)<<14,128&i&&(i=bA(e),s|=(127&i)<<21,128&i&&(i=bA(e),o=127&i,128&i&&(i=bA(e),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:t}}function LA(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=IA(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const kA={},MA={},UA=4294967296,xA=UA*UA,VA=xA/2,FA=HA(0,!0),jA=HA(0),BA=KA(0,-2147483648,!1),GA=KA(-1,2147483647,!1),WA=KA(-1,-1,!0);function HA(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=MA[e],n)?n:(i=KA(e,0,!0),s&&(MA[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=kA[e],n)?n:(i=KA(e,e<0?-1:0,!1),s&&(kA[e]=i),i)}function KA(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function qA(e,t){if(isNaN(e))return t?FA:jA;if(t){if(e<0)return FA;if(e>=xA)return WA}else{if(e<=-VA)return BA;if(e+1>=VA)return GA}return e<0?t?FA:jA:KA(e%UA|0,e/UA|0,t)}function YA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class JA extends T{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(sg.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var i;super(),this.name="AgoraRTCImageModeration",this._connectionState=ng.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=Ve.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._extraInfo=void 0,this._vendor="",this._encoder=new TextEncoder,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==ng.CONNECTED)throw new ET(h.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===ng.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=M(5,"image-moderation-"),this._workerMessageLengthLimit=g("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=g("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=g("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Og("worker-"+this._moderationId,Z),this.on(sg.STATE_CHANGE,((e,i)=>{t.debug("[".concat(this._moderationId,"] Moderation operation :").concat(og[e]," ").concat(i||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(sg.STATE_CHANGE,og.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new AS(((n,s)=>{this.on(sg.CONNECTION_STATE_CHANGE,((e,t)=>{e===ng.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorker(e)})).catch((e=>{s(e)}))}))}updateConfig(e){var i;this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),t.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===ng.CONNECTED&&this.inspectImage()}async requestAP(e,n,s){const o=g("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,n,s,o){let{appId:r,areaCode:a,cname:c,sid:d,token:l,uid:u}=n;NR++;const p="moderation_plugin",_={service_name:p,json_body:JSON.stringify({appId:r,areaCode:a,cname:c,command:"allocateEdge",requestId:NR,seq:NR,sid:d,appToken:l,ts:Date.now(),uid:u+""})};let E,m,f=e[0];return z((async()=>{E=Date.now();const e=await aR(f,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new ET(h.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new ET(h.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new ET(h.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers.some((e=>!!e.wss))){const e=new ET(h.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=g("IMAGE_MODERATION_WORKER_HOST");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,ticket:i.appTicket,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(sg.STATE_CHANGE,og.AP_CONNECTED);const{addressList:a,ticket:c}=r;return this._ticket=c,a}async connectWorker(e){this.emit(sg.STATE_CHANGE,og.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(QS.CONNECTED,(async()=>{this.emit(sg.STATE_CHANGE,og.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=ng.CONNECTED})),this._workerConnection.on(QS.CLOSED,(()=>{this.connectionState=ng.CLOSED})),this._workerConnection.on(QS.FAILED,(()=>{this.connectionState=ng.CLOSED})),this._workerConnection.on(QS.RECONNECTING,(()=>{this.connectionState=this.connectionState===ng.CONNECTED?ng.RECONNECTING:ng.CONNECTING})),this._workerConnection.on(QS.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=fA(new Uint8Array(e.data));g("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,void 0===n.code||0===n.code||(this._uploadFailedNum++,t.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{i.reportApiInvoke(this._connectInfo.sid||null,{name:J.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:X.TRACER}).onError(new ET(h.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),g("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else t.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(QS.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this._workerConnection.on(QS.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=P(this,sg.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(g("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,i);this._workerConnection.sendMessage(n,!0,!0)}else g("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being published can be inspected")}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await at(l,n,s),u=this._sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:JA.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:u,sdkVersion:"4.20.0",sequence:this._sequence,sid:a,timestamp:qA(d),uid:c,vid:r,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete p.callbackData;const _=mA(p);if(_.byteLength<this._workerMessageLengthLimit){if(g("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?YA(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):YA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},p);delete e.jpg,t.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return _}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Ve.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=ng.CLOSED,this.emit(sg.STATE_CHANGE,og.CLOSED)}}function XA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function zA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?XA(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):XA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const QA=Date.now(),ZA=20,$A=new Map,ew=new Map;async function tw(e){const t=$A.get(e),i=Array.isArray(t)&&t[t.length-1],n=ew.get(e);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:B(i.payload)};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const o=i.sendTs-n.firstSendTs,r=o-(Date.now()-n.firstRecvTs);r>0&&(n.firstRecvTs=Date.now()-o);let a=i.mediaDelay+r;a<=0?(t.pop(),iw(i.context,s),a=0):a=Math.min(a,ZA),setTimeout((()=>t.length&&tw(e)),a)}function iw(e,t){e.safeEmit(Ee.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function nw(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return iw(i,{uid:e.uid,payload:B(e.payload)});const n="".concat(i.id,"-").concat(e.uid),s=$A.get(n)||[],o=s.findIndex((t=>e.sendTs>=t.sendTs)),r=zA(zA({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});-1===o?s.push(r):s.splice(o,0,r),$A.set(n,s);let a=!1;var c;ew.has(n)?a=!(null===(c=ew.get(n))||void 0===c||!c.isSyncing):ew.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0});a||tw(n)}const sw=Q().name;async function ow(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof Be||e instanceof Qe)){const e=new ET(h.INVALID_TRACK,"the parameter is not a video track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof Be?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),a=document.createElement("video");a.style.width="1px",a.style.height="1px",a.setAttribute("muted",""),a.muted=!0,a.setAttribute("playsinline",""),a.controls=!1,(le()||me())&&(a.style.opacity="0.01",a.style.position="fixed",a.style.left="0",a.style.top="0",document.body.appendChild(a)),a.srcObject=new MediaStream([r]),a.play();const c=document.createElement("canvas");c.width=160,c.height=120;let d=0,l=0;try{const e=Date.now();d=await function(e,i,n,s){let o,r=0,a=null;return new AS(((c,d)=>{function l(){r>s&&o&&(o(),c(r));const i=n.getContext("2d");if(!i){const e=new ET(h.UNEXPECTED_ERROR,"can not get canvas 2d context.");return t.error(e.toString()),void d(e)}i.drawImage(e,0,0,160,120);const l=i.getImageData(0,0,n.width,n.height),u=Math.floor(l.data.length/3);if(a){for(let e=0;e<u;e+=3)if(l.data[e]!==a[e])return r+=1,void(a=l.data);a=l.data}else a=l.data}setTimeout((()=>{o&&(o(),c(r))}),i),o=Ke((()=>{l()}),30)}))}(a,n,c,4),l=Date.now()-e}catch(e){throw s.onError(e),e}sw===ee.SAFARI&&(a.pause(),a.remove()),a.srcObject=null;const u=d>4,p={duration:l,changedPicNum:d,deviceLabel:o,result:u};return t.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),s.onSuccess(p),u}async function rw(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof je||e instanceof ze)){const e=new ET(h.INVALID_TRACK,"the parameter is not a audio track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof je?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let a=r,c=r;const d=Date.now();return new AS((i=>{const r=setInterval((()=>{const l=e.getVolumeLevel();a=l>a?l:a,c=l<c?l:c;const h=a-c>1e-4,u=Date.now()-d;if(h||u>n){clearInterval(r);const n=h,c={duration:u,deviceLabel:o,maxVolumeLevel:a,result:n};t.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(c))),s.onSuccess(c),i(n)}}),200)}))}function aw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function cw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aw(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}v.setLogger(t);class dw extends T{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let o;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._rtmConfig={},this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new v("client-leave"),this._publishMutex=new v("client-publish"),this._renewTokenMutex=new v("client-renewtoken"),this._subscribeMutex=new v("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=Ve.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=e=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(e.uid,this.channelName))return void t.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&t.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find((t=>t.uid===e.uid));if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(Ee.USER_JOINED,i));else{const i=new xv(e.uid,e.uint_id||e.uid);this._users.push(i),t.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(Ee.USER_JOINED,i)}},this._handleUserOffline=e=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(e.uid,this.channelName))return;const i=this._users.find((t=>t.uid===e.uid));i&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:ge(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),t.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(Ee.USER_LEAVED,i,e.reason))},this._handleAddAudioOrVideoStream=(e,o,r,a,c,d,l)=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(o,this.channelName))return;const h=this._users.find((e=>e.uid===o));if(!h)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(e)),this.store.subscribe(h.uid,e,void 0,void 0,void 0,Date.now());const u="audio"===e?h.hasAudio:h.hasVideo;h._uintid||(h._uintid=c||o),"audio"===e?h._trust_audio_stream_added_state_=!0:h._trust_video_stream_added_state_=!0,"audio"===e?(h._audio_added_=!0,void 0!==r&&(h._audioSSRC=r),void 0!==a&&(h._cname=a),d&&(h._audioOrtc=d)):(h._video_added_=!0,void 0!==r&&(h._videoSSRC=r),void 0!==a&&(h._cname=a),void 0!==l&&(h._rtxSsrcId=l),d&&(h._videoOrtc=d)),("audio"===e?h.hasAudio:h.hasVideo)&&!u&&(t.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published ").concat(e)),this.safeEmit(Ee.USER_PUBLISHED,h,e)),"video"===e?i.onGatewayStream(this._sessionId,n.ON_ADD_VIDEO_STREAM,s.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:h._videoSSRC}):i.onGatewayStream(this._sessionId,n.ON_ADD_AUDIO_STREAM,s.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:h._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(h,e,r).then((i=>{if(i&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Vy))return this._p2pChannel.unsubscribe(h,e,!0).then((()=>this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(h,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after reconnect.")),this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._handleRemoveStream=e=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(e.uid,this.channelName))return;const o=this._users.find((t=>t.uid===e.uid));if(!o)return void t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));t.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let r=()=>{};o.hasAudio&&o.hasVideo?r=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(Ee.USER_UNPUBLISHED,o,"audio"),t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(Ee.USER_UNPUBLISHED,o,"video")}:o.hasVideo?r=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(Ee.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(r=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(Ee.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Vy&&this._p2pChannel.unsubscribe(o).then((e=>{if(e)return this._gateway.unsubscribe(e,o.uid)})),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),i.onGatewayStream(this._sessionId,n.ON_REMOVE_STREAM,s.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),r()},this._handleSetStreamLocalEnable=(e,i,n)=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(i,this.channelName))return;const s=this._users.find((e=>e.uid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));t.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(i));const o="audio"===e?s.hasAudio:s.hasVideo;if("audio"===e){s._trust_audio_enabled_state_=!0;const e=s._audio_enabled_;if(s._audio_enabled_=n,s._audio_enabled_===e)return;{const e=s._audio_enabled_?"enable-local-audio":"disable-local-audio";t.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(Ee.USER_INFO_UPDATED,i,e)}}else{s._trust_video_enabled_state_=!0;const e=s._video_enabled_;if(s._video_enabled_=n,s._video_enabled_===e)return;{const e=s._video_enabled_?"enable-local-video":"disable-local-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(Ee.USER_INFO_UPDATED,i,e)}}const r="audio"===e?s.hasAudio:s.hasVideo;return o!==r?!o&&r?(t.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(e)),void this.safeEmit(Ee.USER_PUBLISHED,s,e)):("video"===e&&s._videoTrack&&s._videoTrack._destroy(),"audio"===e&&s._audioTrack,this._p2pChannel.muteRemote(s,e),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(e)),void this.safeEmit(Ee.USER_UNPUBLISHED,s,e)):void 0},this._handleMuteStream=(e,i,n)=>{if(g("BLOCK_LOCAL_CLIENT")&&$o(e,this.channelName))return;t.debug("[".concat(this._clientId,"] receive mute message"),e,i,n);const s=this._users.find((t=>t.uid===e));if(!s)return void t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const o="audio"===i?s.hasAudio:s.hasVideo;if("audio"===i){s._trust_audio_mute_state_=!0;const i=s._audio_muted_;if(s._audio_muted_=n,s._audio_muted_===i)return;{const i=s._audio_muted_?"mute-audio":"unmute-audio";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(Ee.USER_INFO_UPDATED,e,i)}}else{s._trust_video_mute_state_=!0;const i=s._video_muted_;if(s._video_muted_=n,s._video_muted_===i)return;{const i=s._video_muted_?"mute-video":"unmute-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(Ee.USER_INFO_UPDATED,e,i)}}const r="audio"===i?s.hasAudio:s.hasVideo;if(o!==r){if(!o&&r){return("audio"===i?s._audioSSRC:s._videoSSRC)?(t.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(i)),void this.safeEmit(Ee.USER_PUBLISHED,s,i)):void t.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."))}"video"===i&&s._videoTrack&&!s._video_pre_subscribed&&s._videoTrack._destroy(),"audio"===i&&s._audioTrack,this._p2pChannel.muteRemote(s,i),t.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(i)),this.safeEmit(Ee.USER_UNPUBLISHED,s,i)}},this._handleP2PLost=async e=>{t.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():t.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)},this._handleTokenWillExpire=()=>{t.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Ee.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),t.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(Ee.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Ee.NETWORK_QUALITY,e)},this._handleP2PAddAudioOrVideoStream=(e,i,n,s)=>{const o=this._users.find((e=>e.uid===i));if(!o)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(e)),this.store.subscribe(o.uid,e,void 0,void 0,void 0,Date.now());const r="audio"===e?o.hasAudio:o.hasVideo;"audio"===e?o._trust_audio_stream_added_state_=!0:o._trust_video_stream_added_state_=!0,"audio"===e?(o._audio_added_=!0,void 0!==n&&(o._audioSSRC=n),void 0!==s&&(o._audioMid=s)):(o._video_added_=!0,void 0!==n&&(o._videoSSRC=n),void 0!==s&&(o._videoMid=s)),("audio"===e?o.hasAudio:o.hasVideo)&&!r&&(t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published ").concat(e)),this.safeEmit(Ee.USER_PUBLISHED,o,e)),this._p2pChannel.hasPendingRemoteMedia(o,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(o.uid," after reconnect.")),this._subscribe(o,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._config=e,this._clientId=M(5,"client-"),this.store=new Ce(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),t.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(H," build: ").concat(Re,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Ie(e.clientRoleOptions),o=Object.assign({},e.clientRoleOptions)}catch(e){t.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new qv(this.store),this._statsCollector.onStatsException=(e,i,n)=>{t.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(i,", uid: ").concat(n)),this.safeEmit(Ee.EXCEPTION,{code:e,msg:i,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,s)=>{const o=this._users.find((t=>t.uid===e));o&&i.peerPublishStatus(this._sessionId,{subscribeElapse:s,audioPublishDuration:t,videoPublishDuration:n,peer:o._uintid})},this.store.useDataChannel=We().supportDataChannel&&g("SIGNAL_CHANNEL"),this.store.useP2P="p2p"===e.mode,this._gateway=new sR(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Z,httpRetryConfig:e.httpRetryConfig||Z,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:o}),this._configDistribute=new GR,this.store.useP2P?(this._p2pChannel=new Gv(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Vy(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,n,s){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],r=arguments.length>6&&void 0!==arguments[6]&&arguments[6];K("JOIN_GATEWAY_USE_443PORT_ONLY",o),K("JOIN_GATEWAY_USE_DUAL_DOMAIN",r);const a=this._gateway.signal.websocket;return a instanceof Ng&&(a.use443PortOnly=o,a.tryDoubleDomain=r),ve("client.join",g("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,n,s)}async join(e,n,s,o,r){const a=++this._numberOfJoinCount;this.store.joinStart(),o&&(this.store.uid=o);const c=ye(),d=Ae()?window.isSecureContext:"Browser Not Support";if(!Ae()&&!c||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";t.warning(e)}const l=ce();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),t.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const u=i.reportApiInvoke(l,{name:J.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:X.TRACER});i.setAppId(e);try{if(!s&&null!==s)throw new ET(h.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&f(s,"token",1,2047),f(e,"appid",1,2047),mT(n),o&&fT(o),r&&f(r,"optionalInfo",1,2047)}catch(e){throw u.onError(e),e}if(t.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(a)),this._leaveMutex.isLocked){t.debug("[".concat(this._clientId,"] join: waiting leave operation"));(await this._leaveMutex.lock())(),t.debug("[".concat(this._clientId,"] join: continue"))}if(this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw u.onError(e),e}this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const p=cw(cw({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:n,uid:"string"!=typeof o?o:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:s||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(p.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof o&&(p.stringUid=o,this._uintUid?(p.uid=this._uintUid,this._uintUid=void 0):p.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(p.aesmode=this._encryptionMode,p.aespassword=await we(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(p.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:n,appId:e,stringUid:p.stringUid});const _=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&_===this._sessionId&&i.joinChannelTimeout(this._sessionId,5)}),5e3);try{var E;let o;const r=p.cloudProxyServer;if(Ho(E=["proxy3","proxy4","proxy5"]).call(E,r)){const e=g("PROXY_SERVER_TYPE3");Array.isArray(e)?p.proxyServer=e[0]:p.proxyServer=e}if(i.setProxyServer(p.proxyServer),t.setProxyServer(p.proxyServer),this.store.requestAPStart(),p.stringUid&&!p.uid){let e;[e,o]=await AS.all([kR(p.stringUid,p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,this.store),LR(p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,!0,this.store)]),t.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(e)),p.uid=e,o.gatewayInfo.uid=e,o.gatewayInfo.res.uid=e}else o=await LR(p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,!0,this.store);if(!this._joinAndNotLeaveYet)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(p,this._axiosCancelSource.token),this._configDistribute.on(BT.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=s||e;const a=o.gatewayInfo,c=p.uid?p.uid:a.uid;this._joinInfo=cw(cw({},p),{},{cid:a.cid,uid:c,vid:a.vid,apResponse:a.res,uni_lbs_ip:a.uni_lbs_ip,gatewayAddrs:a.gatewayAddrs}),this.store.intUid=c;const d=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(d),this._appId=e,this._channelName=p.cname,this._uid=d,this.store.uid=d,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(le()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const l=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(this._uid);return t.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(l)),setTimeout((()=>{t.startUpload()}),5e3),this.store.joinEnd(),m=this,Ho(Zo).call(Zo,m)||Zo.push(m),d}catch(e){const i=Array.isArray(e)?e[0]:e;throw i&&i.code===h.OPERATION_ABORTED?t.warning("[".concat(this._clientId,"] join number: ").concat(a,", Joining channel failed, rollback"),i):t.error("[".concat(this._clientId,"] join number: ").concat(a,", Joining channel failed, rollback"),i),i.code!==h.OPERATION_ABORTED&&this._numberOfJoinCount===a&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(i),i}var m}_joinGateway(){if(!this._joinInfo||!this._key)throw new ET(h.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!g("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===h.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;if(e.code===h.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;throw e})).then((e=>{if(e instanceof ET){if(e.code===h.INIT_WEBSOCKET_TIMEOUT){if(t.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new ET(h.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=g("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&Ho(e).call(e,i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const n=g("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);n&&n[1]&&"443"!==n[1]&&t.setProxyServer(this._joinInfo.proxyServer),"443"!==g("STATS_COLLECTOR_PORT").toString()&&i.setProxyServer(this._joinInfo.proxyServer);return i.reportApiInvoke(this._sessionId,{name:J.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:X.TRACER}).onSuccess(),this.safeEmit(Ee.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),g("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(t.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new ET(h.INVALID_OPERATION);return i.reportApiInvoke(this._sessionId,{name:J.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:X.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){t.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(le()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Zo.indexOf(e);-1!==t&&Zo.splice(t,1)}(this);const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return t.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),t.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof He))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new ET(h.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new ET(h.INVALID_OPERATION,"audience can not publish stream");for(const e of n){if(!(e instanceof He))throw new ET(h.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&i)throw new ET(h.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}t.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof Be&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),t.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw t.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{s()}}async _publishDataChannel(e){_(e.id,"id",0,65535,!0),E(e.ordered,"ordered"),f(e.metadata,"metadata",0,512),t.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const i=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new ET(h.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new ET(h.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&g("FORCE_TURN")&&!g("TURN_ENABLE_TCP")&&!g("TURN_ENABLE_UDP"))throw new ET(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=new ct(e);await this._p2pChannel.publishDataChannel([n]);try{const t={streamId:e.id,ordered:e.ordered,maxRetransmits:g("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}return await n._waitTillOpen(),t.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(e){throw t.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{i()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new ET(h.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(e)if(Array.isArray(e))i=e;else{if(!(e instanceof He))return this._unpublishDataChannel([e]);i=[e]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);t.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Gv){const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.sendExtensionMessage(rg.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.unpublish(e,this._uid),t.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw t.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),t.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const i=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),t.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw t.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{i&&i()}}async subscribe(e,t,i){return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,i){if(m(i,"mediaType",["audio","video"]),this._p2pChannel instanceof Gv)throw new ET(h.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new ET(h.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=i===WT.AUDIO,s=i===WT.VIDEO,o=await this._subscribeMutex.lock();try{const{ssrcId:r,ortc:a,rtxSsrcId:c,cname:d,uint_id:l}=await this._gateway.presubscribe(e,i,!0);if(null==r)throw new ET(h.UNEXPECTED_RESPONSE,"no ssrc id");let u=this._users.find((t=>t.uid===e));u||(u=new xv(e,l||e),u._is_pre_created=!0,this._users.push(u)),d&&(u._cname=d),u._uintid||(u._uintid=l||e),n&&(u._audioSSRC=r,u._audio_pre_subscribed=!0,a&&(u._audioOrtc=a)),s&&(u._videoSSRC=r,u._video_pre_subscribed=!0,a&&(u._videoOrtc=a),null!=c&&(u._rtxSsrcId=c)),t.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(r)),await this._p2pChannel.subscribe(u,i,r,c,a);const p=n?u._audioTrack:u._videoTrack;if(!p)throw new ET(h.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0),s&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0),p}catch(i){throw t.error("[".concat(this._clientId,"] presub user ").concat(e," error"),i),i}finally{o()}}async _subscribeDataChannel(e,i){var n;if(_(i,"channelId",0,65535,!0),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new ET(h.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new ET(h.INVALID_REMOTE_USER,"user is not published");const s=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===i));if(!s)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(e,[s]);if(i&&Ho(i).call(i,s.id))try{var r;if(!s._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);const i={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:null!==(r=s.metadata)&&void 0!==r?r:""};await this._gateway.subscribeDataChannel(e.uid,i,!0)}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[s]),t;await this._p2pChannel.unsubscribeDataChannel(e,[s]),this._p2pChannel.setPendingRemoteDataChannel(e,s.id)}return await s._waitTillOpen(),t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),s}finally{o()}}async _p2pSubscribe(e,i,n){if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new ET(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new ET(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!n&&("audio"===i&&!e.hasAudio||"video"===i&&!e.hasVideo)){const n=new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}const s=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC,n="audio"===i?e._audioMid:e._videoMid;this.store.subscribe(e.uid,i,Date.now()),this._p2pChannel instanceof Gv&&await this._p2pChannel.subscribe(e,i,t,n)}catch(e){throw e}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new ET(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{s()}}async _subscribe(e,i,n){if(this._p2pChannel instanceof Gv)return this._p2pSubscribe(e,i);if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new ET(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new ET(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!(n||("audio"!==i||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==i||e.hasVideo&&void 0!==e._videoSSRC))){const n=new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}let s="audio"===i?e._audioSSRC:e._videoSSRC,o="audio"===i?e._audioOrtc:e._videoOrtc,r="video"===i?e._rtxSsrcId:void 0,a={stream_type:"audio"===i?WT.AUDIO:WT.VIDEO,ssrcId:s};const c=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC;void 0!==t&&t!==s&&(s=t,o="audio"===i?e._audioOrtc:e._videoOrtc,r="video"===i?e._rtxSsrcId:void 0,a={stream_type:"audio"===i?WT.AUDIO:WT.VIDEO,ssrcId:s}),KR.markSubscribeStart(this.store.clientId,s),this.store.subscribe(e.uid,i,Date.now()),await this._p2pChannel.subscribe(e,i,s,r,o);try{await this._gateway.subscribe(e.uid,a,!0)}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,i),t;await this._p2pChannel.unsubscribe(e,i,!0),this._p2pChannel.setPendingRemoteMedia(e,i)}this.store.subscribe(e.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,i)}catch(t){throw this._p2pChannel.reportSubscribeEvent(!1,null==t?void 0:t.code,e,i),t}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new ET(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{c()}}async massSubscribe(e){if(S(e,"subscribeList"),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),s=new Map,o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const r=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),a=await this._p2pChannel.globalLock();try{var c;for(let i=e.length-1;i>=0;i--){const n=e[i],{user:o,mediaType:a}=n;if(m(a,"mediaType",["audio","video"]),!o){const e=new ET(h.INVALID_PARAMS,"user property does not exist in subscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===o))){const n=new ET(h.INVALID_REMOTE_USER,"user is not in the channel");t.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),r[i].error=n,e.splice(i,1);continue}if("audio"===a&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===a&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);t.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(a,", remote user is not published")),r[i].error=n,e.splice(i,1);continue}const c=kT.Video|kT.LwoVideo,d=s.get(o);if(d){if("video"===a?d&c:d&kT.Audio){e.splice(i,1),t.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(a," twice"));continue}s.set(o,d|("video"===a?c:kT.Audio))}else s.set(o,"video"===a?c:kT.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:n,mediaType:o}=i,r=kT.Video|kT.LwoVideo;if(this._p2pChannel.hasRemoteMedia(n,o)){await this._p2pChannel.unmuteRemoteNoLock(n,o);const i=s.get(n);s.set(n,"video"===o?i^r:i^kT.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),n);const d=sT(c=Array.from(s.entries())).call(c,((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&kT.Audio&&(s.audio_ssrc=i._audioSSRC),n&kT.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===WT.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===WT.VIDEO?t._rtxSsrcId:void 0}})));const s=new Map;if(d.length>0){const e=await this._gateway.subscribeAll(d,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:n,error_code:o}=e;(i||n||o)&&s.set(t,{video_error_code:i,audio_error_code:n,error_code:o})}))}if(Array.from(s.entries()).length>0){const e=Array.from(s.entries()).map((e=>{let t,[i,n]=e;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=WT.VIDEO:n.audio_error_code&&(t=WT.AUDIO);return{user:this.remoteUsers.find((e=>e.uid===i)),mediaType:t}}));await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of r){const i=s.get(e.user.uid);if(i){const n=i.error_code||"audio"===e.mediaType&&i.audio_error_code||"video"===e.mediaType&&i.video_error_code;if(n){const i=mg(n);t.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(i.desc)),e.error=new ET(h.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(i.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(r.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),r.forEach((e=>{var t;i.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(t=e.error)||void 0===t?void 0:t.code)||null,video:e.mediaType===WT.VIDEO,audio:e.mediaType===WT.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===WT.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n)},!0)})),t.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),r}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{a(),o()}}async unsubscribe(e,i,n){if(i||this.store.useP2P){if("datachannel"===i)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(i&&m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new ET(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(i));const s=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Gv)await this._p2pChannel.unsubscribe(e,i);else{const n=await this._p2pChannel.unsubscribe(e,i);n&&await this._gateway.unsubscribe(n,e.uid),i&&"audio"!==i||(e._audio_pre_subscribed=!1),i&&"video"!==i||(e._video_pre_subscribed=!1),e._is_pre_created&&ge(this._users,e),t.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(i))}}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}finally{s()}}async _unsubscribeDataChannel(e,i){if(i&&_(i,"id",0,65535,!0),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new ET(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let n;if("number"==typeof i){const t=e._dataChannels.find((e=>e.id===i));t&&(n=[t])}else n=e._dataChannels;if(void 0===n){const n=new ET(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(i,", remote datachannel is not published")),n}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,n);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),t.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(S(e,"unsubscribeList"),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");t.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const i=new Map;for(let n=e.length-1;n>=0;n--){const{user:s,mediaType:o}=e[n];if(!s){const e=new ET(h.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}m(o,"mediaType",["video","audio",void 0]);if(!this._users.find((e=>e===s))){t.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),e.splice(n,1);continue}const r=kT.Video|kT.LwoVideo;if(i.has(s)){const a=i.get(s);let c;switch(o){case"video":c=a&r;break;case"audio":c=a&kT.Audio;break;default:c=a&(kT.Audio|r)}if(c){t.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(o," twice.")),e.splice(n,1);continue}o?"audio"===o?i.set(s,a|kT.Audio):"video"===o&&i.set(s,a|r):i.set(s,a|kT.Audio|r)}else o?"audio"===o?i.set(s,kT.Audio):"video"===o&&i.set(s,r):i.set(s,kT.Audio|r)}try{const i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),t.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===h.DISCONNECT_P2P)return void t.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw t.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){dt(e),(!e.width&&e.height||e.width&&!e.height)&&t.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),t.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&e.bitrate&&i.bitrate<e.bitrate&&(e.bitrate=i.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,qT.LocalVideoLowTrack)}async enableDualStream(){if(!We().supportDualStream)throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new ET(h.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new ET(h.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),t.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new ET(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(qT.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),t.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,i){if(be(e),i&&Ie(i),"rtc"===this.mode||"p2p"===this.mode)throw t.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new ET(h.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(i&&i.level&&"host"===e)throw new ET(h.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new ET(h.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,i),this._config.role=e,t.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,n){if(f(e,"proxyServer"),!n){if("DISCONNECTED"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ET(h.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,i.setProxyServer(this._proxyServer),t.setProxyServer(this._proxyServer),t.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(e,i){if(Array.isArray(e)||(e=[e]),!i){if("DISCONNECTED"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new ET(h.INVALID_OPERATION,"You have already set the proxy")}if(ne(e))return this._turnServer={servers:e,mode:"original-manual"},void t.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>Ne(e))),this._turnServer={servers:e,mode:"manual"},t.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState){throw new ET(h.INVALID_OPERATION,"you should set license before join channel")}if(f(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new ET(h.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,t.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new ET(h.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new ET(h.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new ET(h.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"Stop proxy server after leave channel");i.setProxyServer(),t.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new ET(h.INVALID_PARAMS,"accessPoints is required.");S(e.accessPoints.serverList,"accessPoints.serverList"),f(e.accessPoints.domain,"accessPoints.domain");const i=(e,t)=>{_(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(i(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ET(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");g("CLOSE_AFB_FOR_LOCAL_AP")&&(K("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),K("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=e.accessPoints.domain,r=e.accessPoints.serverList.map((e=>s.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(o):e)),a=r.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,K("WEBCS_DOMAIN",a),K("WEBCS_DOMAIN_BACKUP_LIST",a),K("GATEWAY_DOMAINS",[o]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(S(e.report.hostname,"report.hostname"),K("EVENT_REPORT_DOMAIN",e.report.hostname[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(K("EVENT_REPORT_DOMAIN",r[0]),K("EVENT_REPORT_BACKUP_DOMAIN",r[1]||r[0]));let c=6443;e.report&&e.report.port&&(i(e.report.port,"report.port"),c=e.report.port),K("STATS_COLLECTOR_PORT",c),e.report?K("ENABLE_EVENT_REPORT",!0):K("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(S(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=r[0];let l=6444;e.log&&e.log.port&&(i(e.log.port,"log.port"),l=e.log.port),K("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let u=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(S(e.cds.hostname,"cds.hostname"),u=e.cds.hostname):u=r;let p=443;e.cds&&e.cds.port&&(i(e.cds.port,"cds.port"),p=e.cds.port),K("CDS_AP",u.map((e=>"".concat(e,":").concat(p)))),e.cds?K("ENABLE_CONFIG_DISTRIBUTE",!0):K("ENABLE_CONFIG_DISTRIBUTE",!1),t.info("set local access point v2 success")}setLocalAccessPoints(e,i){if(S(e,"serverList"),f(i,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new ET(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(i):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,K("WEBCS_DOMAIN",e),K("WEBCS_DOMAIN_BACKUP_LIST",e),K("GATEWAY_DOMAINS",[i]),K("EVENT_REPORT_DOMAIN",e[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),K("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),t.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(m(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw t.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else t.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,i){m(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,i),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw t.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(e,i)}async setStreamFallbackOption(e,i){m(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(e,i)}setEncryptionConfig(e,i,n){Oe(e),f(i,"secret");const s=["aes-128-gcm2","aes-256-gcm2"];if(Ho(s).call(s,e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new ET(h.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new ET(h.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(i)||t.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=i,n&&(this._encryptionSalt=j(n))}async renewToken(e){if(f(e,"token",1,2047),!this._key||!this._joinInfo)throw new ET(h.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(g("USE_NEW_TOKEN")){t.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await FR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Z);t.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else t.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});t.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=i,this._joinInfo.token=i,t.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?t.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(Ee.VOLUME_INDICATOR,e)}),g("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new ET(h.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new ET(h.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new ET(h.LIVE_STREAMING_TASK_CONFLICT);const i=t?ZS.TRANSCODE:ZS.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(ZS.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new ET(h.INVALID_PARAMS,"can not find live streaming url to stop");await AS.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new ET(h.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(ZS.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,ZS.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(ZS.INJECT),i=Array.from(uT(e=t.streamingTasks).call(e)).find((e=>e.mode===ZS.INJECT));if(!this._joinInfo||!i)throw new ET(h.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(e){ey(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){ey(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new ET(h.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}if(new Blob([e.payload]).size>1024)throw new ET(h.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(qS.DATA_STREAM,{payload:j(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-QA},!t)}sendMetadata(e){if(!this._joinInfo)throw new ET(h.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new ET(h.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(qS.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:j(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(r),!this._joinInfo)throw new ET(h.INVALID_OPERATION,"can not send custom report, not joined");await i.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,i){m(i.spatialLayer,"spatialLayer",[0,1,2,3]),m(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:i=!1,rtmFlag:n}=e;if(E(i,"apRTM"),_(n,"rtmFlag",0),this._rtmConfig.apRTM=i,this._rtmConfig.rtmFlag=n,t.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=i,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(t.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Ve.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new v("client-publish"),this._subscribeMutex=new v("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,n){var s;const o=e||ce();e?t.debug("[".concat(this._clientId,"] new Session ").concat(o)):t.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(o));const r=e?"":this._sessionId||"";this._sessionId=o,this.store.sessionId=o;const a={lts:(new Date).getTime(),mode:this.mode,stringUid:(null==n?void 0:n.stringUid)||(null===(s=this._joinInfo)||void 0===s?void 0:s.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:"audience"===this.role?2:1};n?i.sessionInit(this._sessionId,cw({cname:n.channel,appid:n.appId},a)):this._joinInfo?i.sessionInit(this._sessionId,cw({cname:this._joinInfo.cname,appid:this._joinInfo.appId},a)):this._gateway.joinInfo&&i.sessionInit(this._sessionId,cw({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},a)),this._joinInfo&&(this._joinInfo.sid=o),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=o)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new ET(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&g("FORCE_TURN")&&!g("TURN_ENABLE_TCP")&&!g("TURN_ENABLE_UDP"))throw new ET(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");t.debug("[".concat(this._clientId,"] publish high stream"));try{const t=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Gv){const e=(await t.next()).value;if(e){try{await this._gateway.sendExtensionMessage(rg.PUBLISH,e,!0)}catch(e){throw t.throw(e),e}await t.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await t.next()).value;if(n){var i;let e;try{e=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw t.throw(e),e}await t.next((null===(i=e)||void 0===i?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof Be&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===h.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new ET(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new ET(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));t.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),t=(await e.next()).value;if(t){var i;let n;try{n=await this._gateway.publish(this._uid,t,!0)}catch(t){if(t.code!==h.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(i=n)||void 0===i?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===h.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId){return new ET(h.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw()}const t=()=>new Zv(this._joinInfo,this._config.websocketRetryConfig||Z,this._config.httpRetryConfig||Z),n=e=>{e.onLiveStreamError=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_ERROR,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(Ee.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_WARNING,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(Ee.LIVE_STREAMING_WARNING,e,t)},e.on(vT.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new ET(h.INVALID_OPERATION,"can not find join info to get worker manager"));xR(e,this._joinInfo,this._axiosCancelSource.token,Z).then(t).catch(i)}))};switch(e){case ZS.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case ZS.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case ZS.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(vT.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new ET(h.INVALID_OPERATION,"can not find join info to get worker manager"));xR(e,this._joinInfo,this._axiosCancelSource.token,Z).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.safeEmit(Ee.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo){return new ET(h.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new iy(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Z,this._config.httpRetryConfig||Z,i),this._channelMediaRelayClient.on("state",(e=>{e===NT.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(Ee.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(Ee.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,i){const{added:n,deleted:s}=e,o=[];Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:s,ordered:r,max_retrans_times:a,metadata:c}=e,d=this._users.find((e=>e._uintid===n));if(!d)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));t.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),Ho(o).call(o,d)||o.push(d),d._uintid||(d._uintid=n);if(!(-1!==d._dataChannels.findIndex((t=>t.id===e.stream_id)))){const e={id:s,ordered:!!r,maxRetransmits:a,metadata:c},n=new lt(e);d._dataChannels.push(n),t.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published datachannel")),i||this.safeEmit(Ee.USER_PUBLISHED,d,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(d,e.stream_id)&&(t.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(d.uid," after reconnect.")),this._subscribeDataChannel(d,e.stream_id).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))})),i&&(this.safeEmit(Ee.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach((e=>{const{uid:i,stream_id:n}=e,s=this._users.find((e=>e._uintid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const o=s._dataChannels.find((t=>t.id===e.stream_id));o&&(t.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(i)),this._p2pChannel.unsubscribeDataChannel(s,[o]).then((e=>{if(s._dataChannels=s._dataChannels.filter((e=>e!==o)),e)return this._gateway.unsubscribeDataChannel(e,s.uid)})),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished datachannel ,id:").concat(o.id)),this.safeEmit(Ee.USER_UNPUBLISHED,s,"datachannel",o._config))}))}_handleRemoveDataChannels(e){const i=this._users.find((t=>t.uid===e.uid));if(i){if(void 0!==i._dataChannels&&i._dataChannels.length>0){t.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach((e=>{this.safeEmit(Ee.USER_UNPUBLISHED,i,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),n()}}else t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(DT.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(DT.CONNECTION_STATE_CHANGE,((e,n,s)=>{var o;if(s===L.FALLBACK)return;const r=()=>{this.safeEmit(Ee.CONNECTION_STATE_CHANGE,e,n,s)};if(i.reportApiInvoke(this._sessionId||(null===(o=this._gateway.joinInfo)||void 0===o?void 0:o.sid)||null,{name:J.CONNECTION_STATE_CHANGE,options:[e,n,s],tag:X.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:s})),t.info("[".concat(this._clientId,"] connection state change: ").concat(n," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void r();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var a;this._streamFallbackTypeCacheMap.forEach(((e,i)=>{this._gateway.setStreamFallbackOption(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,i)=>{this._gateway.setRemoteVideoStreamType(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(a=this._joinInfo)||void 0===a?void 0:a.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{t.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{t.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{if("CONNECTED"!==this.connectionState)return;this._userOfflineTimeout=void 0;this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{t.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})}))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,WT.AUDIO,!1)),e._trust_video_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,WT.VIDEO,!1)),e._trust_audio_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(t.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}r()})),this._gateway.on(DT.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new ET(h.UNEXPECTED_ERROR,"can not recover, no join info"));DR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const i=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[n,s]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:n,port:s}):i.push({host:n,port:s})})),e(i)})).catch(t)})),this._gateway.on(DT.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(Ee.NETWORK_QUALITY,e)})),this._gateway.on(DT.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(Ee.STREAM_TYPE_CHANGED,e,t);i.reportApiInvoke(this._sessionId,{name:J.STREAM_TYPE_CHANGE,options:[e,t],tag:X.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(DT.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(DT.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(DT.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(DT.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:r,cname:a}=$I(e.ortc,t);this._p2pChannel.connect(n,i,s,o,r,a)})),this._gateway.on(DT.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(DT.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(DT.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(DT.DATACHANNEL_PRECONNECT,(async(e,i,n,s)=>{var o,r,a,c,d,l;await this._p2pChannel.startP2PConnection({turnServer:null===(o=this._joinInfo)||void 0===o?void 0:o.turnServer},!0);const h=function(e,i){let n;return i&&i.ip&&"number"==typeof i.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],n}(e,i);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cid,"_").concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cert),icePwd:"".concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cid,"_").concat(null===(d=this._joinInfo)||void 0===d?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(l=g("FINGERPRINT"))&&void 0!==l?l:e.fingerprint}]},h,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(s)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(JS.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(JS.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(JS.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(JS.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(JS.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(JS.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(JS.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(JS.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(JS.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,WT.AUDIO,!0))),this._gateway.signal.on(JS.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,WT.AUDIO,!1))),this._gateway.signal.on(JS.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,WT.VIDEO,!0))),this._gateway.signal.on(JS.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,WT.VIDEO,!1))),this._gateway.signal.on(JS.RECEIVE_METADATA,(e=>{const t=B(e.metadata);this.safeEmit(Ee.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(JS.ON_DATA_STREAM,(async e=>{if(!e)return;let t=0;if(e.ordered||e.syncWithAudio){const i=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),s=null==i?void 0:i.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));t=null==s?void 0:s.jitterBufferMs}null==t&&(t=0),nw(e,t,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(JS.ON_CRYPT_ERROR,(()=>{Pe((()=>{t.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Ee.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(JS.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(JS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{t.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,L.TOKEN_EXPIRE),this.safeEmit(Ee.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(JS.ON_STREAM_FALLBACK_UPDATE,(e=>{t.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(Ee.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(JS.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),t.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(JS.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(JS.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(KS.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case qS.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,s;const o=e.some((e=>{let{stream_type:t}=e;return t===PT.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t!==PT.Audio})),a=e.some((e=>{let{stream_type:t}=e;return t===PT.Screen||t===PT.ScreenLow}));"offer"===t.state&&i.publish(this._joinInfo.sid,{eventElapse:KR.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:h.TIMEOUT,audio:o,video:r,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?null===(n=e.find((e=>{let{stream_type:t}=e;return t===PT.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:r?null===(s=e.find((e=>{let{stream_type:t}=e;return t!==PT.Audio})))||void 0===s||null===(s=s.ssrcs[0])||void 0===s?void 0:s.ssrcId.toString():void 0})}break}case qS.SUBSCRIBE:t&&i.subscribe(this._joinInfo.sid,{succ:!1,ec:h.TIMEOUT,audio:t.stream_type===WT.AUDIO,video:t.stream_type===WT.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:KR.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(JS.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(JS.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;g("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!$o(e.string_id||e.stream_id,this.channelName))));const i=[],n=[];for(const s of e.users){let e=this._users.find((e=>e._uintid===s.stream_id));e?e._trust_in_room_=!0:(e=new xv(s.string_id||s.stream_id,s.stream_id),this._users.push(e),0===this.getListeners(Ee.PUBLISHED_USER_LIST).length&&(t.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(Ee.USER_JOINED,e)));const o=kT.Audio&s.stream_type,r=(kT.Video|kT.LwoVideo)&s.stream_type,a=0!=(65280&s.stream_type),c=o&&e.hasAudio,d=r&&e.hasVideo;r&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=s.video_ssrc,e._rtxSsrcId=s.video_rtx),o&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=s.audio_ssrc),o&&!c&&0===this.getListeners(Ee.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(Ee.USER_PUBLISHED,e,"audio")),r&&!d&&0===this.getListeners(Ee.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(Ee.USER_PUBLISHED,e,"video")),(o&&!c||r&&!d||a)&&i.push(e),r&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(t.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{t.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(Ee.PUBLISHED_USER_LIST).length>0?g("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(t.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map((e=>e.uid)).join(", "))),this.safeEmit(Ee.PUBLISHED_USER_LIST,i)):t.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(JS.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof Vy&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>{var t;return Ho(t=Object.keys(de)).call(t,e)})))}))}_handleP2PEvents(){this._gateway.signal.on(JS.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(rg.PUBLISH,((e,t,i)=>{const{uid:n}=e;e.forEach((e=>{const{kind:s,ssrcs:o,mid:r,isMuted:a}=e;this._handleP2PAddAudioOrVideoStream(s,n,o[0].ssrcId,r);const c=this._users.find((e=>e.uid===n));return c&&this._p2pChannel instanceof Gv?this._p2pChannel.mockSubscribe(c,s,o[0].ssrcId,r).then((()=>{t()})).catch(i):t(),this._handleMuteStream(n,s,!!a)}))})),this._gateway.signal.on(rg.CALL,(async(e,t,i)=>{if(this._p2pChannel instanceof Gv)try{var n;t(await this._p2pChannel.startP2P({turnServer:null===(n=this._joinInfo)||void 0===n?void 0:n.turnServer},e))}catch(e){i(e)}})),this._gateway.signal.on(KS.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof Gv&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(rg.UNPUBLISH,(async(e,i,n)=>{if(this._p2pChannel instanceof Gv){const{unpubMsg:s,uid:o}=e,r=this._users.find((e=>e.uid===o));if(!r)return t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o)),void i();try{s.forEach((async e=>{let{stream_type:t}=e;const i=t===PT.Audio?WT.AUDIO:WT.VIDEO;await this._p2pChannel.unsubscribe(r,i),this._handleMuteStream(o,i,!0)})),i()}catch(e){n(e)}}})),this._gateway.signal.on(rg.CONTROL,(async(e,t)=>{const{action:i}=e;switch(i){case cg.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,WT.VIDEO,!0);break;case cg.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,WT.AUDIO,!0);break;case cg.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,WT.VIDEO,!1);break;case cg.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,WT.AUDIO,!1)}})),this._gateway.signal.on(rg.RESTART_ICE,(async(e,t,i)=>{if(this._p2pChannel instanceof Gv)try{const{direction:i,iceParameter:n}=e;if(i!==zS.SEND_ONLY||n){t(await this._p2pChannel.restartICE(i,n))}else this._p2pChannel.handleDisconnect(i),t()}catch(e){i(e)}})),this._gateway.signal.on(rg.CANDIDATE,(e=>{if(this._p2pChannel instanceof Gv){const{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}})),this._p2pChannel.on(JT.RequestP2PRestartICE,(async(e,t,i)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(rg.RESTART_ICE,e,i===zS.SEND_ONLY))}catch(e){i(e)}})),this._p2pChannel.on(JT.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(rg.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(JT.RequestP2PMuteLocal,(async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(rg.CONTROL,e,!0),t()}catch(e){i(e)}})),this._p2pChannel.on(JT.RequestP2PUnmuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(JT.RequestP2PMuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(JT.StateChange,((e,t)=>{t===YT.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(JT.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(JT.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(JT.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(JT.RequestRePublishDataChannel,((e,t,i)=>{AS.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(JT.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===WT.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(JT.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(JT.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(JT.MediaReconnectStart,(e=>{this.safeEmit(Ee.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(JT.MediaReconnectEnd,(e=>{this.safeEmit(Ee.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(JT.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(JT.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof Gv)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(JT.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(JT.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:r,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=$I(s,o);await this._p2pChannel.connect(a,r,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(JT.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(JT.P2PLost,(()=>{this.safeEmit(Ee.P2P_LOST,this.store.uid)})),this._p2pChannel.on(JT.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(JT.ConnectionTypeChange,(e=>{this.safeEmit(Ee.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(JT.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(JT.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{var t;if(!Ho(t=["supervise","moderation"]).call(t,e))throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new EA(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Z)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(E(e,"enabled"),e){if(!t)throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(_(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new ET(h.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new JA(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Z)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new ET(h.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}setP2PTransport(e){if(De(e),"p2p"!==this.mode)throw new ET(h.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,t.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(sg.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(Ee.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===ng.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new ET(h.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(sg.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(ZT.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(Ee.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===zT.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(Ee.CONTENT_INSPECT_ERROR,new ET(h.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(ZT.INSPECT_RESULT,((e,i)=>{var n;if((null==i?void 0:i.code)===h.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return t.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(Ee.CONTENT_INSPECT_RESULT,e,i)})),e.on(ZT.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return t.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){E(e,"enabled"),K("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}function lw(){var e;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const s=i.reportApiInvoke(null,{name:J.CREATE_CLIENT,options:[n],tag:X.TRACER});try{Te(n)}catch(e){throw s.onError(e),e}return(fe(16,0,!0)||Se(16,0,!0))&&("vp9"===n.codec&&(n.codec="vp8",t.debug("browser not support vp9, force use vp8")),K("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===n.audioCodec&&(n.audioCodec="opus"),s.onSuccess(),new dw(cw(cw({forceWaitGatewayResponse:!0},n),{},{role:Ho(e=["rtc","p2p"]).call(e,n.mode)?"host":n.role||"audience"}))}async function hw(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const i=(await t.createOffer()).sdp;if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new ET(h.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e}function uw(){const e=i.reportApiInvoke(null,{name:J.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:X.TRACER});let n=!1;try{const e=window.RTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;n=!!(e&&t&&i)}catch(e){return t.error("check system requirement failed: ",e),!1}let s=!1;const o=Q();o.name===ee.CHROME&&Number(o.version)>=58&&(!Le()||ke())&&(s=!0),o.name===ee.FIREFOX&&Number(o.version)>=56&&(s=!0),o.name===ee.OPERA&&Number(o.version)>=45&&(s=!0),o.name===ee.SAFARI&&Number(o.version)>=11&&(s=!0),(Me()||Ue())&&(s=!0),t.debug("checkSystemRequirements, api:",n,"browser",s);const r=n&&s;return e.onSuccess(r),r}pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"leave",null),pT([o({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof He))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),_T("design:type",Function),_T("design:paramtypes",[Object,Boolean]),_T("design:returntype",AS)],dw.prototype,"publish",null),pT([o({argsMap:(e,t)=>(t||(t=[]),t instanceof ct?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"unpublish",null),pT([o({argsMap:(e,t,i,n)=>[t.uid,i,n]}),_T("design:type",Function),_T("design:paramtypes",[xv,String,Number]),_T("design:returntype",AS)],dw.prototype,"subscribe",null),pT([o({argsMap:(e,t,i)=>[t,i]}),_T("design:type",Function),_T("design:paramtypes",[Object,String]),_T("design:returntype",AS)],dw.prototype,"presubscribe",null),pT([o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dw.prototype,"massSubscribe",null),pT([o({argsMap:(e,t,i,n)=>[t.uid,i,n]}),_T("design:type",Function),_T("design:paramtypes",[xv,String,Number]),_T("design:returntype",AS)],dw.prototype,"unsubscribe",null),pT([o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),_T("design:type",Function),_T("design:paramtypes",[Array]),_T("design:returntype",AS)],dw.prototype,"massUnsubscribe",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"setLowStreamParameter",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"enableDualStream",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"disableDualStream",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String,Object]),_T("design:returntype",AS)],dw.prototype,"setClientRole",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String,Boolean]),_T("design:returntype",void 0)],dw.prototype,"setProxyServer",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object,Boolean]),_T("design:returntype",void 0)],dw.prototype,"setTurnServer",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",void 0)],dw.prototype,"setLicense",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Number]),_T("design:returntype",void 0)],dw.prototype,"startProxyServer",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],dw.prototype,"stopProxyServer",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",void 0)],dw.prototype,"setLocalAccessPointsV2",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Array,String]),_T("design:returntype",void 0)],dw.prototype,"setLocalAccessPoints",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Number]),_T("design:returntype",AS)],dw.prototype,"setRemoteDefaultVideoStreamType",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object,Number]),_T("design:returntype",AS)],dw.prototype,"setRemoteVideoStreamType",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object,Number]),_T("design:returntype",AS)],dw.prototype,"setStreamFallbackOption",null),pT([o({argsMap:(e,t)=>[t]}),_T("design:type",Function),_T("design:paramtypes",[String,String,Uint8Array]),_T("design:returntype",void 0)],dw.prototype,"setEncryptionConfig",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],dw.prototype,"renewToken",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",void 0)],dw.prototype,"enableAudioVolumeIndicator",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String,Boolean]),_T("design:returntype",AS)],dw.prototype,"startLiveStreaming",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"setLiveTranscoding",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",AS)],dw.prototype,"stopLiveStreaming",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String,Object]),_T("design:returntype",AS)],dw.prototype,"addInjectStreamUrl",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"removeInjectStreamUrl",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[$v]),_T("design:returntype",AS)],dw.prototype,"startChannelMediaRelay",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[$v]),_T("design:returntype",AS)],dw.prototype,"updateChannelMediaRelay",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"stopChannelMediaRelay",null),pT([o({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"sendCustomReportMessage",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object,Object]),_T("design:returntype",AS)],dw.prototype,"pickSVCLayer",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"setRTMConfig",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Object]),_T("design:returntype",AS)],dw.prototype,"enableContentInspect",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",AS)],dw.prototype,"disableContentInspect",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Boolean,Object]),_T("design:returntype",AS)],dw.prototype,"setImageModeration",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[String]),_T("design:returntype",void 0)],dw.prototype,"setP2PTransport",null),pT([o({reportResult:!0}),_T("design:type",Function),_T("design:paramtypes",[]),_T("design:returntype",Array)],dw.prototype,"getJoinChannelServiceRecords",null),pT([o(),_T("design:type",Function),_T("design:paramtypes",[Boolean]),_T("design:returntype",AS)],dw.prototype,"setPublishAudioFilterEnabled",null);class pw{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,pw.count+=1,this.id=pw.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new AS((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new ET(h.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination();this.context.createMediaElementSource(e).connect(t)}catch(e){throw new ET(h.LOCAL_AEC_ERROR,e.toString()).print()}if(!t){throw new ET(h.LOCAL_AEC_ERROR,"no dest node when local aec").print()}const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){t.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}pw.count=0;const _w=window.AudioContext||window.webkitAudioContext;class Ew{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return t.debug("the system does not need to process local aec"),-1;this.context||(this.context=new _w);let i=this.units.find((t=>t&&t.getElement()===e));return i||(i=new pw(e,this.context),this.units.push(i)),i.startEchoCancellation(),t.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return Q().name!==ee.SAFARI}}pT([o({report:i}),_T("design:type",Function),_T("design:paramtypes",[HTMLAudioElement]),_T("design:returntype",Number)],Ew.prototype,"processExternalMediaAEC",null);const mw=new Ew;function fw(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Sw(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?fw(Object(i),!0).forEach((function(t){Ip(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fw(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const Tw=window||document;function gw(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Tw)return;const i=Lw._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(Lw.onSecurityPolicyViolation||Lw.getListeners(tg.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;g("CSP_DETECTED_HOSTNAME_LIST").some((e=>Ho(t).call(t,e)))&&(Lw.onSecurityPolicyViolation&&"function"==typeof Lw.onSecurityPolicyViolation&&Lw.onSecurityPolicyViolation(e),Lw.getListeners(tg.SECURITY_POLICY_VIOLATION).length>0&&Lw.safeEmit(tg.SECURITY_POLICY_VIOLATION,e))};i&&Tw.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||Lw.getListeners(tg.SECURITY_POLICY_VIOLATION).length>0)&&Tw.addEventListener("securitypolicyviolation",n),Lw._cspEventHandlerPointer=n}function Cw(e){return ut.enumerateDevices(!0,!0,e)}function Rw(e){return ut.getRecordingDevices(e)}function Iw(e){return ut.getCamerasDevices(e)}function vw(e){return ut.getSpeakers(e)}function yw(){return new $v}function Aw(e){if(t.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw t.debug("Invalid appType"),new ET(h.INVALID_PARAMS,"invalid app type",e);K("APP_TYPE",Math.floor(e))}function ww(e){t.setLogLevel(e)}function bw(){g("USE_NEW_LOG")?K("UPLOAD_LOG",!0):t.enableLogUpload()}function Nw(){g("USE_NEW_LOG")?K("UPLOAD_LOG",!1):t.disableLogUpload()}function Ow(e){mw.processExternalMediaAEC(e)}function Pw(e){e.forEach((e=>{const n=e;n.__registered__=!0,n.logger.hookLog=t.extLog,n.reporter.hookApiInvoke=i.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=g(e)}))}))}function Dw(){Je.autoResumeAfterInterruption(!0)}K("PROCESS_ID",xe()),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void t.error("Error loading sdk config",e.message)}if(e)try{const i=JSON.parse(window.atob(e)),n=Date.now();t.debug("Loading global parameters from cache",i),Object.keys(i).forEach((e=>{if(Object.prototype.hasOwnProperty.call(c,e)){const{value:t,expires:s}=i[e];if(s&&s<=n)return;d[e]=t,c[e]=t}}))}catch(i){t.error("Error loading mutableParamsCache: ".concat(e),i.message)}}(),Array.isArray(d.AREAS)&&d.AREAS.length>0&&mR(d.AREAS,!0);const Lw=function(e){const t=new T,i=e,n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===tg.SECURITY_POLICY_VIOLATION&&gw(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Sw(Sw({},i),n)}({});function kw(e){ht.onAudioAutoplayFailed=e}function Mw(e){ht.onAutoplayFailed=e}function Uw(e){Lw.onSecurityPolicyViolation=e}function xw(e){Lw.onCameraChanged=e}function Vw(e){Lw.onMicrophoneChanged=e}function Fw(e){Lw.onAudioContextStateChanged=e}Object.defineProperties(Lw,{onAudioAutoplayFailed:{get:()=>ht.onAudioAutoplayFailed,set:kw},onAutoplayFailed:{get:()=>ht.onAutoplayFailed,set:Mw},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Lw._onSecurityPolicyViolation,set(e){Lw._onSecurityPolicyViolation=e,gw(e)}},__CLIENT_LIST__:{get:()=>g("SHOW_GLOBAL_CLIENT_LIST")?Zo:[]}}),ut.on(pt.CAMERA_DEVICE_CHANGED,(e=>{t.info("camera device changed",JSON.stringify(e)),Lw.onCameraChanged&&Lw.onCameraChanged(e),Lw.safeEmit(tg.CAMERA_CHANGED,e)})),ut.on(pt.RECORDING_DEVICE_CHANGED,(e=>{t.info("microphone device changed",JSON.stringify(e)),Lw.onMicrophoneChanged&&Lw.onMicrophoneChanged(e),Lw.safeEmit(tg.MICROPHONE_CHANGED,e)})),ut.on(pt.PLAYOUT_DEVICE_CHANGED,(e=>{t.debug("playout device changed",JSON.stringify(e)),Lw.onPlaybackDeviceChanged&&Lw.onPlaybackDeviceChanged(e),Lw.safeEmit(tg.PLAYBACK_DEVICE_CHANGED,e)})),Je.onAutoplayFailed=()=>{t.info("detect audio element autoplay failed"),ht.onAudioAutoplayFailed&&ht.onAudioAutoplayFailed()},_t.on("autoplay-failed",(()=>{t.info("detect webaudio autoplay failed"),ht.onAudioAutoplayFailed&&ht.onAudioAutoplayFailed(),Lw.safeEmit(tg.AUTOPLAY_FAILED)})),_t.on(Et.STATE_CHANGE,((e,i)=>{t.info("audio context state changed: ".concat(i," => ").concat(e)),Lw.onAudioContextStateChanged&&Lw.onAudioContextStateChanged(e,i),Lw.safeEmit(tg.AUDIO_CONTEXT_STATE_CHANGED,e,i)})),window&&(window.__ARTC__={ESM_BUNDLER:true,ESM:false,UMD:false,DEV:false,AgoraRTC:Lw,__TRACK_LIST__:mt}),A.on(w.NETWORK_STATE_CHANGE,((e,i)=>{t.info("[network-indicator] network state changed, ".concat(i," => ").concat(e))}));const jw=(e,i,n)=>{t.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(i))),K(e,i,n)};export{UT as AREAS,Lw as AgoraRTC,OT as ChannelMediaRelayError,bT as ChannelMediaRelayEvent,NT as ChannelMediaRelayState,Jo as DEV,qo as ESM,Ko as ESM_BUNDLER,Yo as UMD,Zo as __CLIENT_LIST__,rw as checkAudioTrackIsActive,uw as checkSystemRequirements,ow as checkVideoTrackIsActive,yw as createChannelMediaRelayConfiguration,lw as createClient,Nw as disableLogUpload,bw as enableLogUpload,Iw as getCameras,Cw as getDevices,Rw as getMicrophones,vw as getPlaybackDevices,hw as getSupportedCodec,kw as onAudioAutoplayFailed,Fw as onAudioContextStateChanged,Mw as onAutoplayFailed,xw as onCameraChanged,Vw as onMicrophoneChanged,Uw as onSecurityPolicyViolation,Ow as processExternalMediaAEC,Pw as registerExtensions,Dw as resumeAudioContext,Aw as setAppType,mR as setArea,ww as setLogLevel,jw as setParameter};
